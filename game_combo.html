<!DOCTYPE html>

<html lang="it">
<head>
  <!-- <link rel="manifest" href="manifest.webmanifest"> -->
<meta name="theme-color" content="#000000">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>

<script>
(function(){
  const p = new URLSearchParams(location.search);
  const auto =
    p.get("preset") ||
    p.get("classe") || p.get("cls") ||
    p.get("disciplina") || p.get("subject") ||
    p.get("livello") || p.get("level") ||
    p.get("topics") || p.get("argomento");

  if(auto) document.documentElement.classList.add("autostart");
})();
</script>


<title>Quiz Multimateria - Primaria</title>
<style>
  :root{
    --bg:#f4f6f8;
    --card:#ffffff;
    --muted:#556;
    --line:#cfd6dc;
    --shadow:0 6px 18px rgba(0,0,0,.08);
    --r:16px;
  }

  /* Anti-flash: se arrivo con preset/parametri, non far vedere HOME */
html.autostart #home{ display:none !important; }
html.autostart #game{ display:block !important; }


  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);text-align:center}
  h1{margin:18px 0 6px;font-size:1.7em}
  h2{margin:8px 0 6px;font-size:1.25em}
  p{margin:0 0 14px;color:var(--muted)}
  .screen{display:none;padding:18px}
  .active{display:block}
  .card{background:var(--card);border-radius:var(--r);box-shadow:var(--shadow);padding:14px;max-width:1100px;margin:0 auto}
  .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:10px auto;max-width:760px}
  .col{flex:1 1 220px;min-width:220px}
  label{display:block;text-align:left;margin:8px 0 6px;font-weight:700}
  select,input[type="text"],input[type="url"],textarea{
    width:100%;box-sizing:border-box;padding:12px;border-radius:12px;border:2px solid var(--line);
    font-size:1em;background:#fff;
  }
  textarea{min-height:92px;resize:vertical}
  .btn{
    display:block;width:92%;max-width:560px;margin:12px auto;padding:16px 14px;
    font-size:1.1em;border-radius:14px;border:none;cursor:pointer;line-height:1.2
  }
  .primary{background:#111;color:#fff}
  .soft{background:#e9eef3;color:#223}
  .danger{background:#F44336;color:#fff}
  .option{background:#fff;border:2px solid var(--line);color:#111}
  .option.correct{background:#c8e6c9;border-color:#4CAF50}
  .option.wrong{background:#ffcdd2;border-color:#F44336}
  img{max-width:100%;border-radius:14px;margin-bottom:10px;display:block}

  video{max-width:100%;border-radius:14px;margin-bottom:10px;display:block}
  .dropzone{
    border:2px dashed var(--line);
    border-radius:14px;
    padding:14px;
    background:#fff;
    text-align:center;
    color:var(--muted);
    transition:.15s ease;
    user-select:none;
  }
  .dropzone.dragover{
    border-color:#111;
    background:#f0f4f8;
    color:#111;
  }
  .preview{
    margin-top:10px;
  }
  .preview img,.preview video{
    width:100%;
  }
  .tiny{font-size:.85em;color:var(--muted);margin-top:6px}
  .topbar{
    display:flex;justify-content:space-between;align-items:center;gap:10px;
    max-width:760px;margin:0 auto 12px;flex-wrap:wrap
  }
  .pill{display:inline-block;background:#e9eef3;border-radius:999px;padding:8px 12px;font-size:.95em;color:#223}
  .smallbtn{border:none;background:#e9eef3;border-radius:12px;padding:10px 12px;font-size:.95em;cursor:pointer}
  #feedback{font-size:1.05em;margin-top:10px;font-weight:800;min-height:1.4em; margin-top: 8px;}
  #nextBtn{display:none}
  .hint{font-size:.95em;color:var(--muted);margin-top:8px}
  .split{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
  .archiveActions{display:flex;flex-direction:column;gap:12px;align-items:stretch}
  .archiveActions .btn{width:100%;max-width:100%;margin:0}
  .archiveRowButtons{display:flex;gap:12px;flex-wrap:wrap}
  .archiveRowButtons .btn{flex:1 1 220px}

  .split .btn{max-width:360px}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #eef2f5;padding:10px;text-align:left;font-size:.95em}
  th{color:#223}
  .tag{display:inline-block;background:#eef2f5;border-radius:999px;padding:4px 10px;font-size:.85em;color:#223}

  /* Evidenziazione risposta corretta (Area Docente) */
  .teacherCorrect{
    background: #e6f6e9;
    border-left: 5px solid #2ecc71;
    padding-left: 6px;
  }
  .teacherCorrect label{
    font-weight: 700;
    color: #1e8c4a;
  }



  
  /* --- Area Docente: immagine per risposta --- */
  .optRowFlex{display:flex;gap:10px;align-items:center}
  .optImgBtn{
    width:40px;height:40px;min-width:40px;
    border-radius:10px;border:2px solid var(--line);
    background:#fff;cursor:pointer;
    display:flex;align-items:center;justify-content:center;
    padding:0;font-size:18px;line-height:1;
  }
  .optImgBtn.has{border-color:#111;box-shadow:0 0 0 3px rgba(0,0,0,.08)}
  .optThumbWrap{margin-top:8px;position:relative;display:inline-block}
  .optRemoveImg{
    position:absolute;top:-8px;right:-8px;
    width:22px;height:22px;border-radius:50%;
    border:none;background:#ef4444;color:#fff;
    font-weight:900;font-size:14px;line-height:22px;
    text-align:center;cursor:pointer;
    box-shadow:0 2px 6px rgba(0,0,0,35);
  }
  .optRemoveImg:hover{background:#dc2626;transform:scale(1.06)}
  .optThumb{width:86px;height:86px;object-fit:cover;border-radius:12px;border:2px solid var(--line)}
  /* CARD RISPOSTA QUIZ */
  .optBtnImg{
  width:100%;
  max-height:220px;      /* pi√π grande */
  object-fit:cover;      /* riempie meglio */
  border-radius:20px;    /* pi√π arrotondate */
  margin:0 0 6px 0;
  display:block;
}

  .optBtnText{font-weight:700}


/* --- Area Docente: drag & drop opzioni --- */
  .teacherOptRow{ cursor: grab; }
  .teacherOptRow:active{ cursor: grabbing; }
  .teacherOptRow.dragging{ opacity: .55; }
  .teacherOptRow.dragover{ outline: 2px dashed #111; outline-offset: 4px; border-radius: 12px; }
  .filterLabel{font-size:13px;color:#9aa0a6;font-weight:400;margin-bottom:4px;}
.filterHint{
  color:#000;
  font-weight:600;
  opacity:1;
}


/* Placeholder inside <select> (testo sbiadito finch√© non scegli) */
select.is-placeholder { color:#9aa0a6 !important; }
select option { color:#000; }


/* --- Configura domande per argomento --- */
.topicConfig{
  margin-top:10px;
  text-align:left;
  border-top:1px dashed var(--line);
  padding-top:10px;
}
.topicRow{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
.topicRow .col{flex:1 1 220px;min-width:220px}
.topicList{
  margin-top:8px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  padding:8px 10px;
  max-height:200px;
  overflow:auto;
}
.topicItem{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:6px 6px;
  border-radius:10px;
}
.topicItem:hover{background:#f6f8fb}
.topicLeft{display:flex;align-items:center;gap:10px}
.topicCount{font-size:12px;color:#556;opacity:.85}
.smallnote{font-size:12px;color:#556;margin-top:6px}


/* --- Argomenti: pannello a scomparsa + ricerca --- */
.topicHeaderBtn{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  cursor:pointer;
}
.topicHeaderLeft{display:flex;flex-direction:column;gap:2px}
.topicHeaderTitle{font-weight:700}
.topicHeaderSub{font-size:12px;color:#556;opacity:.85}
.topicChevron{font-size:18px;line-height:1;opacity:.8}
.topicPanel{
  margin-top:8px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  overflow:hidden;
  max-height:0;
  transition:max-height .25s ease;
}
.topicPanel.open{max-height:320px;}
.topicPanelInner{padding:10px}
.topicSearch{
  width:100%;
  padding:10px 10px;
  border:1px solid var(--line);
  border-radius:10px;
  outline:none;
}
.topicActions{
  display:flex;
  gap:8px;
  margin-top:8px;
  flex-wrap:wrap;
}
.topicActions .smallbtn{
  padding:8px 10px;
  font-size:12px;
}
.topicList{
  margin-top:10px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  padding:6px 6px;
  max-height:200px;
  overflow:auto;
}


/* --- Modale incolla JSON (utile su LIM) --- */
.pasteOverlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.6);
  z-index:99999;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:14px;
}
.pasteCard{
  width:min(900px, 96vw);
  background:#fff;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
  padding:14px;
}
.pasteCard h3{margin:0 0 8px}
.pasteArea{
  width:100%;
  min-height:240px;
  resize:vertical;
  border:1px solid var(--line);
  border-radius:12px;
  padding:10px;
  font-family:Consolas, monospace;
  font-size:12px;
  box-sizing:border-box;
}
.pasteActions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin-top:10px}


  /* Nascondi pulsanti di import (offline LIM: non servono) */
  button[onclick*="importQuestionsJSON"],
  button[onclick*="openPasteJSON"],
  button[onclick*="importFullBackup"],
  button[onclick*="importJSON"]{display:none!important;}

/* === Pulsante MOSTRA PUNTEGGIO centrale === */
#showScoreBtn{
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  width: 180px;
  height: 180px;
  border-radius: 50%;
  font-size: 1.2em;
  font-weight: 900;
  background: radial-gradient(circle at top left, #ffd84d, #f59e0b);
  color: #3a2500;
  border: none;
  box-shadow: 0 20px 40px rgba(0,0,0,.35);
  display: none;
  align-items: center;
  justify-content: center;
  text-align: center;
  z-index: 9999;
  cursor: pointer;
}
#showScoreBtn:hover{
  transform: translate(-50%, -50%) scale(1.05);
}


/* === Modal "Livello completato" === */
#levelDoneBackdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9998; /* sotto al bottone punteggio (9999) */
}
#levelDoneCard{
  width: min(520px, 92vw);
  background: linear-gradient(135deg, rgba(255,255,255,.98), rgba(255,247,220,.98));
  border-radius: 22px;
  padding: 18px 18px 16px;
  box-shadow: 0 26px 70px rgba(0,0,0,.28);
  border: 1px solid rgba(0,0,0,.06);
  text-align: center;
  transform: scale(.92);
  opacity: 0;
  transition: transform .18s ease, opacity .18s ease;
}
#levelDoneBackdrop.show #levelDoneCard{
  transform: scale(1);
  opacity: 1;
}
#levelDoneTitle{
  font-size: 1.65em;
  font-weight: 1000;
  margin: 4px 0 8px;
}
#levelDoneSubtitle{
  font-size: 1.05em;
  color: #3a3a3a;
  margin: 0 0 12px;
}
#levelDonePills{
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
  margin: 8px 0 10px;
}
.levelPill{
  padding: 8px 12px;
  border-radius: 999px;
  font-weight: 900;
  background: rgba(255,255,255,.8);
  border: 1px solid rgba(0,0,0,.08);
}
#levelDoneActions{
  display:flex;
  gap:10px;
  justify-content:center;
  margin-top: 10px;
}
.levelBtn{
  border: none;
  border-radius: 14px;
  padding: 10px 14px;
  font-weight: 900;
  cursor: pointer;
  box-shadow: 0 12px 26px rgba(0,0,0,.18);
}
#btnLevelOk{
  background: radial-gradient(circle at top left, #60a5fa, #2563eb);
  color: white;
}
#btnLevelScore{
  background: radial-gradient(circle at top left, #ffd84d, #f59e0b);
  color: #3a2500;
}


/* === Menu attivo === */
.topnav .navbtn.active{
  background:#22c55e;
  color:#08350f;
  box-shadow:0 0 0 2px rgba(34,197,94,.35);
}


/* üëÅÔ∏è Toggle visibilit√† password (modale accesso) */
.qmPwWrap{ position:relative; }
.qmPwToggle{
  position:absolute;
  right:14px;
  top:50%;
  transform:translateY(-50%);
  cursor:pointer;
  user-select:none;
  font-size:18px;
  opacity:.7;
  line-height:1;
}
.qmPwToggle:hover{ opacity:1; }


/* ‚ùå Clear search button */
.searchWrap{ position:relative; }
.clearSearchBtn{
  position:absolute;
  right:10px;
  top:50%;
  transform:translateY(-50%);
  width:22px;
  height:22px;
  border-radius:4px;
  border:1px solid #cfd6dc;
  background:#fff;
  font-size:14px;
  line-height:18px;
  text-align:center;
  cursor:pointer;
  opacity:.7;
}
.clearSearchBtn:hover{ opacity:1; background:#f4f6f8; }


/* Evidenzia risposta corretta in SCEGLI DOMANDE */
.opts .opt.correct{
  font-weight:900;
  color:#166534;
  background:rgba(34,197,94,.15);
  border-radius:6px;
  padding:2px 6px;
}


/* ===== Argomenti selezionati: chips visibili ===== */
.topicChipsRow{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
  margin:10px 0 6px;
}
.topicChipsLabel{
  font-size:12px;
  color:#556;
  font-weight:800;
  margin-right:6px;
}
.topicChip{
  display:inline-flex;
  gap:8px;
  align-items:center;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(0,0,0,.10);
  background:#f4f7fb;
  font-weight:800;
  font-size:13px;
}
.topicChip .x{
  display:inline-flex;
  width:18px;
  height:18px;
  align-items:center;
  justify-content:center;
  border-radius:6px;
  border:1px solid rgba(0,0,0,.10);
  background:#fff;
  cursor:pointer;
  font-weight:900;
  line-height:1;
  opacity:.85;
}
.topicChip .x:hover{ opacity:1; background:#f2f2f2; }


.pickCountsBar{
  display:flex;
  align-items:center;
  gap:6px;
  margin:6px 0;
}


/* Badge domande create in sessione (non presenti in questions.js) */
.newTag{background:#ffe08a; color:#5a3b00; border:1px solid rgba(90,59,0,.25);}
</style>
<style>
/* --- Area Docente: sezioni a card --- */
#teacher .doc-card{
  border-radius: 16px;
  padding: 14px 14px 10px;
  margin: 12px 0;
  box-shadow: 0 6px 14px rgba(0,0,0,.06);
  border: 1px solid rgba(0,0,0,.06);
}
#teacher .doc-card h3{
  margin: 0 0 10px 0;
  font-size: 1.02em;
}
#teacher .doc-card .subhint{
  margin: -6px 0 10px 0;
  font-size: .88em;
  opacity: .85;
}
#teacher .doc-card.card-context{ background:#eef5ff; }
#teacher .doc-card.card-question{ background:#fff7e6; }
#teacher .doc-card.card-media{ background:#eef8f1; }
#teacher .doc-card.card-explain{ background:#f4f1f8; }

/* pulsanti in fondo */
#teacher .doc-actions{
  display:flex;
  flex-direction:column;
  gap:10px;
  margin-top: 10px;
}



/* Placeholder inside <select> (testo sbiadito finch√© non scegli) */
select.is-placeholder { color:#9aa0a6 !important; }
select option { color:#000; }




/* --- Argomenti: pannello a scomparsa + ricerca --- */
.topicHeaderBtn{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  cursor:pointer;
}
.topicHeaderLeft{display:flex;flex-direction:column;gap:2px}
.topicHeaderTitle{font-weight:700}
.topicHeaderSub{font-size:12px;color:#556;opacity:.85}
.topicChevron{font-size:18px;line-height:1;opacity:.8}
.topicPanel{
  margin-top:8px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  overflow:hidden;
  max-height:0;
  transition:max-height .25s ease;
}
.topicPanel.open{max-height:320px;}
.topicPanelInner{padding:10px}
.topicSearch{
  width:100%;
  padding:10px 10px;
  border:1px solid var(--line);
  border-radius:10px;
  outline:none;
}
.topicActions{
  display:flex;
  gap:8px;
  margin-top:8px;
  flex-wrap:wrap;
}
.topicActions .smallbtn{
  padding:8px 10px;
  font-size:12px;
}
.topicList{
  margin-top:10px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  padding:6px 6px;
  max-height:200px;
  overflow:auto;
}


/* --- Modale incolla JSON (utile su LIM) --- */
.pasteOverlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.6);
  z-index:99999;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:14px;
}
.pasteCard{
  width:min(900px, 96vw);
  background:#fff;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
  padding:14px;
}
.pasteCard h3{margin:0 0 8px}
.pasteArea{
  width:100%;
  min-height:220px;
  resize:vertical;
  border:1px solid var(--line);
  border-radius:12px;
  padding:10px;
  font-family:Consolas, monospace;
  font-size:12px;
  box-sizing:border-box;
}
.pasteActions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin-top:10px}


/* === Pulsante MOSTRA PUNTEGGIO centrale === */
#showScoreBtn{
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  width: 180px;
  height: 180px;
  border-radius: 50%;
  font-size: 1.2em;
  font-weight: 900;
  background: radial-gradient(circle at top left, #ffd84d, #f59e0b);
  color: #3a2500;
  border: none;
  box-shadow: 0 20px 40px rgba(0,0,0,.35);
  display: none;
  align-items: center;
  justify-content: center;
  text-align: center;
  z-index: 9999;
  cursor: pointer;
}
#showScoreBtn:hover{
  transform: translate(-50%, -50%) scale(1.05);
}


/* === Modal "Livello completato" === */
#levelDoneBackdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9998; /* sotto al bottone punteggio (9999) */
}
#levelDoneCard{
  width: min(520px, 92vw);
  background: linear-gradient(135deg, rgba(255,255,255,.98), rgba(255,247,220,.98));
  border-radius: 22px;
  padding: 18px 18px 16px;
  box-shadow: 0 26px 70px rgba(0,0,0,.28);
  border: 1px solid rgba(0,0,0,.06);
  text-align: center;
  transform: scale(.92);
  opacity: 0;
  transition: transform .18s ease, opacity .18s ease;
}
#levelDoneBackdrop.show #levelDoneCard{
  transform: scale(1);
  opacity: 1;
}
#levelDoneTitle{
  font-size: 1.65em;
  font-weight: 1000;
  margin: 4px 0 8px;
}
#levelDoneSubtitle{
  font-size: 1.05em;
  color: #3a3a3a;
  margin: 0 0 12px;
}
#levelDonePills{
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
  margin: 8px 0 10px;
}
.levelPill{
  padding: 8px 12px;
  border-radius: 999px;
  font-weight: 900;
  background: rgba(255,255,255,.8);
  border: 1px solid rgba(0,0,0,.08);
}
#levelDoneActions{
  display:flex;
  gap:10px;
  justify-content:center;
  margin-top: 10px;
}
.levelBtn{
  border: none;
  border-radius: 14px;
  padding: 10px 14px;
  font-weight: 900;
  cursor: pointer;
  box-shadow: 0 12px 26px rgba(0,0,0,.18);
}
#btnLevelOk{
  background: radial-gradient(circle at top left, #60a5fa, #2563eb);
  color: white;
}
#btnLevelScore{
  background: radial-gradient(circle at top left, #ffd84d, #f59e0b);
  color: #3a2500;
}

</style>
<style>
/* --- Archivio Domande: mostra risposte + spiegazione --- */
#libWrap .qcell{ text-align:left; }
#libWrap .qtitle{ margin-bottom:4px; }
#libWrap .opts{ margin-top:6px; padding-left:10px; border-left:3px solid #e5e7eb; font-size:.92em; }
#libWrap .opt{ display:block; margin:2px 0; }
#libWrap .opt.correct{ font-weight:700; color:#15803d; }
#libWrap .opt.correct::before{ content:"‚úì "; }
#libWrap .explain{ margin-top:6px; padding:6px 8px; background:#f8fafc; border-radius:8px; font-size:.9em; }
mark.hl{ background:#fff3a3; padding:0 2px; border-radius:4px; }

  

/* Placeholder inside <select> (testo sbiadito finch√© non scegli) */
select.is-placeholder { color:#9aa0a6 !important; }
select option { color:#000; }




/* --- Argomenti: pannello a scomparsa + ricerca --- */
.topicHeaderBtn{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  cursor:pointer;
}
.topicHeaderLeft{display:flex;flex-direction:column;gap:2px}
.topicHeaderTitle{font-weight:700}
.topicHeaderSub{font-size:12px;color:#556;opacity:.85}
.topicChevron{font-size:18px;line-height:1;opacity:.8}
.topicPanel{
  margin-top:8px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  overflow:hidden;
  max-height:0;
  transition:max-height .25s ease;
}
.topicPanel.open{max-height:320px;}
.topicPanelInner{padding:10px}
.topicSearch{
  width:100%;
  padding:10px 10px;
  border:1px solid var(--line);
  border-radius:10px;
  outline:none;
}
.topicActions{
  display:flex;
  gap:8px;
  margin-top:8px;
  flex-wrap:wrap;
}
.topicActions .smallbtn{
  padding:8px 10px;
  font-size:12px;
}
.topicList{
  margin-top:10px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  padding:6px 6px;
  max-height:200px;
  overflow:auto;
}


/* --- Modale incolla JSON (utile su LIM) --- */
.pasteOverlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.6);
  z-index:99999;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:14px;
}
.pasteCard{
  width:min(900px, 96vw);
  background:#fff;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
  padding:14px;
}
.pasteCard h3{margin:0 0 8px}
.pasteArea{
  width:100%;
  min-height:220px;
  resize:vertical;
  border:1px solid var(--line);
  border-radius:12px;
  padding:10px;
  font-family:Consolas, monospace;
  font-size:12px;
  box-sizing:border-box;
}
.pasteActions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin-top:10px}


/* === Pulsante MOSTRA PUNTEGGIO centrale === */
#showScoreBtn{
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  width: 180px;
  height: 180px;
  border-radius: 50%;
  font-size: 1.2em;
  font-weight: 900;
  background: radial-gradient(circle at top left, #ffd84d, #f59e0b);
  color: #3a2500;
  border: none;
  box-shadow: 0 20px 40px rgba(0,0,0,.35);
  display: none;
  align-items: center;
  justify-content: center;
  text-align: center;
  z-index: 9999;
  cursor: pointer;
}
#showScoreBtn:hover{
  transform: translate(-50%, -50%) scale(1.05);
}


/* === Modal "Livello completato" === */
#levelDoneBackdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9998; /* sotto al bottone punteggio (9999) */
}
#levelDoneCard{
  width: min(520px, 92vw);
  background: linear-gradient(135deg, rgba(255,255,255,.98), rgba(255,247,220,.98));
  border-radius: 22px;
  padding: 18px 18px 16px;
  box-shadow: 0 26px 70px rgba(0,0,0,.28);
  border: 1px solid rgba(0,0,0,.06);
  text-align: center;
  transform: scale(.92);
  opacity: 0;
  transition: transform .18s ease, opacity .18s ease;
}
#levelDoneBackdrop.show #levelDoneCard{
  transform: scale(1);
  opacity: 1;
}
#levelDoneTitle{
  font-size: 1.65em;
  font-weight: 1000;
  margin: 4px 0 8px;
}
#levelDoneSubtitle{
  font-size: 1.05em;
  color: #3a3a3a;
  margin: 0 0 12px;
}
#levelDonePills{
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
  margin: 8px 0 10px;
}
.levelPill{
  padding: 8px 12px;
  border-radius: 999px;
  font-weight: 900;
  background: rgba(255,255,255,.8);
  border: 1px solid rgba(0,0,0,.08);
}
#levelDoneActions{
  display:flex;
  gap:10px;
  justify-content:center;
  margin-top: 10px;
}
.levelBtn{
  border: none;
  border-radius: 14px;
  padding: 10px 14px;
  font-weight: 900;
  cursor: pointer;
  box-shadow: 0 12px 26px rgba(0,0,0,.18);
}
#btnLevelOk{
  background: radial-gradient(circle at top left, #60a5fa, #2563eb);
  color: white;
}
#btnLevelScore{
  background: radial-gradient(circle at top left, #ffd84d, #f59e0b);
  color: #3a2500;
}

</style>
<style>
/* --- Archivio: filtri pi√π evidenti --- */
#archive .archive-filters{
  background: #f8fafc;
  border: 1px solid rgba(0,0,0,.08);
  box-shadow: 0 8px 18px rgba(0,0,0,.07);
}
#archive .archive-filters h2{
  padding: 10px 12px;
  border-radius: 12px;
  background: linear-gradient(0deg, rgba(0,0,0,.03), rgba(0,0,0,0));
}

/* --- Archivio: raggruppamento per difficolt√† --- */
#libWrap .levelBlock{ margin-top: 14px; }
#libWrap .levelHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding: 10px 12px;
  border-radius: 12px;
  font-weight: 800;
  letter-spacing:.2px;
  margin-bottom: 8px;
  border: 1px solid rgba(0,0,0,.06);
}
#libWrap .levelHeader .count{ font-weight:700; opacity:.85; }
#libWrap .level-easy{ background:#eef8f1; }
#libWrap .level-mid{ background:#fff7e6; }
#libWrap .level-hard{ background:#fdecec; }

/* --- Archivio: accordion livelli (Facili / Medie / Difficili) --- */
#libWrap .accWrap{ margin-top: 12px; }
#libWrap .accItem{ margin-top: 12px; }
#libWrap .accHeader{
  width: 100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 10px;
  padding: 12px 12px;
  border-radius: 14px;
  font-weight: 900;
  letter-spacing: .2px;
  border: 1px solid rgba(0,0,0,.06);
  cursor: pointer;
}
#libWrap .accHeader:active{ transform: scale(.99); }
#libWrap .accBody{ margin-top: 10px; }

/* righe leggermente colorate per riconoscere il blocco */
#libWrap table.levelTable.easy tbody tr{ background: rgba(34,197,94,.04); }
#libWrap table.levelTable.mid  tbody tr{ background: rgba(245,158,11,.05); }
#libWrap table.levelTable.hard tbody tr{ background: rgba(239,68,68,.05); }

/* --- Scegli Domande: accordion livelli (come Archivio) --- */
#pickWrap .level-easy{ background:#eef8f1; }
#pickWrap .level-mid{ background:#fff7e6; }
#pickWrap .level-hard{ background:#fdecec; }

#pickWrap .accWrap{ margin-top: 12px; }
#pickWrap .accItem{ margin-top: 12px; }
#pickWrap .accHeader{
  width: 100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 10px;
  padding: 12px 12px;
  border-radius: 14px;
  font-weight: 900;
  letter-spacing: .2px;
  border: 1px solid rgba(0,0,0,.06);
  cursor: pointer;
}
#pickWrap .accHeader:active{ transform: scale(.99); }
#pickWrap .accBody{ margin-top: 10px; }

/* righe leggermente colorate */
#pickWrap table.levelTable.easy tbody tr{ background: rgba(34,197,94,.04); }
#pickWrap table.levelTable.mid  tbody tr{ background: rgba(245,158,11,.05); }
#pickWrap table.levelTable.hard tbody tr{ background: rgba(239,68,68,.05); }


  

/* Placeholder inside <select> (testo sbiadito finch√© non scegli) */
select.is-placeholder { color:#9aa0a6 !important; }
select option { color:#000; }



/* --- Argomenti: pannello a scomparsa + ricerca --- */
.topicHeaderBtn{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  cursor:pointer;
}
.topicHeaderLeft{display:flex;flex-direction:column;gap:2px}
.topicHeaderTitle{font-weight:700}
.topicHeaderSub{font-size:12px;color:#556;opacity:.85}
.topicChevron{font-size:18px;line-height:1;opacity:.8}
.topicPanel{
  margin-top:8px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  overflow:hidden;
  max-height:0;
  transition:max-height .25s ease;
}
.topicPanel.open{max-height:320px;}
.topicPanelInner{padding:10px}
.topicSearch{
  width:100%;
  padding:10px 10px;
  border:1px solid var(--line);
  border-radius:10px;
  outline:none;
}
.topicActions{
  display:flex;
  gap:8px;
  margin-top:8px;
  flex-wrap:wrap;
}
.topicActions .smallbtn{
  padding:8px 10px;
  font-size:12px;
}
.topicList{
  margin-top:10px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  padding:6px 6px;
  max-height:200px;
  overflow:auto;
}


/* --- Modale incolla JSON (utile su LIM) --- */
.pasteOverlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.6);
  z-index:99999;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:14px;
}
.pasteCard{
  width:min(900px, 96vw);
  background:#fff;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
  padding:14px;
}
.pasteCard h3{margin:0 0 8px}
.pasteArea{
  width:100%;
  min-height:220px;
  resize:vertical;
  border:1px solid var(--line);
  border-radius:12px;
  padding:10px;
  font-family:Consolas, monospace;
  font-size:12px;
  box-sizing:border-box;
}
.pasteActions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin-top:10px}


/* === Pulsante MOSTRA PUNTEGGIO centrale === */
#showScoreBtn{
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  width: 180px;
  height: 180px;
  border-radius: 50%;
  font-size: 1.2em;
  font-weight: 900;
  background: radial-gradient(circle at top left, #ffd84d, #f59e0b);
  color: #3a2500;
  border: none;
  box-shadow: 0 20px 40px rgba(0,0,0,.35);
  display: none;
  align-items: center;
  justify-content: center;
  text-align: center;
  z-index: 9999;
  cursor: pointer;
}
#showScoreBtn:hover{
  transform: translate(-50%, -50%) scale(1.05);
}


/* === Modal "Livello completato" === */
#levelDoneBackdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9998; /* sotto al bottone punteggio (9999) */
}
#levelDoneCard{
  width: min(520px, 92vw);
  background: linear-gradient(135deg, rgba(255,255,255,.98), rgba(255,247,220,.98));
  border-radius: 22px;
  padding: 18px 18px 16px;
  box-shadow: 0 26px 70px rgba(0,0,0,.28);
  border: 1px solid rgba(0,0,0,.06);
  text-align: center;
  transform: scale(.92);
  opacity: 0;
  transition: transform .18s ease, opacity .18s ease;
}
#levelDoneBackdrop.show #levelDoneCard{
  transform: scale(1);
  opacity: 1;
}
#levelDoneTitle{
  font-size: 1.65em;
  font-weight: 1000;
  margin: 4px 0 8px;
}
#levelDoneSubtitle{
  font-size: 1.05em;
  color: #3a3a3a;
  margin: 0 0 12px;
}
#levelDonePills{
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
  margin: 8px 0 10px;
}
.levelPill{
  padding: 8px 12px;
  border-radius: 999px;
  font-weight: 900;
  background: rgba(255,255,255,.8);
  border: 1px solid rgba(0,0,0,.08);
}
#levelDoneActions{
  display:flex;
  gap:10px;
  justify-content:center;
  margin-top: 10px;
}
.levelBtn{
  border: none;
  border-radius: 14px;
  padding: 10px 14px;
  font-weight: 900;
  cursor: pointer;
  box-shadow: 0 12px 26px rgba(0,0,0,.18);
}
#btnLevelOk{
  background: radial-gradient(circle at top left, #60a5fa, #2563eb);
  color: white;
}
#btnLevelScore{
  background: radial-gradient(circle at top left, #ffd84d, #f59e0b);
  color: #3a2500;
}

</style>
<style>
/* --- Archivio: colore tabella quando livello selezionato --- */
#libWrap table.level-only.easy tbody tr{ background: rgba(34,197,94,.06); }
#libWrap table.level-only.mid  tbody tr{ background: rgba(245,158,11,.06); }
#libWrap table.level-only.hard tbody tr{ background: rgba(239,68,68,.06); }

 

/* Placeholder inside <select> (testo sbiadito finch√© non scegli) */
select.is-placeholder { color:#9aa0a6 !important; }
select option { color:#000; }




/* --- Argomenti: pannello a scomparsa + ricerca --- */
.topicHeaderBtn{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  cursor:pointer;
}
.topicHeaderLeft{display:flex;flex-direction:column;gap:2px}
.topicHeaderTitle{font-weight:700}
.topicHeaderSub{font-size:12px;color:#556;opacity:.85}
.topicChevron{font-size:18px;line-height:1;opacity:.8}
.topicPanel{
  margin-top:8px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  overflow:hidden;
  max-height:0;
  transition:max-height .25s ease;
}
.topicPanel.open{max-height:320px;}
.topicPanelInner{padding:10px}
.topicSearch{
  width:100%;
  padding:10px 10px;
  border:1px solid var(--line);
  border-radius:10px;
  outline:none;
}
.topicActions{
  display:flex;
  gap:8px;
  margin-top:8px;
  flex-wrap:wrap;
}
.topicActions .smallbtn{
  padding:8px 10px;
  font-size:12px;
}
.topicList{
  margin-top:10px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  padding:6px 6px;
  max-height:200px;
  overflow:auto;
}


/* --- Modale incolla JSON (utile su LIM) --- */
.pasteOverlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.6);
  z-index:99999;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:14px;
}
.pasteCard{
  width:min(900px, 96vw);
  background:#fff;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
  padding:14px;
}
.pasteCard h3{margin:0 0 8px}
.pasteArea{
  width:100%;
  min-height:220px;
  resize:vertical;
  border:1px solid var(--line);
  border-radius:12px;
  padding:10px;
  font-family:Consolas, monospace;
  font-size:12px;
  box-sizing:border-box;
}
.pasteActions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin-top:10px}


/* === Pulsante MOSTRA PUNTEGGIO centrale === */
#showScoreBtn{
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  width: 180px;
  height: 180px;
  border-radius: 50%;
  font-size: 1.2em;
  font-weight: 900;
  background: radial-gradient(circle at top left, #ffd84d, #f59e0b);
  color: #3a2500;
  border: none;
  box-shadow: 0 20px 40px rgba(0,0,0,.35);
  display: none;
  align-items: center;
  justify-content: center;
  text-align: center;
  z-index: 9999;
  cursor: pointer;
}
#showScoreBtn:hover{
  transform: translate(-50%, -50%) scale(1.05);
}


/* === Modal "Livello completato" === */
#levelDoneBackdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9998; /* sotto al bottone punteggio (9999) */
}
#levelDoneCard{
  width: min(520px, 92vw);
  background: linear-gradient(135deg, rgba(255,255,255,.98), rgba(255,247,220,.98));
  border-radius: 22px;
  padding: 18px 18px 16px;
  box-shadow: 0 26px 70px rgba(0,0,0,.28);
  border: 1px solid rgba(0,0,0,.06);
  text-align: center;
  transform: scale(.92);
  opacity: 0;
  transition: transform .18s ease, opacity .18s ease;
}
#levelDoneBackdrop.show #levelDoneCard{
  transform: scale(1);
  opacity: 1;
}
#levelDoneTitle{
  font-size: 1.65em;
  font-weight: 1000;
  margin: 4px 0 8px;
}
#levelDoneSubtitle{
  font-size: 1.05em;
  color: #3a3a3a;
  margin: 0 0 12px;
}
#levelDonePills{
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
  margin: 8px 0 10px;
}
.levelPill{
  padding: 8px 12px;
  border-radius: 999px;
  font-weight: 900;
  background: rgba(255,255,255,.8);
  border: 1px solid rgba(0,0,0,.08);
}
#levelDoneActions{
  display:flex;
  gap:10px;
  justify-content:center;
  margin-top: 10px;
}
.levelBtn{
  border: none;
  border-radius: 14px;
  padding: 10px 14px;
  font-weight: 900;
  cursor: pointer;
  box-shadow: 0 12px 26px rgba(0,0,0,.18);
}
#btnLevelOk{
  background: radial-gradient(circle at top left, #60a5fa, #2563eb);
  color: white;
}
#btnLevelScore{
  background: radial-gradient(circle at top left, #ffd84d, #f59e0b);
  color: #3a2500;
}

</style>
<style>
/* --- Archivio: anteprima media nella tabella --- */
#libWrap .mediaCell{ width: 150px; }
#libWrap .mediaThumb{
  width: 140px;
  height: 90px;
  object-fit: cover;
  border-radius: 10px;
  display: block;
  background: #eef2f5;
}
#libWrap .mediaThumb.video{
  /* same sizing, keep object-fit */
}

  

/* Placeholder inside <select> (testo sbiadito finch√© non scegli) */
select.is-placeholder { color:#9aa0a6 !important; }
select option { color:#000; }



/* --- Argomenti: pannello a scomparsa + ricerca --- */
.topicHeaderBtn{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  cursor:pointer;
}
.topicHeaderLeft{display:flex;flex-direction:column;gap:2px}
.topicHeaderTitle{font-weight:700}
.topicHeaderSub{font-size:12px;color:#556;opacity:.85}
.topicChevron{font-size:18px;line-height:1;opacity:.8}
.topicPanel{
  margin-top:8px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  overflow:hidden;
  max-height:0;
  transition:max-height .25s ease;
}
.topicPanel.open{max-height:320px;}
.topicPanelInner{padding:10px}
.topicSearch{
  width:100%;
  padding:10px 10px;
  border:1px solid var(--line);
  border-radius:10px;
  outline:none;
}
.topicActions{
  display:flex;
  gap:8px;
  margin-top:8px;
  flex-wrap:wrap;
}
.topicActions .smallbtn{
  padding:8px 10px;
  font-size:12px;
}
.topicList{
  margin-top:10px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  padding:6px 6px;
  max-height:200px;
  overflow:auto;
}


/* --- Modale incolla JSON (utile su LIM) --- */
.pasteOverlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.6);
  z-index:99999;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:14px;
}
.pasteCard{
  width:min(900px, 96vw);
  background:#fff;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
  padding:14px;
}
.pasteCard h3{margin:0 0 8px}
.pasteArea{
  width:100%;
  min-height:220px;
  resize:vertical;
  border:1px solid var(--line);
  border-radius:12px;
  padding:10px;
  font-family:Consolas, monospace;
  font-size:12px;
  box-sizing:border-box;
}
.pasteActions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin-top:10px}


/* === Pulsante MOSTRA PUNTEGGIO centrale === */
#showScoreBtn{
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  width: 180px;
  height: 180px;
  border-radius: 50%;
  font-size: 1.2em;
  font-weight: 900;
  background: radial-gradient(circle at top left, #ffd84d, #f59e0b);
  color: #3a2500;
  border: none;
  box-shadow: 0 20px 40px rgba(0,0,0,.35);
  display: none;
  align-items: center;
  justify-content: center;
  text-align: center;
  z-index: 9999;
  cursor: pointer;
}
#showScoreBtn:hover{
  transform: translate(-50%, -50%) scale(1.05);
}


/* === Modal "Livello completato" === */
#levelDoneBackdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9998; /* sotto al bottone punteggio (9999) */
}
#levelDoneCard{
  width: min(520px, 92vw);
  background: linear-gradient(135deg, rgba(255,255,255,.98), rgba(255,247,220,.98));
  border-radius: 22px;
  padding: 18px 18px 16px;
  box-shadow: 0 26px 70px rgba(0,0,0,.28);
  border: 1px solid rgba(0,0,0,.06);
  text-align: center;
  transform: scale(.92);
  opacity: 0;
  transition: transform .18s ease, opacity .18s ease;
}
#levelDoneBackdrop.show #levelDoneCard{
  transform: scale(1);
  opacity: 1;
}
#levelDoneTitle{
  font-size: 1.65em;
  font-weight: 1000;
  margin: 4px 0 8px;
}
#levelDoneSubtitle{
  font-size: 1.05em;
  color: #3a3a3a;
  margin: 0 0 12px;
}
#levelDonePills{
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
  margin: 8px 0 10px;
}
.levelPill{
  padding: 8px 12px;
  border-radius: 999px;
  font-weight: 900;
  background: rgba(255,255,255,.8);
  border: 1px solid rgba(0,0,0,.08);
}
#levelDoneActions{
  display:flex;
  gap:10px;
  justify-content:center;
  margin-top: 10px;
}
.levelBtn{
  border: none;
  border-radius: 14px;
  padding: 10px 14px;
  font-weight: 900;
  cursor: pointer;
  box-shadow: 0 12px 26px rgba(0,0,0,.18);
}
#btnLevelOk{
  background: radial-gradient(circle at top left, #60a5fa, #2563eb);
  color: white;
}
#btnLevelScore{
  background: radial-gradient(circle at top left, #ffd84d, #f59e0b);
  color: #3a2500;
}




/* --- Play section highlight --- */
.playSection{
  background: linear-gradient(135deg,#e0f2fe,#dcfce7);
  border: 2px solid #86efac;
}
.playSection h2{
  text-align: center;
  margin-top: 0;
}

  

/* Placeholder inside <select> (testo sbiadito finch√© non scegli) */
select.is-placeholder { color:#9aa0a6 !important; }
select option { color:#000; }




/* --- Argomenti: pannello a scomparsa + ricerca --- */
.topicHeaderBtn{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  cursor:pointer;
}
.topicHeaderLeft{display:flex;flex-direction:column;gap:2px}
.topicHeaderTitle{font-weight:700}
.topicHeaderSub{font-size:12px;color:#556;opacity:.85}
.topicChevron{font-size:18px;line-height:1;opacity:.8}
.topicPanel{
  margin-top:8px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  overflow:hidden;
  max-height:0;
  transition:max-height .25s ease;
}
.topicPanel.open{max-height:320px;}
.topicPanelInner{padding:10px}
.topicSearch{
  width:100%;
  padding:10px 10px;
  border:1px solid var(--line);
  border-radius:10px;
  outline:none;
}
.topicActions{
  display:flex;
  gap:8px;
  margin-top:8px;
  flex-wrap:wrap;
}
.topicActions .smallbtn{
  padding:8px 10px;
  font-size:12px;
}
.topicList{
  margin-top:10px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  padding:6px 6px;
  max-height:200px;
  overflow:auto;
}


/* --- Modale incolla JSON (utile su LIM) --- */
.pasteOverlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.6);
  z-index:99999;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:14px;
}
.pasteCard{
  width:min(900px, 96vw);
  background:#fff;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
  padding:14px;
}
.pasteCard h3{margin:0 0 8px}
.pasteArea{
  width:100%;
  min-height:220px;
  resize:vertical;
  border:1px solid var(--line);
  border-radius:12px;
  padding:10px;
  font-family:Consolas, monospace;
  font-size:12px;
  box-sizing:border-box;
}
.pasteActions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin-top:10px}


/* === Pulsante MOSTRA PUNTEGGIO centrale === */
#showScoreBtn{
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  width: 180px;
  height: 180px;
  border-radius: 50%;
  font-size: 1.2em;
  font-weight: 900;
  background: radial-gradient(circle at top left, #ffd84d, #f59e0b);
  color: #3a2500;
  border: none;
  box-shadow: 0 20px 40px rgba(0,0,0,.35);
  display: none;
  align-items: center;
  justify-content: center;
  text-align: center;
  z-index: 9999;
  cursor: pointer;
}
#showScoreBtn:hover{
  transform: translate(-50%, -50%) scale(1.05);
}


/* === Modal "Livello completato" === */
#levelDoneBackdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9998; /* sotto al bottone punteggio (9999) */
}
#levelDoneCard{
  width: min(520px, 92vw);
  background: linear-gradient(135deg, rgba(255,255,255,.98), rgba(255,247,220,.98));
  border-radius: 22px;
  padding: 18px 18px 16px;
  box-shadow: 0 26px 70px rgba(0,0,0,.28);
  border: 1px solid rgba(0,0,0,.06);
  text-align: center;
  transform: scale(.92);
  opacity: 0;
  transition: transform .18s ease, opacity .18s ease;
}
#levelDoneBackdrop.show #levelDoneCard{
  transform: scale(1);
  opacity: 1;
}
#levelDoneTitle{
  font-size: 1.65em;
  font-weight: 1000;
  margin: 4px 0 8px;
}
#levelDoneSubtitle{
  font-size: 1.05em;
  color: #3a3a3a;
  margin: 0 0 12px;
}
#levelDonePills{
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
  margin: 8px 0 10px;
}
.levelPill{
  padding: 8px 12px;
  border-radius: 999px;
  font-weight: 900;
  background: rgba(255,255,255,.8);
  border: 1px solid rgba(0,0,0,.08);
}
#levelDoneActions{
  display:flex;
  gap:10px;
  justify-content:center;
  margin-top: 10px;
}
.levelBtn{
  border: none;
  border-radius: 14px;
  padding: 10px 14px;
  font-weight: 900;
  cursor: pointer;
  box-shadow: 0 12px 26px rgba(0,0,0,.18);
}
#btnLevelOk{
  background: radial-gradient(circle at top left, #60a5fa, #2563eb);
  color: white;
}
#btnLevelScore{
  background: radial-gradient(circle at top left, #ffd84d, #f59e0b);
  color: #3a2500;
}

</style>
<style>
/* --- GAME: tutto deve entrare nello schermo (anche con media) --- */
body.noScroll{ overflow: hidden; }

/* La topnav √® sticky: lasciamo spazio e impediamo overflow della schermata gioco */
#game.active{
  height: calc(100vh - 64px);
  overflow: hidden;
  padding-top: 12px;
  padding-bottom: 12px;
}

/* Card del gioco: altezza massima dentro viewport, senza scrollbar */
#game .card{
  max-height: none !important;   /* üî• niente limite */
  overflow: visible !important;  /* üî• niente taglio */
  display: flex;
  flex-direction: column;
}

/* Media ridimensionato per non far comparire la scrollbar */
#game #qImg,
#game #qVideo{
  max-height: 28vh;
  width: 100%;
  object-fit: contain;
  margin-bottom: 8px;
}

/* Spazi un filo pi√π compatti in gioco  DISTANZA TRA LE RISPOSTE E RIGHE */
#game h2{ margin: 6px 0 8px; }
#game .btn{ padding: 10px 12px; margin: 6px auto; }

#game #feedback{ margin-top: 50px; }
#game #nextBtn{ margin-top: 15px; }



/* Placeholder inside <select> (testo sbiadito finch√© non scegli) */
select.is-placeholder { color:#9aa0a6 !important; }
select option { color:#000; }



/* === GAME: risposte sempre 2 per riga, stessa altezza === */
#game #optionsWrap{
  display:grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap:14px;
  align-items:stretch;
}

/* i bottoni risposta nel gioco (sono .btn.option) */
#game #optionsWrap .btn.option{
  width:100%;
  max-width:none;
  margin:0;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
 /* min-height:150px;*/
  padding:8px;
  box-sizing:border-box;
}

/* ‚úÖ Se NESSUNA risposta ha immagine: card pi√π basse/rettangolari */
#game #optionsWrap:not(.hasOptMedia) .btn.option{
  min-height:70px;
  justify-content:center;
}

/* testo centrato quando non c'√® immagine */
#game #optionsWrap:not(.hasOptMedia) .btn.option{
  text-align:center;
}

/* immagine risposta */
#game #optionsWrap .btn.option img{
  max-height:170px;
  width:100%;
  object-fit:contain;
  margin:0 0 8px 0;
}

/* testo risposta */
#game #optionsWrap .btn.option .optBtnText,
#game #optionsWrap .btn.option span{
  margin-top:auto;
  font-weight:700;
  text-align:center;
}

/* su schermi piccoli torna a 1 colonna */
@media (max-width: 560px){
  #game #optionsWrap{ grid-template-columns: 1fr; }
}




/* --- Argomenti: pannello a scomparsa + ricerca --- */
.topicHeaderBtn{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  cursor:pointer;
}
.topicHeaderLeft{display:flex;flex-direction:column;gap:2px}
.topicHeaderTitle{font-weight:700}
.topicHeaderSub{font-size:12px;color:#556;opacity:.85}
.topicChevron{font-size:18px;line-height:1;opacity:.8}
.topicPanel{
  margin-top:8px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  overflow:hidden;
  max-height:0;
  transition:max-height .25s ease;
}
.topicPanel.open{max-height:320px;}
.topicPanelInner{padding:10px}
.topicSearch{
  width:100%;
  padding:10px 10px;
  border:1px solid var(--line);
  border-radius:10px;
  outline:none;
}
.topicActions{
  display:flex;
  gap:8px;
  margin-top:8px;
  flex-wrap:wrap;
}
.topicActions .smallbtn{
  padding:8px 10px;
  font-size:12px;
}
.topicList{
  margin-top:10px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  padding:6px 6px;
  max-height:200px;
  overflow:auto;
}


/* --- Modale incolla JSON (utile su LIM) --- */
.pasteOverlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.6);
  z-index:99999;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:14px;
}
.pasteCard{
  width:min(900px, 96vw);
  background:#fff;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
  padding:14px;
}
.pasteCard h3{margin:0 0 8px}
.pasteArea{
  width:100%;
  min-height:220px;
  resize:vertical;
  border:1px solid var(--line);
  border-radius:12px;
  padding:10px;
  font-family:Consolas, monospace;
  font-size:12px;
  box-sizing:border-box;
}
.pasteActions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin-top:10px}


/* === Pulsante MOSTRA PUNTEGGIO centrale === */
#showScoreBtn{
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  width: 180px;
  height: 180px;
  border-radius: 50%;
  font-size: 1.2em;
  font-weight: 900;
  background: radial-gradient(circle at top left, #ffd84d, #f59e0b);
  color: #3a2500;
  border: none;
  box-shadow: 0 20px 40px rgba(0,0,0,.35);
  display: none;
  align-items: center;
  justify-content: center;
  text-align: center;
  z-index: 9999;
  cursor: pointer;
}
#showScoreBtn:hover{
  transform: translate(-50%, -50%) scale(1.05);
}


/* === Modal "Livello completato" === */
#levelDoneBackdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9998; /* sotto al bottone punteggio (9999) */
}
#levelDoneCard{
  width: min(520px, 92vw);
  background: linear-gradient(135deg, rgba(255,255,255,.98), rgba(255,247,220,.98));
  border-radius: 22px;
  padding: 18px 18px 16px;
  box-shadow: 0 26px 70px rgba(0,0,0,.28);
  border: 1px solid rgba(0,0,0,.06);
  text-align: center;
  transform: scale(.92);
  opacity: 0;
  transition: transform .18s ease, opacity .18s ease;
}
#levelDoneBackdrop.show #levelDoneCard{
  transform: scale(1);
  opacity: 1;
}
#levelDoneTitle{
  font-size: 1.65em;
  font-weight: 1000;
  margin: 4px 0 8px;
}
#levelDoneSubtitle{
  font-size: 1.05em;
  color: #3a3a3a;
  margin: 0 0 12px;
}
#levelDonePills{
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
  margin: 8px 0 10px;
}
.levelPill{
  padding: 8px 12px;
  border-radius: 999px;
  font-weight: 900;
  background: rgba(255,255,255,.8);
  border: 1px solid rgba(0,0,0,.08);
}
#levelDoneActions{
  display:flex;
  gap:10px;
  justify-content:center;
  margin-top: 10px;
}
.levelBtn{
  border: none;
  border-radius: 14px;
  padding: 10px 14px;
  font-weight: 900;
  cursor: pointer;
  box-shadow: 0 12px 26px rgba(0,0,0,.18);
}
#btnLevelOk{
  background: radial-gradient(circle at top left, #60a5fa, #2563eb);
  color: white;
}
#btnLevelScore{
  background: radial-gradient(circle at top left, #ffd84d, #f59e0b);
  color: #3a2500;
}

</style>
<style>
/* --- GAME: domanda pi√π evidenziata e centrata --- */
#game #qText{
  text-align:center;
  background:#f8fafc;
  border:2px solid #e5e7eb;
  border-radius:16px;
  padding:14px 14px;
  font-size:1.25em;
  line-height:1.25;
  margin:10px 0 10px;
}
#game #qTopic{
  text-align:center !important;
  margin-bottom:8px;
}

  

/* Placeholder inside <select> (testo sbiadito finch√© non scegli) */
select.is-placeholder { color:#9aa0a6 !important; }
select option { color:#000; }



/* --- Argomenti: pannello a scomparsa + ricerca --- */
.topicHeaderBtn{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  cursor:pointer;
}
.topicHeaderLeft{display:flex;flex-direction:column;gap:2px}
.topicHeaderTitle{font-weight:700}
.topicHeaderSub{font-size:12px;color:#556;opacity:.85}
.topicChevron{font-size:18px;line-height:1;opacity:.8}
.topicPanel{
  margin-top:8px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  overflow:hidden;
  max-height:0;
  transition:max-height .25s ease;
}
.topicPanel.open{max-height:320px;}
.topicPanelInner{padding:10px}
.topicSearch{
  width:100%;
  padding:10px 10px;
  border:1px solid var(--line);
  border-radius:10px;
  outline:none;
}
.topicActions{
  display:flex;
  gap:8px;
  margin-top:8px;
  flex-wrap:wrap;
}
.topicActions .smallbtn{
  padding:8px 10px;
  font-size:12px;
}
.topicList{
  margin-top:10px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  padding:6px 6px;
  max-height:200px;
  overflow:auto;
}


/* --- Modale incolla JSON (utile su LIM) --- */
.pasteOverlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.6);
  z-index:99999;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:14px;
}
.pasteCard{
  width:min(900px, 96vw);
  background:#fff;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
  padding:14px;
}
.pasteCard h3{margin:0 0 8px}
.pasteArea{
  width:100%;
  min-height:220px;
  resize:vertical;
  border:1px solid var(--line);
  border-radius:12px;
  padding:10px;
  font-family:Consolas, monospace;
  font-size:12px;
  box-sizing:border-box;
}
.pasteActions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin-top:10px}


/* === Pulsante MOSTRA PUNTEGGIO centrale === */
#showScoreBtn{
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  width: 180px;
  height: 180px;
  border-radius: 50%;
  font-size: 1.2em;
  font-weight: 900;
  background: radial-gradient(circle at top left, #ffd84d, #f59e0b);
  color: #3a2500;
  border: none;
  box-shadow: 0 20px 40px rgba(0,0,0,.35);
  display: none;
  align-items: center;
  justify-content: center;
  text-align: center;
  z-index: 9999;
  cursor: pointer;
}
#showScoreBtn:hover{
  transform: translate(-50%, -50%) scale(1.05);
}


/* === Modal "Livello completato" === */
#levelDoneBackdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9998; /* sotto al bottone punteggio (9999) */
}
#levelDoneCard{
  width: min(520px, 92vw);
  background: linear-gradient(135deg, rgba(255,255,255,.98), rgba(255,247,220,.98));
  border-radius: 22px;
  padding: 18px 18px 16px;
  box-shadow: 0 26px 70px rgba(0,0,0,.28);
  border: 1px solid rgba(0,0,0,.06);
  text-align: center;
  transform: scale(.92);
  opacity: 0;
  transition: transform .18s ease, opacity .18s ease;
}
#levelDoneBackdrop.show #levelDoneCard{
  transform: scale(1);
  opacity: 1;
}
#levelDoneTitle{
  font-size: 1.65em;
  font-weight: 1000;
  margin: 4px 0 8px;
}
#levelDoneSubtitle{
  font-size: 1.05em;
  color: #3a3a3a;
  margin: 0 0 12px;
}
#levelDonePills{
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
  margin: 8px 0 10px;
}
.levelPill{
  padding: 8px 12px;
  border-radius: 999px;
  font-weight: 900;
  background: rgba(255,255,255,.8);
  border: 1px solid rgba(0,0,0,.08);
}
#levelDoneActions{
  display:flex;
  gap:10px;
  justify-content:center;
  margin-top: 10px;
}
.levelBtn{
  border: none;
  border-radius: 14px;
  padding: 10px 14px;
  font-weight: 900;
  cursor: pointer;
  box-shadow: 0 12px 26px rgba(0,0,0,.18);
}
#btnLevelOk{
  background: radial-gradient(circle at top left, #60a5fa, #2563eb);
  color: white;
}
#btnLevelScore{
  background: radial-gradient(circle at top left, #ffd84d, #f59e0b);
  color: #3a2500;
}

</style>
<style>
/* --- GAME: CSS pi√π accattivante (stile quiz) --- */
#game .card{
  border: 1px solid rgba(0,0,0,.06);
  box-shadow: 0 14px 34px rgba(0,0,0,.10);
}

#game #qText{
  background: linear-gradient(135deg, rgba(14,165,233,.10), rgba(34,197,94,.10));
  border: 2px solid rgba(0,0,0,.06);
  box-shadow: inset 0 0 0 2px rgba(255,255,255,.55);
  border-radius: 18px;
  padding: 16px 14px;
  font-size: 1.35em;
  letter-spacing: .2px;
}

#game .btn.option{
  border: 2px solid rgba(0,0,0,.08);
  box-shadow: 0 10px 20px rgba(0,0,0,.10);
  font-weight: 800;
  transition: transform .08s ease, box-shadow .12s ease, filter .12s ease;
}
#game .btn.option:hover{ filter: brightness(1.02); }
#game .btn.option:active{ transform: scale(.99); }

/* Stati corretto/sbagliato: pi√π evidenti */
#game .btn.option.correct{
  background: linear-gradient(135deg, rgba(34,197,94,.25), rgba(34,197,94,.08));
  border-color: rgba(34,197,94,.85);
  box-shadow: 0 0 0 3px rgba(34,197,94,.18), 0 16px 26px rgba(0,0,0,.12);
  animation: popGreen .28s ease;
}
#game .btn.option.wrong{
  background: linear-gradient(135deg, rgba(239,68,68,.22), rgba(239,68,68,.08));
  border-color: rgba(239,68,68,.85);
  box-shadow: 0 0 0 3px rgba(239,68,68,.15), 0 16px 26px rgba(0,0,0,.12);
  animation: popRed .28s ease;
}

@keyframes popGreen{
  0%{ transform: scale(1); }
  55%{ transform: scale(1.015); }
  100%{ transform: scale(1); }
}
@keyframes popRed{
  0%{ transform: scale(1); }
  55%{ transform: scale(1.01); }
  100%{ transform: scale(1); }
}

/* Feedback: pi√π leggibile */
#game #feedback{
  text-align:center;
  font-size: 1.05em;
  background: #f8fafc;
  border: 1px solid rgba(0,0,0,.06);
  border-radius: 14px;
  padding: 10px 12px;
}

/* Pulsante prossima pi√π "call to action" */
#game #nextBtn{
  background: linear-gradient(135deg, rgba(17,17,17,1), rgba(17,17,17,.86));
  color: #fff;
  border: none;
  box-shadow: 0 12px 24px rgba(0,0,0,.18);
}

 

/* Placeholder inside <select> (testo sbiadito finch√© non scegli) */
select.is-placeholder { color:#9aa0a6 !important; }
select option { color:#000; }




/* --- Argomenti: pannello a scomparsa + ricerca --- */
.topicHeaderBtn{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  cursor:pointer;
}
.topicHeaderLeft{display:flex;flex-direction:column;gap:2px}
.topicHeaderTitle{font-weight:700}
.topicHeaderSub{font-size:12px;color:#556;opacity:.85}
.topicChevron{font-size:18px;line-height:1;opacity:.8}
.topicPanel{
  margin-top:8px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  overflow:hidden;
  max-height:0;
  transition:max-height .25s ease;
}
.topicPanel.open{max-height:320px;}
.topicPanelInner{padding:10px}
.topicSearch{
  width:100%;
  padding:10px 10px;
  border:1px solid var(--line);
  border-radius:10px;
  outline:none;
}
.topicActions{
  display:flex;
  gap:8px;
  margin-top:8px;
  flex-wrap:wrap;
}
.topicActions .smallbtn{
  padding:8px 10px;
  font-size:12px;
}
.topicList{
  margin-top:10px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  padding:6px 6px;
  max-height:200px;
  overflow:auto;
}


/* --- Modale incolla JSON (utile su LIM) --- */
.pasteOverlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.6);
  z-index:99999;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:14px;
}
.pasteCard{
  width:min(900px, 96vw);
  background:#fff;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
  padding:14px;
}
.pasteCard h3{margin:0 0 8px}
.pasteArea{
  width:100%;
  min-height:220px;
  resize:vertical;
  border:1px solid var(--line);
  border-radius:12px;
  padding:10px;
  font-family:Consolas, monospace;
  font-size:12px;
  box-sizing:border-box;
}
.pasteActions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin-top:10px}


/* === Pulsante MOSTRA PUNTEGGIO centrale === */
#showScoreBtn{
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  width: 180px;
  height: 180px;
  border-radius: 50%;
  font-size: 1.2em;
  font-weight: 900;
  background: radial-gradient(circle at top left, #ffd84d, #f59e0b);
  color: #3a2500;
  border: none;
  box-shadow: 0 20px 40px rgba(0,0,0,.35);
  display: none;
  align-items: center;
  justify-content: center;
  text-align: center;
  z-index: 9999;
  cursor: pointer;
}
#showScoreBtn:hover{
  transform: translate(-50%, -50%) scale(1.05);
}


/* === Modal "Livello completato" === */
#levelDoneBackdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9998; /* sotto al bottone punteggio (9999) */
}
#levelDoneCard{
  width: min(520px, 92vw);
  background: linear-gradient(135deg, rgba(255,255,255,.98), rgba(255,247,220,.98));
  border-radius: 22px;
  padding: 18px 18px 16px;
  box-shadow: 0 26px 70px rgba(0,0,0,.28);
  border: 1px solid rgba(0,0,0,.06);
  text-align: center;
  transform: scale(.92);
  opacity: 0;
  transition: transform .18s ease, opacity .18s ease;
}
#levelDoneBackdrop.show #levelDoneCard{
  transform: scale(1);
  opacity: 1;
}
#levelDoneTitle{
  font-size: 1.65em;
  font-weight: 1000;
  margin: 4px 0 8px;
}
#levelDoneSubtitle{
  font-size: 1.05em;
  color: #3a3a3a;
  margin: 0 0 12px;
}
#levelDonePills{
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
  margin: 8px 0 10px;
}
.levelPill{
  padding: 8px 12px;
  border-radius: 999px;
  font-weight: 900;
  background: rgba(255,255,255,.8);
  border: 1px solid rgba(0,0,0,.08);
}
#levelDoneActions{
  display:flex;
  gap:10px;
  justify-content:center;
  margin-top: 10px;
}
.levelBtn{
  border: none;
  border-radius: 14px;
  padding: 10px 14px;
  font-weight: 900;
  cursor: pointer;
  box-shadow: 0 12px 26px rgba(0,0,0,.18);
}
#btnLevelOk{
  background: radial-gradient(circle at top left, #60a5fa, #2563eb);
  color: white;
}
#btnLevelScore{
  background: radial-gradient(circle at top left, #ffd84d, #f59e0b);
  color: #3a2500;
}

</style>
<style>
/* --- GAME: glow / lampeggio stile quiz --- */

/* Glow verde pulsante (corretto) */
#game .btn.option.correct{
  animation: glowGreen 1.2s ease-out infinite;
}

@keyframes glowGreen{
  0%{
    box-shadow:
      0 0 0 3px rgba(34,197,94,.18),
      0 0 12px rgba(34,197,94,.35),
      0 16px 26px rgba(0,0,0,.12);
  }
  50%{
    box-shadow:
      0 0 0 6px rgba(34,197,94,.28),
      0 0 26px rgba(34,197,94,.55),
      0 18px 30px rgba(0,0,0,.14);
  }
  100%{
    box-shadow:
      0 0 0 3px rgba(34,197,94,.18),
      0 0 12px rgba(34,197,94,.35),
      0 16px 26px rgba(0,0,0,.12);
  }
}

/* Glow rosso se sbagliato (meno invadente) */
#game .btn.option.wrong{
  animation: glowRed .9s ease-out 2;
}

@keyframes glowRed{
  0%{
    box-shadow:
      0 0 0 3px rgba(239,68,68,.18),
      0 0 10px rgba(239,68,68,.35),
      0 16px 26px rgba(0,0,0,.12);
  }
  50%{
    box-shadow:
      0 0 0 6px rgba(239,68,68,.32),
      0 0 22px rgba(239,68,68,.55),
      0 18px 30px rgba(0,0,0,.14);
  }
  100%{
    box-shadow:
      0 0 0 3px rgba(239,68,68,.18),
      0 0 10px rgba(239,68,68,.35),
      0 16px 26px rgba(0,0,0,.12);
  }
}

 

/* Placeholder inside <select> (testo sbiadito finch√© non scegli) */
select.is-placeholder { color:#9aa0a6 !important; }
select option { color:#000; }




/* --- Argomenti: pannello a scomparsa + ricerca --- */
.topicHeaderBtn{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  cursor:pointer;
}
.topicHeaderLeft{display:flex;flex-direction:column;gap:2px}
.topicHeaderTitle{font-weight:700}
.topicHeaderSub{font-size:12px;color:#556;opacity:.85}
.topicChevron{font-size:18px;line-height:1;opacity:.8}
.topicPanel{
  margin-top:8px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  overflow:hidden;
  max-height:0;
  transition:max-height .25s ease;
}
.topicPanel.open{max-height:320px;}
.topicPanelInner{padding:10px}
.topicSearch{
  width:100%;
  padding:10px 10px;
  border:1px solid var(--line);
  border-radius:10px;
  outline:none;
}
.topicActions{
  display:flex;
  gap:8px;
  margin-top:8px;
  flex-wrap:wrap;
}
.topicActions .smallbtn{
  padding:8px 10px;
  font-size:12px;
}
.topicList{
  margin-top:10px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  padding:6px 6px;
  max-height:200px;
  overflow:auto;
}


/* --- Modale incolla JSON (utile su LIM) --- */
.pasteOverlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.6);
  z-index:99999;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:14px;
}
.pasteCard{
  width:min(900px, 96vw);
  background:#fff;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
  padding:14px;
}
.pasteCard h3{margin:0 0 8px}
.pasteArea{
  width:100%;
  min-height:220px;
  resize:vertical;
  border:1px solid var(--line);
  border-radius:12px;
  padding:10px;
  font-family:Consolas, monospace;
  font-size:12px;
  box-sizing:border-box;
}
.pasteActions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin-top:10px}


/* === Pulsante MOSTRA PUNTEGGIO centrale === */
#showScoreBtn{
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  width: 180px;
  height: 180px;
  border-radius: 50%;
  font-size: 1.2em;
  font-weight: 900;
  background: radial-gradient(circle at top left, #ffd84d, #f59e0b);
  color: #3a2500;
  border: none;
  box-shadow: 0 20px 40px rgba(0,0,0,.35);
  display: none;
  align-items: center;
  justify-content: center;
  text-align: center;
  z-index: 9999;
  cursor: pointer;
}
#showScoreBtn:hover{
  transform: translate(-50%, -50%) scale(1.05);
}


/* === Modal "Livello completato" === */
#levelDoneBackdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9998; /* sotto al bottone punteggio (9999) */
}
#levelDoneCard{
  width: min(520px, 92vw);
  background: linear-gradient(135deg, rgba(255,255,255,.98), rgba(255,247,220,.98));
  border-radius: 22px;
  padding: 18px 18px 16px;
  box-shadow: 0 26px 70px rgba(0,0,0,.28);
  border: 1px solid rgba(0,0,0,.06);
  text-align: center;
  transform: scale(.92);
  opacity: 0;
  transition: transform .18s ease, opacity .18s ease;
}
#levelDoneBackdrop.show #levelDoneCard{
  transform: scale(1);
  opacity: 1;
}
#levelDoneTitle{
  font-size: 1.65em;
  font-weight: 1000;
  margin: 4px 0 8px;
}
#levelDoneSubtitle{
  font-size: 1.05em;
  color: #3a3a3a;
  margin: 0 0 12px;
}
#levelDonePills{
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
  margin: 8px 0 10px;
}
.levelPill{
  padding: 8px 12px;
  border-radius: 999px;
  font-weight: 900;
  background: rgba(255,255,255,.8);
  border: 1px solid rgba(0,0,0,.08);
}
#levelDoneActions{
  display:flex;
  gap:10px;
  justify-content:center;
  margin-top: 10px;
}
.levelBtn{
  border: none;
  border-radius: 14px;
  padding: 10px 14px;
  font-weight: 900;
  cursor: pointer;
  box-shadow: 0 12px 26px rgba(0,0,0,.18);
}
#btnLevelOk{
  background: radial-gradient(circle at top left, #60a5fa, #2563eb);
  color: white;
}
#btnLevelScore{
  background: radial-gradient(circle at top left, #ffd84d, #f59e0b);
  color: #3a2500;
}

</style>
<style>
/* --- GAME: feedback MOLTO evidente --- */

/* Overlay colore schermo */
#game.correct-bg::before,
#game.wrong-bg::before{
  content:"";
  position:fixed;
  inset:0;
  z-index:5;
  pointer-events:none;
}

#game.correct-bg::before{
  background: rgba(34,197,94,.18);
  animation: flashGreen 0.6s ease-out;
}

#game.wrong-bg::before{
  background: rgba(239,68,68,.18);
  animation: flashRed 0.6s ease-out;
}

@keyframes flashGreen{
  0%{ opacity:0; }
  40%{ opacity:1; }
  100%{ opacity:0; }
}
@keyframes flashRed{
  0%{ opacity:0; }
  40%{ opacity:1; }
  100%{ opacity:0; }
}

/* Badge centrale */
#game .resultBadge{
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%) scale(.9);
  z-index:10001;
  padding:22px 30px;
  border-radius:22px;
  font-size:2.2em;
  font-weight:900;
  letter-spacing:.5px;
  color:#fff;
  display:none;
  box-shadow:0 30px 60px rgba(0,0,0,.35);
}

#game .resultBadge.ok{
  background: linear-gradient(135deg,#22c55e,#16a34a);
}

#game .resultBadge.ko{
  background: linear-gradient(135deg,#ef4444,#b91c1c);
}

#game .resultBadge.show{
  display:block;
  animation: popBadge .6s ease-out;
}

@keyframes popBadge{
  0%{ transform:translate(-50%,-50%) scale(.7); opacity:0; }
  60%{ transform:translate(-50%,-50%) scale(1.08); opacity:1; }
  100%{ transform:translate(-50%,-50%) scale(1); }
}



/* Placeholder inside <select> (testo sbiadito finch√© non scegli) */
select.is-placeholder { color:#9aa0a6 !important; }
select option { color:#000; }




/* --- Argomenti: pannello a scomparsa + ricerca --- */
.topicHeaderBtn{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  cursor:pointer;
}
.topicHeaderLeft{display:flex;flex-direction:column;gap:2px}
.topicHeaderTitle{font-weight:700}
.topicHeaderSub{font-size:12px;color:#556;opacity:.85}
.topicChevron{font-size:18px;line-height:1;opacity:.8}
.topicPanel{
  margin-top:8px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  overflow:hidden;
  max-height:0;
  transition:max-height .25s ease;
}
.topicPanel.open{max-height:320px;}
.topicPanelInner{padding:10px}
.topicSearch{
  width:100%;
  padding:10px 10px;
  border:1px solid var(--line);
  border-radius:10px;
  outline:none;
}
.topicActions{
  display:flex;
  gap:8px;
  margin-top:8px;
  flex-wrap:wrap;
}
.topicActions .smallbtn{
  padding:8px 10px;
  font-size:12px;
}
.topicList{
  margin-top:10px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  padding:6px 6px;
  max-height:200px;
  overflow:auto;
}


/* --- Modale incolla JSON (utile su LIM) --- */
.pasteOverlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.6);
  z-index:99999;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:14px;
}
.pasteCard{
  width:min(900px, 96vw);
  background:#fff;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
  padding:14px;
}
.pasteCard h3{margin:0 0 8px}
.pasteArea{
  width:100%;
  min-height:220px;
  resize:vertical;
  border:1px solid var(--line);
  border-radius:12px;
  padding:10px;
  font-family:Consolas, monospace;
  font-size:12px;
  box-sizing:border-box;
}
.pasteActions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin-top:10px}


/* === Pulsante MOSTRA PUNTEGGIO centrale === */
#showScoreBtn{
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  width: 180px;
  height: 180px;
  border-radius: 50%;
  font-size: 1.2em;
  font-weight: 900;
  background: radial-gradient(circle at top left, #ffd84d, #f59e0b);
  color: #3a2500;
  border: none;
  box-shadow: 0 20px 40px rgba(0,0,0,.35);
  display: none;
  align-items: center;
  justify-content: center;
  text-align: center;
  z-index: 9999;
  cursor: pointer;
}
#showScoreBtn:hover{
  transform: translate(-50%, -50%) scale(1.05);
}


/* === Modal "Livello completato" === */
#levelDoneBackdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9998; /* sotto al bottone punteggio (9999) */
}
#levelDoneCard{
  width: min(520px, 92vw);
  background: linear-gradient(135deg, rgba(255,255,255,.98), rgba(255,247,220,.98));
  border-radius: 22px;
  padding: 18px 18px 16px;
  box-shadow: 0 26px 70px rgba(0,0,0,.28);
  border: 1px solid rgba(0,0,0,.06);
  text-align: center;
  transform: scale(.92);
  opacity: 0;
  transition: transform .18s ease, opacity .18s ease;
}
#levelDoneBackdrop.show #levelDoneCard{
  transform: scale(1);
  opacity: 1;
}
#levelDoneTitle{
  font-size: 1.65em;
  font-weight: 1000;
  margin: 4px 0 8px;
}
#levelDoneSubtitle{
  font-size: 1.05em;
  color: #3a3a3a;
  margin: 0 0 12px;
}
#levelDonePills{
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
  margin: 8px 0 10px;
}
.levelPill{
  padding: 8px 12px;
  border-radius: 999px;
  font-weight: 900;
  background: rgba(255,255,255,.8);
  border: 1px solid rgba(0,0,0,.08);
}
#levelDoneActions{
  display:flex;
  gap:10px;
  justify-content:center;
  margin-top: 10px;
}
.levelBtn{
  border: none;
  border-radius: 14px;
  padding: 10px 14px;
  font-weight: 900;
  cursor: pointer;
  box-shadow: 0 12px 26px rgba(0,0,0,.18);
}
#btnLevelOk{
  background: radial-gradient(circle at top left, #60a5fa, #2563eb);
  color: white;
}
#btnLevelScore{
  background: radial-gradient(circle at top left, #ffd84d, #f59e0b);
  color: #3a2500;
}

</style>
<style>
/* --- GAME: feedback SOFT (solo area testo) --- */

/* Disattiva overlay e badge */
#game.correct-bg::before,
#game.wrong-bg::before{
  display:none !important;
}
#game .resultBadge{
  display:none !important;
}

/* Feedback box: evidenziazione pallida */
#game #feedback{
  transition: background-color .25s ease, border-color .25s ease;
}

#game #feedback.ok{
  background: rgba(34,197,94,.12);
  border: 1px solid rgba(34,197,94,.35);
}

#game #feedback.ko{
  background: rgba(239,68,68,.12);
  border: 1px solid rgba(239,68,68,.35);
}



/* Placeholder inside <select> (testo sbiadito finch√© non scegli) */
select.is-placeholder { color:#9aa0a6 !important; }
select option { color:#000; }




/* --- Argomenti: pannello a scomparsa + ricerca --- */
.topicHeaderBtn{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  cursor:pointer;
}
.topicHeaderLeft{display:flex;flex-direction:column;gap:2px}
.topicHeaderTitle{font-weight:700}
.topicHeaderSub{font-size:12px;color:#556;opacity:.85}
.topicChevron{font-size:18px;line-height:1;opacity:.8}
.topicPanel{
  margin-top:8px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  overflow:hidden;
  max-height:0;
  transition:max-height .25s ease;
}
.topicPanel.open{max-height:320px;}
.topicPanelInner{padding:10px}
.topicSearch{
  width:100%;
  padding:10px 10px;
  border:1px solid var(--line);
  border-radius:10px;
  outline:none;
}
.topicActions{
  display:flex;
  gap:8px;
  margin-top:8px;
  flex-wrap:wrap;
}
.topicActions .smallbtn{
  padding:8px 10px;
  font-size:12px;
}
.topicList{
  margin-top:10px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  padding:6px 6px;
  max-height:200px;
  overflow:auto;
}


/* --- Modale incolla JSON (utile su LIM) --- */
.pasteOverlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.6);
  z-index:99999;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:14px;
}
.pasteCard{
  width:min(900px, 96vw);
  background:#fff;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
  padding:14px;
}
.pasteCard h3{margin:0 0 8px}
.pasteArea{
  width:100%;
  min-height:220px;
  resize:vertical;
  border:1px solid var(--line);
  border-radius:12px;
  padding:10px;
  font-family:Consolas, monospace;
  font-size:12px;
  box-sizing:border-box;
}
.pasteActions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin-top:10px}


/* === Pulsante MOSTRA PUNTEGGIO centrale === */
#showScoreBtn{
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  width: 180px;
  height: 180px;
  border-radius: 50%;
  font-size: 1.2em;
  font-weight: 900;
  background: radial-gradient(circle at top left, #ffd84d, #f59e0b);
  color: #3a2500;
  border: none;
  box-shadow: 0 20px 40px rgba(0,0,0,.35);
  display: none;
  align-items: center;
  justify-content: center;
  text-align: center;
  z-index: 9999;
  cursor: pointer;
}
#showScoreBtn:hover{
  transform: translate(-50%, -50%) scale(1.05);
}


/* === Modal "Livello completato" === */
#levelDoneBackdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9998; /* sotto al bottone punteggio (9999) */
}
#levelDoneCard{
  width: min(520px, 92vw);
  background: linear-gradient(135deg, rgba(255,255,255,.98), rgba(255,247,220,.98));
  border-radius: 22px;
  padding: 18px 18px 16px;
  box-shadow: 0 26px 70px rgba(0,0,0,.28);
  border: 1px solid rgba(0,0,0,.06);
  text-align: center;
  transform: scale(.92);
  opacity: 0;
  transition: transform .18s ease, opacity .18s ease;
}
#levelDoneBackdrop.show #levelDoneCard{
  transform: scale(1);
  opacity: 1;
}
#levelDoneTitle{
  font-size: 1.65em;
  font-weight: 1000;
  margin: 4px 0 8px;
}
#levelDoneSubtitle{
  font-size: 1.05em;
  color: #3a3a3a;
  margin: 0 0 12px;
}
#levelDonePills{
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
  margin: 8px 0 10px;
}
.levelPill{
  padding: 8px 12px;
  border-radius: 999px;
  font-weight: 900;
  background: rgba(255,255,255,.8);
  border: 1px solid rgba(0,0,0,.08);
}
#levelDoneActions{
  display:flex;
  gap:10px;
  justify-content:center;
  margin-top: 10px;
}
.levelBtn{
  border: none;
  border-radius: 14px;
  padding: 10px 14px;
  font-weight: 900;
  cursor: pointer;
  box-shadow: 0 12px 26px rgba(0,0,0,.18);
}
#btnLevelOk{
  background: radial-gradient(circle at top left, #60a5fa, #2563eb);
  color: white;
}
#btnLevelScore{
  background: radial-gradient(circle at top left, #ffd84d, #f59e0b);
  color: #3a2500;
}

</style>
<style>
:root{
  --p1:#3b82f6;
  --p2:#f59e0b;
  --p3:#8b5cf6;
  --p4:#ec4899;
}
#game .gameArea{
  /* pi√π larga: la colonna centrale respira */
  max-width:1400px;              /* prima: 1100px */
  margin:0 auto;
  display:grid;
  grid-template-columns: 220px 1fr 220px;  /* prima: 260px 1fr 260px */
  gap:6px;                      /* prima: 28px */
  align-items:start;
  padding-top:10px;
}

/* su schermi molto grandi puoi allargare ancora (opzionale) */
@media (min-width: 1700px){
  #game .gameArea{ max-width:1600px; }
}
#game .sideCol{
  display:flex;
  flex-direction:column;
  gap:26px;
  padding-top:60px;
}
#game .pCard{
  background:#fff;
  border-radius:22px;
  padding:18px 16px;
  box-shadow:0 18px 38px rgba(0,0,0,.14);
  border:4px solid rgba(0,0,0,.06);
  min-height:150px;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  text-align:center;
  opacity:.30;
  transition: opacity .18s ease, transform .18s ease, box-shadow .18s ease, border-color .18s ease;
}

/* ===== GIOCATORI A SINISTRA (colonna) + PI√ô PICCOLI =====
   (modifica richiesta: sposta tutte le card giocatori a sinistra e riducile)
*/

@media (max-width: 980px){
  #game .gameArea{ grid-template-columns:1fr; gap:6px; }
  #game .sideCol{ padding-top:0; flex-direction:row; justify-content:center; flex-wrap:wrap; }
  #game .pCard{ width:170px; min-height:120px; }
}

 

/* Placeholder inside <select> (testo sbiadito finch√© non scegli) */
select.is-placeholder { color:#9aa0a6 !important; }
select option { color:#000; }




/* --- Argomenti: pannello a scomparsa + ricerca --- */
.topicHeaderBtn{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  cursor:pointer;
}
.topicHeaderLeft{display:flex;flex-direction:column;gap:2px}
.topicHeaderTitle{font-weight:700}
.topicHeaderSub{font-size:12px;color:#556;opacity:.85}
.topicChevron{font-size:18px;line-height:1;opacity:.8}
.topicPanel{
  margin-top:8px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  overflow:hidden;
  max-height:0;
  transition:max-height .25s ease;
}
.topicPanel.open{max-height:320px;}
.topicPanelInner{padding:10px}
.topicSearch{
  width:100%;
  padding:10px 10px;
  border:1px solid var(--line);
  border-radius:10px;
  outline:none;
}
.topicActions{
  display:flex;
  gap:8px;
  margin-top:8px;
  flex-wrap:wrap;
}
.topicActions .smallbtn{
  padding:8px 10px;
  font-size:12px;
}
.topicList{
  margin-top:10px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  padding:6px 6px;
  max-height:200px;
  overflow:auto;
}


/* --- Modale incolla JSON (utile su LIM) --- */
.pasteOverlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.6);
  z-index:99999;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:14px;
}
.pasteCard{
  width:min(900px, 96vw);
  background:#fff;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
  padding:14px;
}
.pasteCard h3{margin:0 0 8px}
.pasteArea{
  width:100%;
  min-height:220px;
  resize:vertical;
  border:1px solid var(--line);
  border-radius:12px;
  padding:10px;
  font-family:Consolas, monospace;
  font-size:12px;
  box-sizing:border-box;
}
.pasteActions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin-top:10px}


/* === Pulsante MOSTRA PUNTEGGIO centrale === */
#showScoreBtn{
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  width: 180px;
  height: 180px;
  border-radius: 50%;
  font-size: 1.2em;
  font-weight: 900;
  background: radial-gradient(circle at top left, #ffd84d, #f59e0b);
  color: #3a2500;
  border: none;
  box-shadow: 0 20px 40px rgba(0,0,0,.35);
  display: none;
  align-items: center;
  justify-content: center;
  text-align: center;
  z-index: 9999;
  cursor: pointer;
}
#showScoreBtn:hover{
  transform: translate(-50%, -50%) scale(1.05);
}


/* === Modal "Livello completato" === */
#levelDoneBackdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9998; /* sotto al bottone punteggio (9999) */
}
#levelDoneCard{
  width: min(520px, 92vw);
  background: linear-gradient(135deg, rgba(255,255,255,.98), rgba(255,247,220,.98));
  border-radius: 22px;
  padding: 18px 18px 16px;
  box-shadow: 0 26px 70px rgba(0,0,0,.28);
  border: 1px solid rgba(0,0,0,.06);
  text-align: center;
  transform: scale(.92);
  opacity: 0;
  transition: transform .18s ease, opacity .18s ease;
}
#levelDoneBackdrop.show #levelDoneCard{
  transform: scale(1);
  opacity: 1;
}
#levelDoneTitle{
  font-size: 1.65em;
  font-weight: 1000;
  margin: 4px 0 8px;
}
#levelDoneSubtitle{
  font-size: 1.05em;
  color: #3a3a3a;
  margin: 0 0 12px;
}
#levelDonePills{
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
  margin: 8px 0 10px;
}
.levelPill{
  padding: 8px 12px;
  border-radius: 999px;
  font-weight: 900;
  background: rgba(255,255,255,.8);
  border: 1px solid rgba(0,0,0,.08);
}
#levelDoneActions{
  display:flex;
  gap:10px;
  justify-content:center;
  margin-top: 10px;
}
.levelBtn{
  border: none;
  border-radius: 14px;
  padding: 10px 14px;
  font-weight: 900;
  cursor: pointer;
  box-shadow: 0 12px 26px rgba(0,0,0,.18);
}
#btnLevelOk{
  background: radial-gradient(circle at top left, #60a5fa, #2563eb);
  color: white;
}
#btnLevelScore{
  background: radial-gradient(circle at top left, #ffd84d, #f59e0b);
  color: #3a2500;
}

</style>
<style>
/* --- HOME: nomi giocatori --- */
.namesBox{
  display:grid;
  grid-template-columns: repeat(2, minmax(180px,1fr));
  gap:10px;
  margin-top:6px;
}
.namesBox input{
  width:100%;
  padding:12px 12px;
  border-radius:14px;
  border:2px solid rgba(0,0,0,.08);
  font-weight:800;
  outline:none;
}
.namesBox input:focus{
  border-color: rgba(59,130,246,.55);
}
.hint{ opacity:.75; margin-top:6px; font-size:.92em; }

/* --- GAME: avatar emoji nelle card laterali --- */
#game .pCard .avatar{
  width:70px;
  height:70px;
  border-radius:20px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:44px;
  margin:0 auto 12px;
  background: rgba(0,0,0,.04);
  box-shadow: inset 0 0 0 2px rgba(255,255,255,.75);
}
#game .pCard.active .avatar{
  box-shadow: inset 0 0 0 3px rgba(255,255,255,.80), 0 10px 18px rgba(0,0,0,.10);
}



/* Placeholder inside <select> (testo sbiadito finch√© non scegli) */
select.is-placeholder { color:#9aa0a6 !important; }
select option { color:#000; }




/* --- Argomenti: pannello a scomparsa + ricerca --- */
.topicHeaderBtn{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  cursor:pointer;
}
.topicHeaderLeft{display:flex;flex-direction:column;gap:2px}
.topicHeaderTitle{font-weight:700}
.topicHeaderSub{font-size:12px;color:#556;opacity:.85}
.topicChevron{font-size:18px;line-height:1;opacity:.8}
.topicPanel{
  margin-top:8px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  overflow:hidden;
  max-height:0;
  transition:max-height .25s ease;
}
.topicPanel.open{max-height:320px;}
.topicPanelInner{padding:10px}
.topicSearch{
  width:100%;
  padding:10px 10px;
  border:1px solid var(--line);
  border-radius:10px;
  outline:none;
}
.topicActions{
  display:flex;
  gap:8px;
  margin-top:8px;
  flex-wrap:wrap;
}
.topicActions .smallbtn{
  padding:8px 10px;
  font-size:12px;
}
.topicList{
  margin-top:10px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  padding:6px 6px;
  max-height:200px;
  overflow:auto;
}


/* --- Modale incolla JSON (utile su LIM) --- */
.pasteOverlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.6);
  z-index:99999;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:14px;
}
.pasteCard{
  width:min(900px, 96vw);
  background:#fff;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
  padding:14px;
}
.pasteCard h3{margin:0 0 8px}
.pasteArea{
  width:100%;
  min-height:220px;
  resize:vertical;
  border:1px solid var(--line);
  border-radius:12px;
  padding:10px;
  font-family:Consolas, monospace;
  font-size:12px;
  box-sizing:border-box;
}
.pasteActions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin-top:10px}


/* === Pulsante MOSTRA PUNTEGGIO centrale === */
#showScoreBtn{
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  width: 180px;
  height: 180px;
  border-radius: 50%;
  font-size: 1.2em;
  font-weight: 900;
  background: radial-gradient(circle at top left, #ffd84d, #f59e0b);
  color: #3a2500;
  border: none;
  box-shadow: 0 20px 40px rgba(0,0,0,.35);
  display: none;
  align-items: center;
  justify-content: center;
  text-align: center;
  z-index: 9999;
  cursor: pointer;
}
#showScoreBtn:hover{
  transform: translate(-50%, -50%) scale(1.05);
}


/* === Modal "Livello completato" === */
#levelDoneBackdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9998; /* sotto al bottone punteggio (9999) */
}
#levelDoneCard{
  width: min(520px, 92vw);
  background: linear-gradient(135deg, rgba(255,255,255,.98), rgba(255,247,220,.98));
  border-radius: 22px;
  padding: 18px 18px 16px;
  box-shadow: 0 26px 70px rgba(0,0,0,.28);
  border: 1px solid rgba(0,0,0,.06);
  text-align: center;
  transform: scale(.92);
  opacity: 0;
  transition: transform .18s ease, opacity .18s ease;
}
#levelDoneBackdrop.show #levelDoneCard{
  transform: scale(1);
  opacity: 1;
}
#levelDoneTitle{
  font-size: 1.65em;
  font-weight: 1000;
  margin: 4px 0 8px;
}
#levelDoneSubtitle{
  font-size: 1.05em;
  color: #3a3a3a;
  margin: 0 0 12px;
}
#levelDonePills{
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
  margin: 8px 0 10px;
}
.levelPill{
  padding: 8px 12px;
  border-radius: 999px;
  font-weight: 900;
  background: rgba(255,255,255,.8);
  border: 1px solid rgba(0,0,0,.08);
}
#levelDoneActions{
  display:flex;
  gap:10px;
  justify-content:center;
  margin-top: 10px;
}
.levelBtn{
  border: none;
  border-radius: 14px;
  padding: 10px 14px;
  font-weight: 900;
  cursor: pointer;
  box-shadow: 0 12px 26px rgba(0,0,0,.18);
}
#btnLevelOk{
  background: radial-gradient(circle at top left, #60a5fa, #2563eb);
  color: white;
}
#btnLevelScore{
  background: radial-gradient(circle at top left, #ffd84d, #f59e0b);
  color: #3a2500;
}

</style>


<style>
/* --- AVATAR: immagini personalizzate (una per card) --- */
#game .pCard{ position:relative; }

#game .pCard .avatar{
  width:96px;
  height:96px;
  border-radius:18px;
  margin:0 auto 12px;
  background:#f1f5f9;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
  box-shadow:
    inset 0 0 0 2px rgba(255,255,255,.9),
    0 12px 22px rgba(0,0,0,.15);
}
#game .pCard .avatar img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
}
#game .pCard.active .avatar{
  transform: scale(1.06);
  box-shadow:
    inset 0 0 0 2px rgba(255,255,255,.9),
    0 0 0 6px rgba(0,0,0,.05),
    0 18px 32px rgba(0,0,0,.2);
}



/* Placeholder inside <select> (testo sbiadito finch√© non scegli) */
select.is-placeholder { color:#9aa0a6 !important; }
select option { color:#000; }





/* --- Argomenti: pannello a scomparsa + ricerca --- */
.topicHeaderBtn{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  cursor:pointer;
}
.topicHeaderLeft{display:flex;flex-direction:column;gap:2px}
.topicHeaderTitle{font-weight:700}
.topicHeaderSub{font-size:12px;color:#556;opacity:.85}
.topicChevron{font-size:18px;line-height:1;opacity:.8}
.topicPanel{
  margin-top:8px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  overflow:hidden;
  max-height:0;
  transition:max-height .25s ease;
}
.topicPanel.open{max-height:320px;}
.topicPanelInner{padding:10px}
.topicSearch{
  width:100%;
  padding:10px 10px;
  border:1px solid var(--line);
  border-radius:10px;
  outline:none;
}
.topicActions{
  display:flex;
  gap:8px;
  margin-top:8px;
  flex-wrap:wrap;
}
.topicActions .smallbtn{
  padding:8px 10px;
  font-size:12px;
}
.topicList{
  margin-top:10px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  padding:6px 6px;
  max-height:200px;
  overflow:auto;
}

/* FORZA stile label filtri ovunque */
.filterLabel{
  font-size: 15px;
  color: #000 !important;
  font-weight: 700 !important;
  margin-bottom: 4px;
}

.filterLabel .filterHint,
.filterHint{
  color: #000 !important;
  font-weight: 700 !important;
  opacity: 1 !important;
}


/* --- Modale incolla JSON (utile su LIM) --- */
.pasteOverlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.6);
  z-index:99999;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:14px;
}
.pasteCard{
  width:min(900px, 96vw);
  background:#fff;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
  padding:14px;
}
.pasteCard h3{margin:0 0 8px}
.pasteArea{
  width:100%;
  min-height:220px;
  resize:vertical;
  border:1px solid var(--line);
  border-radius:12px;
  padding:10px;
  font-family:Consolas, monospace;
  font-size:12px;
  box-sizing:border-box;
}
.pasteActions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin-top:10px}


/* === Pulsante MOSTRA PUNTEGGIO centrale === */
#showScoreBtn{
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  width: 180px;
  height: 180px;
  border-radius: 50%;
  font-size: 1.2em;
  font-weight: 900;
  background: radial-gradient(circle at top left, #ffd84d, #f59e0b);
  color: #3a2500;
  border: none;
  box-shadow: 0 20px 40px rgba(0,0,0,.35);
  display: none;
  align-items: center;
  justify-content: center;
  text-align: center;
  z-index: 9999;
  cursor: pointer;
}
#showScoreBtn:hover{
  transform: translate(-50%, -50%) scale(1.05);
}


/* === Modal "Livello completato" === */
#levelDoneBackdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9998; /* sotto al bottone punteggio (9999) */
}
#levelDoneCard{
  width: min(520px, 92vw);
  background: linear-gradient(135deg, rgba(255,255,255,.98), rgba(255,247,220,.98));
  border-radius: 22px;
  padding: 18px 18px 16px;
  box-shadow: 0 26px 70px rgba(0,0,0,.28);
  border: 1px solid rgba(0,0,0,.06);
  text-align: center;
  transform: scale(.92);
  opacity: 0;
  transition: transform .18s ease, opacity .18s ease;
}
#levelDoneBackdrop.show #levelDoneCard{
  transform: scale(1);
  opacity: 1;
}
#levelDoneTitle{
  font-size: 1.65em;
  font-weight: 1000;
  margin: 4px 0 8px;
}
#levelDoneSubtitle{
  font-size: 1.05em;
  color: #3a3a3a;
  margin: 0 0 12px;
}
#levelDonePills{
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
  margin: 8px 0 10px;
}
.levelPill{
  padding: 8px 12px;
  border-radius: 999px;
  font-weight: 900;
  background: rgba(255,255,255,.8);
  border: 1px solid rgba(0,0,0,.08);
}
#levelDoneActions{
  display:flex;
  gap:10px;
  justify-content:center;
  margin-top: 10px;
}
.levelBtn{
  border: none;
  border-radius: 14px;
  padding: 10px 14px;
  font-weight: 900;
  cursor: pointer;
  box-shadow: 0 12px 26px rgba(0,0,0,.18);
}
#btnLevelOk{
  background: radial-gradient(circle at top left, #60a5fa, #2563eb);
  color: white;
}
#btnLevelScore{
  background: radial-gradient(circle at top left, #ffd84d, #f59e0b);
  color: #3a2500;
}

</style>


<style>
/* ====== MODAL PUNTEGGIO (CENTRALE, ACCATTIVANTE) ====== */
.scoreOverlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 18px;
  z-index: 99999;
}
.scoreModal{
  width: min(720px, 96vw);
  background: #ffffff;
  border-radius: 22px;
  box-shadow: 0 24px 60px rgba(0,0,0,.25);
  padding: 18px 18px 16px;
  border: 1px solid rgba(255,255,255,.35);
}
.scoreTitle{
  font-size: 1.35em;
  font-weight: 900;
  letter-spacing: .2px;
  margin: 4px 0 2px;
}
.scoreSub{
  font-size: .98em;
  color: #334155;
  margin-bottom: 12px;
}
.winnersWrap{
  display: grid;
  grid-template-columns: 1fr;
  gap: 10px;
  margin: 10px 0 14px;
}
@media (min-width: 560px){
  .winnersWrap{ grid-template-columns: 1fr 1fr; }
}
.winnerBig{
  display:flex;
  align-items:center;
  gap: 12px;
  padding: 12px;
  border-radius: 18px;
  background: linear-gradient(135deg, rgba(14,165,233,.14), rgba(34,197,94,.12));
  border: 2px solid rgba(0,0,0,.06);
  box-shadow: inset 0 0 0 2px rgba(255,255,255,.6);
}
.winnerAvatar{
  width: 64px;
  height: 64px;
  border-radius: 18px;
  overflow: hidden;
  background: rgba(255,255,255,.7);
  border: 2px solid rgba(0,0,0,.08);
  display:flex;
  align-items:center;
  justify-content:center;
}
.winnerAvatar img{
  width:100%;
  height:100%;
  object-fit: cover;
  display:block;
}
.winnerAvatarFallback{
  font-weight: 900;
  font-size: 1.6em;
  color:#111;
}
.winnerName{
  font-weight: 900;
  font-size: 1.08em;
  text-align:left;
}
.winnerPts{
  font-weight: 900;
  font-size: 1.18em;
  text-align:left;
  margin-top: 4px;
}
.scoreList{
  background: #f8fafc;
  border: 1px solid rgba(0,0,0,.06);
  border-radius: 18px;
  padding: 10px;
}
.scoreRow{
  display:flex;
  align-items:center;
  gap: 10px;
  padding: 8px 8px;
  border-radius: 14px;
}
.scoreRow + .scoreRow{ margin-top: 6px; }
.scoreRow.isWinner{
  background: linear-gradient(135deg, rgba(250,204,21,.25), rgba(250,204,21,.08));
  border: 2px solid rgba(250,204,21,.55);
}
.miniAvatar{
  width: 34px;
  height: 34px;
  border-radius: 12px;
  overflow: hidden;
  border: 2px solid rgba(0,0,0,.10);
  background: #fff;
  display:flex;
  align-items:center;
  justify-content:center;
  flex: 0 0 auto;
}
.miniAvatar img{
  width:100%;
  height:100%;
  object-fit: cover;
  display:block;
}
.miniAvatar span{ font-weight: 900; }
.miniName{
  flex: 1 1 auto;
  text-align:left;
  font-weight: 800;
}
.miniPts{
  flex: 0 0 auto;
  font-weight: 900;
  min-width: 64px;
  text-align:right;
}
.scoreActions{
  margin-top: 12px;
  display:flex;
  justify-content:center;
}

/* === Pulsante MOSTRA PUNTEGGIO centrale === */
#showScoreBtn{
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  width: 180px;
  height: 180px;
  border-radius: 50%;
  font-size: 1.2em;
  font-weight: 900;
  background: radial-gradient(circle at top left, #ffd84d, #f59e0b);
  color: #3a2500;
  border: none;
  box-shadow: 0 20px 40px rgba(0,0,0,.35);
  display: none;
  align-items: center;
  justify-content: center;
  text-align: center;
  z-index: 9999;
  cursor: pointer;
}
#showScoreBtn:hover{
  transform: translate(-50%, -50%) scale(1.05);
}


/* === Modal "Livello completato" === */
#levelDoneBackdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9998; /* sotto al bottone punteggio (9999) */
}
#levelDoneCard{
  width: min(520px, 92vw);
  background: linear-gradient(135deg, rgba(255,255,255,.98), rgba(255,247,220,.98));
  border-radius: 22px;
  padding: 18px 18px 16px;
  box-shadow: 0 26px 70px rgba(0,0,0,.28);
  border: 1px solid rgba(0,0,0,.06);
  text-align: center;
  transform: scale(.92);
  opacity: 0;
  transition: transform .18s ease, opacity .18s ease;
}
#levelDoneBackdrop.show #levelDoneCard{
  transform: scale(1);
  opacity: 1;
}
#levelDoneTitle{
  font-size: 1.65em;
  font-weight: 1000;
  margin: 4px 0 8px;
}
#levelDoneSubtitle{
  font-size: 1.05em;
  color: #3a3a3a;
  margin: 0 0 12px;
}
#levelDonePills{
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
  margin: 8px 0 10px;
}
.levelPill{
  padding: 8px 12px;
  border-radius: 999px;
  font-weight: 900;
  background: rgba(255,255,255,.8);
  border: 1px solid rgba(0,0,0,.08);
}
#levelDoneActions{
  display:flex;
  gap:10px;
  justify-content:center;
  margin-top: 10px;
}
.levelBtn{
  border: none;
  border-radius: 14px;
  padding: 10px 14px;
  font-weight: 900;
  cursor: pointer;
  box-shadow: 0 12px 26px rgba(0,0,0,.18);
}
#btnLevelOk{
  background: radial-gradient(circle at top left, #60a5fa, #2563eb);
  color: white;
}
#btnLevelScore{
  background: radial-gradient(circle at top left, #ffd84d, #f59e0b);
  color: #3a2500;
}

/* =========================
   FIX MOBILE (smartphone)
   ========================= */
@media (max-width: 768px) {

  /* Permetti scroll verticale */
  body,
  body.noScroll {
    overflow-y: auto !important;
  }

  /* Il gioco NON deve avere altezza fissa su mobile */
  #game.active {
    height: auto !important;
    overflow: visible !important;
  }

  /* Riduci leggermente la scala per far stare tutto */
  #game.active .card {
    max-height: none !important;
  }

  /* Media meno invadenti */
  #game #qImg,
  #game #qVideo {
    max-height: 22vh;
  }

}



/* CERCA DOMANDA */
.row-full{
  max-width: 1100px;   /* uguale alle card */
}

/* --- Evidenzia barra CERCA DOMANDA --- */
.searchRow{
  max-width:1100px;
  background:#f8fafc;              /* grigio chiarissimo */
  border:1px solid #e5e7eb;
  border-radius:16px;
  padding:14px 14px 10px;
  box-shadow:0 4px 10px rgba(0,0,0,.04);
}

/* input leggermente pi√π "importante" */
.searchRow input[type="text"]{
  background:#ffffff;
  border:2px solid #cfd6dc;
  font-size:1.05em;
}

/* focus ben visibile */
.searchRow input[type="text"]:focus{
  outline:none;
  border-color:#60a5fa;
  box-shadow:0 0 0 3px rgba(96,165,250,.25);
}


/* ===== Modalit√† LIM (attiva con ?lim=1) ===== */
body.lim{
  overflow: hidden !important;   /* niente scroll */
  touch-action: manipulation;
}

/* un ‚Äúframe‚Äù che entra sempre nello schermo */
.lim-stage{
  width: 100vw;
  height: 100vh;
  display: grid;
  place-items: center;
  overflow: hidden;
}

/* contenitore del tuo gioco dentro cui tutto scala */
.lim-fit{
  width: 1920px;   /* base 16:9 */
  height: 1080px;
  transform-origin: center center;
}

</style>


  <!-- jsPDF (per esportazione PDF) -->
  <script src="libs/jspdf.umd.min.js"></script>
  <script>
    // fallback online se non hai il file in locale
    if(typeof window.jspdf==="undefined" && typeof window.jsPDF==="undefined"){
      const s=document.createElement("script");
      s.src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js";
      s.referrerPolicy="no-referrer";
      document.head.appendChild(s);
    }
  </script>


<style id="fix-archive-header-align-only">
/* FIX SOLO ARCHIVIO DOMANDE: header allineato alle righe quando scegli un livello (tbody con scrollbar) */
#libWrap table.level-only,
#libWrap table.levelTable{
  --sbw: 0px; /* scrollbar width */
}

/* Riduci la larghezza dell'header della misura della scrollbar del tbody */
#libWrap table.level-only thead,
#libWrap table.levelTable thead{
  width: calc(100% - var(--sbw));
}
</style>

<style id="qm-exit-modal-style">
/* === Modale uscita dal gioco (stile popup password) === */
#qmExitOverlay{
  position: fixed;
  inset: 0;
  z-index: 999999; /* sopra tutto */
  background: rgba(0,0,0,.60);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 14px;
}
#qmExitCard{
  width: min(520px, 96vw);
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 12px 34px rgba(0,0,0,.25);
  padding: 14px;
  text-align: left;
}
#qmExitTitle{
  font-weight: 900;
  font-size: 18px;
  margin-bottom: 6px;
}
#qmExitText{
  color:#556;
  margin-bottom: 12px;
}
#qmExitActions{
  display:flex;
  gap:10px;
  justify-content:space-between; /* NO a sinistra, S√å a destra */
  margin-top: 12px;
}

/* bottoni: usa classi esistenti se presenti, altrimenti fallback */
.qmExitBtn{
  border: none;
  border-radius: 12px;
  padding: 10px 14px;
  font-weight: 900;
  cursor: pointer;
}
.qmExitNo{
  background: #e5e7eb;
  color: #111827;
}
.qmExitYes{
  background: #22c55e;
  color: #08350f;
}
</style>


<style id="zoomPatch">
  /* === Zoom solo nel GAME (domanda/risposte/bottone) === */
  #game #zoomTarget{
    transform-origin: top center;
  }
  
</style>

<style id="players-clean-css">
/* =========================
   PLAYER CARDS (CLEAN, NO DUPLICATES)
   - Smartphone: players in a row above question
   - Desktop/LIM: players on the left column, compact square cards
   - Special 917x703: 2 cards per row on the left to avoid overlap
========================= */

/* CARD GIOCATORE ATTIVA PULSA */
#game .p1{ color:var(--p1); }
#game .p2{ color:var(--p2); }
#game .p3{ color:var(--p3); }
#game .p4{ color:var(--p4); }



@keyframes pulseBorder {
  0% {
    box-shadow: 0 0 0 0 currentColor;
  }
  70% {
    box-shadow: 0 0 0 14px transparent;
  }
  100% {
    box-shadow: 0 0 0 0 transparent;
  }
}


/* Base (all devices) */
#game .pCard{
  background:#fff;
  border-radius:18px;
  padding:10px;
  box-shadow:0 10px 22px rgba(0,0,0,.12);
  border:3px solid rgba(0,0,0,.06);
  min-height: unset;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  text-align:center;
  opacity:.35;
  transition: opacity .18s ease, transform .18s ease, box-shadow .18s ease, border-color .18s ease;
  margin: 10px;
}
#game .pCard.active{
  opacity:1;
  transform: scale(1.05);
  border-color: currentColor;
  box-shadow:
    0 0 0 4px currentColor,
    0 0 18px currentColor;
  animation: pulseBorder 1.4s infinite;
}


#game .pCard .avatar{
  width:52px;
  height:52px;
  border-radius:8px;
  overflow:hidden;
  margin:0 auto 8px;
}
#game .pCard .avatar img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
}
#game .pCard .pName{ font-weight:900; font-size:14px; }
#game .pCard .pPts{  font-weight:900; font-size:18px; margin-top:6px; }

/* SMARTPHONE: players in a single row above */
@media (max-width: 768px){
  #game .gameArea{
    grid-template-columns: 1fr !important;
    grid-template-rows: auto 1fr;
    gap: 6px !important;
  }
  #game #leftCol{
    order: 0;
    display:flex !important;
    flex-direction:row !important;
    flex-wrap:nowrap !important;
    gap:8px !important;
    padding:8px 6px !important;
    overflow-y:hidden;
    -webkit-overflow-scrolling:touch;
  }
  #game #rightCol{ display:none !important; }
  #game .centerCol{ order: 1; }

  #game .pCard{
    width:70px !important;
    aspect-ratio: 1 / 1 !important;
    padding:4px !important;
    border-radius:14px !important;
    margin: 0px;
  }
  #game .pCard .avatar{
    width:42px !important;
    height:42px !important;
    border-radius:12px !important;
    margin:0 auto 6px !important;
  }
  #game .pCard .pName{ font-size:11px !important; }
  #game .pCard .pPts{  font-size:14px !important; margin-top:2px !important; }
}

/* DESKTOP/LIM: players on the left, compact */
/* DESKTOP/LIM: giocatori 2 per riga */
@media (min-width: 769px){
  #game .gameArea{
    grid-template-columns: 300px 1fr !important; /* serve spazio per 2 card */
     gap: 6px !important;
  }

  #game #leftCol{
    display:grid !important;                         /* OVERRIDE di .sideCol */
    grid-template-columns: repeat(2, minmax(0,1fr)) !important;
    gap:10px !important;
    padding:10px 6px !important;
    align-content:start;
  }

  #game .pCard{
    width:auto !important;                           /* prende la cella */
  }
}

/* FIX 917x703 (and similar): 2 per row on the left */
@media (min-width: 769px) and (max-width: 980px) and (max-height: 740px){
  #game .gameArea{
    grid-template-columns: 300px 1fr !important;
    gap: 6px !important;
    max-width: 100% !important;
  }
  #game #leftCol{
    display:grid !important;
    grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
    gap: 10px !important;
    padding-top: 10px !important;
  }
  #game .pCard{
    width:auto !important;
    aspect-ratio: 1 / 1 !important;
    padding:8px !important;
  }
  #game .pCard .avatar{
    width:44px !important;
    height:44px !important;
    margin:0 auto 6px !important;
  }
  #game .pCard .pName{ font-size:12px !important; }
  #game .pCard .pPts{  font-size:16px !important; }
  #game .centerCol .card{
    max-width:none !important;
    width:100% !important;
    margin:0 !important;
  }
}
</style>
</head>

<body>

<!-- HOME -->
<div class="screen active" id="home">
<!--   
<h1>üéÆ Scegli le domande per giocare</h1>
<p>Primaria ‚Ä¢ scegli <b>classe</b>, <b>disciplina</b> e <b>difficolt√†</b></p>
-->
<div class="card playSection">
<h2>üé≤ GIOCHIAMO INSIEME</h2>
<div class="row">
<div class="col">
<label class="filterLabel" for="selClass">CLASSE <span class="filterHint">Seleziona classe</span></label>
<select id="selClass">
    <option value="" selected disabled hidden>Seleziona classe</option>

<option value="3">3¬™ primaria</option>
<option value="4">4¬™ primaria</option>
<option value="5">5¬™ primaria</option>
</select>
</div>
<div class="col">
<label class="filterLabel" for="selSubject">DISCIPLINA <span class="filterHint">Seleziona disciplina</span></label>
<select id="selSubject">
    <option value="" selected disabled hidden>Seleziona disciplina</option>

<option value="storia">Storia</option>
<option value="geografia">Geografia</option>
<option value="italiano">Italiano</option>
<option value="scienze">Scienze</option>
<option value="matematica">Matematica</option>
</select>
</div>
<div class="col">
<label class="filterLabel" for="selLevel">LIVELLO <span class="filterHint">Seleziona livello</span></label>
<select id="selLevel">
    <option value="" selected disabled hidden>Seleziona difficolt√†</option>
        <option value="ALL">Tutti i livelli</option>

<option value="facile">Facile</option>
<option value="medio">Medio</option>
<option value="difficile">Difficile</option>
</select>
</div>
<div class="col">
<label for="selPlayers">GIOCATORI</label>
<select id="selPlayers">
<option value="1">1 giocatore</option>
<option value="2">2 giocatori</option>
<option value="3">3 giocatori</option>
<option value="4">4 giocatori</option>
</select>
</div>

      <div class="col" style="width:100%">
        <label>NOMI SQUADRE / GIOCATORI</label>
        <div id="playerNamesBox" class="namesBox">
          <input id="pName1" placeholder="Team Blu" value="Team Blu">
          <input id="pName2" placeholder="Team Gialli" value="Team Gialli" style="display:none">
          <input id="pName3" placeholder="Team Viola" value="Team Viola" style="display:none">
          
          <input id="pName4" placeholder="Team Fucsia" value="Team Fucsia" style="display:none">
        </div>
        <div class="hint">Scegli quanti giocatori e personalizza i nomi (es. Team Blu, Team Rossi...).</div>
      </div>

</div>

<div class="topicConfig" id="topicConfig">
  <h3 style="margin:6px 0 6px">üî¢ Configura domande</h3>
  <div class="topicRow row">
    <div class="col">
      <label class="filterLabel" for="selNumQ">NUMERO DOMANDE <span class="filterHint">Totale</span></label>
      <select id="selNumQ">
        <option value="5">5</option>
        <option value="10" selected>10</option>
        <option value="15">15</option>
        <option value="20">20</option>
      </select>
      <div class="smallnote">Scegli quante domande fare in questa partita.</div>
    </div>
    <div class="col">
      
<label class="filterLabel">ARGOMENTI <span class="filterHint">scegli e cerca</span></label>
<div id="topicCounts" class="filterCounts"></div>

<button type="button" class="topicHeaderBtn" id="topicHeaderBtn" onclick="toggleTopicPanel()">
  <div class="topicHeaderLeft">
    <div class="topicHeaderTitle">Seleziona argomenti</div>
    <div class="topicHeaderSub" id="topicSummary">Seleziona prima classe, disciplina e livello‚Ä¶</div>
  </div>
  <div class="topicChevron" id="topicChevron">‚ñæ</div>
</button>

<div class="topicPanel" id="topicPanel">
  <div class="topicPanelInner">
    <input id="topicSearch" class="topicSearch" type="text" placeholder="Cerca argomento‚Ä¶">
    <div class="topicActions">
      <button type="button" class="smallbtn" onclick="selectAllTopics(true)">Seleziona tutti</button>
      <button type="button" class="smallbtn" onclick="selectAllTopics(false)">Deseleziona tutti</button>
      <button type="button" class="smallbtn" onclick="resetTopicPrefs()">Tutti gli argomenti</button>
    </div>
    <div id="topicChecklist" class="topicList">
      <div class="topicCount">Seleziona prima classe, disciplina e livello‚Ä¶</div>
    </div>
    <div class="smallnote">Se non spunti nulla, verranno usati tutti gli argomenti disponibili.</div>
  </div>
</div>

    </div>
  </div>
</div>



<!-- SELEZIONE DOMANDE (come Archivio) -->
<div class="card" id="pickCard" style="text-align:left;margin-top:14px">
  <div style="display:flex;justify-content:space-between;align-items:flex-end;gap:10px;flex-wrap:wrap">
    <div>
      <div style="font-weight:900;letter-spacing:.2px">SELEZIONA LE DOMANDE</div>
      <div class="smallnote" style="margin-top:2px">Opzionale: se spunti una o pi√π domande, giocherai SOLO con quelle.</div>
    </div>
    <div class="tiny"  style="border: #000;"    id="pickSelInfo">Selezionate: <span id="pickSelCount">0</span> <button class="smallbtn" id="clearPickedBtn" type="button" title="Svuota selezione domande" onclick="clearPickedQuestions()" style="margin-left:6px;padding:6px 10px;border-radius:10px">üßπ</button></div>
  </div>

  <div class="row row-full searchRow" style="margin-top:10px">
    <div class="col">
      <label>CERCA DOMANDA</label>
      <div class="searchWrap">
        <input id="pickSearch" type="text" placeholder="Cerca nella domanda, opzioni, argomento..." oninput="renderPickQuestions()" />
        <span class="clearSearchBtn" onclick="clearPickSearch()" title="Cancella ricerca">√ó</span>
      </div>
    </div>
  </div>

  <div class="topicChipsRow" id="topicChipsRow"></div>
<div id="pickWrap" style="margin-top:10px"></div>

  <div class="smallnote" style="margin-top:8px">
    Se non selezioni nessuna domanda, il gioco user√† la selezione per argomenti.
  </div>
</div>

<div style="display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap">
<button class="smallbtn" type="button" onclick="resetGameFilters()" title="Azzera tutti i filtri">‚ôªÔ∏è Azzera filtri</button>
<button class="btn primary" onclick="startGame()">‚ñ∂Ô∏è GIOCA</button>
</div>
<div class="hint">
      Suggerimento: in classe usa LIM/PC. Sul telefono funziona benissimo per ripasso.
    </div>
</div>
</div>
<!-- GAME -->
<div class="screen" id="game">
<div class="topbar">
  
<span class="pill" id="pillMeta" style="display:none" >‚Äî</span>
<span class="pill" id="pillTurn" style="display:none">Turno: G1</span>


<span class="pill" id="pillScore" style="display:none">Punti: 0</span> 
<button class="smallbtn" id="showScoreBtn" onclick="revealScore()" style="display:none">üèÜ<br>MOSTRA<br>PUNTEGGIO</button>


  <button class="smallbtn" type="button" onclick="zoomStep(-1)">‚ûñ</button>
  <button class="smallbtn" type="button" onclick="zoomReset()">100%</button>
  <button class="smallbtn" type="button" onclick="zoomStep(1)">‚ûï</button>
  <span class="pill" id="zoomLabel" style="min-width:92px">Zoom: 100%</span>

  <span class="pill" id="pillCount">Domanda 0/0</span>
<button class="smallbtn" id="btnBackIndex" type="button" onclick="goBackIndex()">‚Ü©Ô∏è Index</button>
</div>

<div class="gameArea">
  
<div class="sideCol" id="leftCol">
   <div class="pCard p1" id="cardP1"></div><div class="pCard p2" id="cardP2"></div>
   <div class="pCard p3" id="cardP3"></div>
</div>

<div class="centerCol">
  <div class="card" id="zoomTarget"">
<img alt="immagine domanda" id="qImg" style="display:none"/>
<video controls="" id="qVideo" playsinline="" style="display:none"></video>
<div class="hint" id="qTopic" style="text-align:left"></div>
<h2 id="qText" style="text-align:left"></h2>
<div id="optionsWrap"></div>
<div id="feedback"></div>
<button class="btn option" id="nextBtn" onclick="nextQuestion()">‚û°Ô∏è Prossima</button>
</div></div>

<div class="sideCol" id="rightCol">
  <div class="pCard p3" id="cardP3"></div>
  <div class="pCard p4" id="cardP4"></div>
</div>
</div>
</div>


<!-- TEACHER -->
<div class="screen" id="teacher">
<!-- <div class="topbar">
<span class="pill">üßë‚Äçüè´ Area Docente</span>
<button class="smallbtn" onclick="goHome()">üè† Home</button>
</div>
-->
<div class="card archive-filters" style="text-align:left">
<h2 style="text-align:center;margin-top:0">Inserisci una domanda</h2>
<div class="split" style="margin:10px 0 14px">
<button class="btn soft" onclick="importQuestionsJSON()">üì• Importa domande (JSON)</button>
    <button class="btn soft" onclick="importQuestionsJS()">üì• Importa domande (JS)</button>
    <button class="btn soft" onclick="openPasteJSON('questions')">üìã Incolla domande (JSON)</button>
<button class="btn soft" onclick="exportJSON()">üì§ Esporta archivio (JSON)</button>


</div>
<div class="split" style="margin:0 0 14px">
<button class="btn soft" onclick="exportFullBackup()">‚òÅÔ∏è Export totale (backup)</button>
<button class="btn soft" onclick="importFullBackup()">‚òÅÔ∏è Import totale (ripristina)</button>
</div>
<div class="doc-card card-context"><h3>üü¶ Contesto</h3><div class="subhint">Dove andr√† la domanda (classe, disciplina, livello, argomento).</div>
<div class="row">
<div class="col">
<label class="filterLabel">CLASSE <span class="filterHint">Seleziona classe</span></label>
<select id="tClass" onchange="refreshTopicSuggestions()">
    <option value="" disabled hidden>Seleziona classe</option>

<option value="3">3¬™ primaria</option>
<option value="4">4¬™ primaria</option>
<option value="5">5¬™ primaria</option>
</select>
</div>
<div class="col">
<label class="filterLabel">DISCIPLINA <span class="filterHint">Seleziona disciplina</span></label>
<select id="tSubject" onchange="refreshTopicSuggestions()">
    <option value="" disabled hidden>Seleziona disciplina</option>

<option value="storia">Storia</option>
<option value="geografia">Geografia</option>
<option value="italiano">Italiano</option>
<option value="scienze">Scienze</option>
<option value="matematica">Matematica</option>
</select>
</div>
<div class="col">
<label class="filterLabel">DIFFICOLT√Ä <span class="filterHint">Seleziona livello</span></label>
<select id="tLevel">
    <option value="" disabled hidden>Seleziona difficolt√†</option>

<option value="facile">Facile</option>
<option value="medio">Medio</option>
<option value="difficile">Difficile</option>
</select>
</div>
</div>
<label>ARGOMENTO (es. Paleolitico, Linea del tempo...)</label>
<input id="tTopic" list="topicSuggestions" autocomplete="off" placeholder="Scrivi un argomento breve" type="text"/>
<datalist id="topicSuggestions"></datalist>
<div class="subhint" style="margin-top:6px">‚úÖ Puoi associare la domanda anche ad altri argomenti, cos√¨ la ritrovi in pi√π card.</div>
<label style="margin-top:8px">ARGOMENTI SECONDARI (multi‚Äëselect)</label>
<select id="tTopicsExtra" multiple size="6" style="width:100%; padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.08); color:inherit;">
</select>
<div class="subhint">Suggerimento: tieni premuto <b>Ctrl</b> (Windows) o <b>Cmd</b> (Mac) per selezioni multiple.</div>
</div><!-- /card-question -->
<div class="doc-card card-media"><h3>üü© Media (facoltativo)</h3><div class="subhint">Trascina un‚Äôimmagine o un video. Percorso consigliato: img/‚Ä¶ oppure video/‚Ä¶</div>
<label>MEDIA (immagine o video) ‚Ä¢ opzionale</label>
<div class="row">
<div class="col">
<label style="font-weight:700;margin-top:0">Tipo</label>
<select id="tMediaType">
<option value="none">Nessuno</option>
<option value="image">Immagine</option>
<option value="video">Video</option>
</select>
</div>
<div class="col">
<label style="font-weight:700;margin-top:0">Percorso (relativo)</label>
<input id="tMediaPath" placeholder="es. img/storia/nome_immagine.png  oppure  video/storia/nome_video.mp4" type="text"/>
<div class="tiny">Consiglio cartelle: <b>img/{disciplina}/</b> per immagini ‚Ä¢ <b>video/{disciplina}/</b> per video.</div>
</div>
</div>
<div class="dropzone" id="mediaDrop">
      üìÅ Trascina qui un file (immagine o video) dalla tua cartella<br/>
<span class="tiny">Il browser non pu√≤ leggere il ‚Äúpercorso‚Äù del tuo PC: salviamo solo il <b>nome file</b> e costruiamo il percorso (es. img/storia/<i>file.png</i>).</span>
</div>
<div class="preview" id="mediaPreview" style="display:none"></div>
</div><!-- /card-context -->
<div class="doc-card card-question"><h3>üü® Domanda</h3><div class="subhint">Scrivi la domanda e le opzioni.</div>
<label>DOMANDA</label>
<textarea id="tQuestion" placeholder="Scrivi la domanda..."></textarea>
<div id="tOptionsWrap"></div>

<div class="row" style="margin-top:8px">
  <div class="col">
    <button type="button" class="smallbtn" onclick="addTeacherOption()">‚ûï Aggiungi risposta</button>
  </div>
  <div class="col">
    <button type="button" class="smallbtn" onclick="removeTeacherOption()">‚ûñ Rimuovi ultima</button>
  </div>
</div>
<label>RISPOSTA CORRETTA</label>
<select id="tCorrect" onchange="highlightCorrectTeacherOption()">
<option value="0">A</option>
<option value="1">B</option>
</select>
<label>PUNTEGGIO (5 / 10 / 20)</label>
<select id="tPoints">
<option value="5">+5</option>
<option selected="" value="10">+10</option>
<option value="20">+20</option>
</select>
</div><!-- /card-media -->
<div class="doc-card card-explain"><h3>üü™ Spiegazione</h3><div class="subhint">Messaggio breve che apparir√† dopo la risposta.</div>
<label>SPIEGAZIONE (breve, per feedback)</label>
<textarea id="tExplain" placeholder="Esempio: Nel Paleolitico si seguiva il cibo e ci si spostava spesso."></textarea>
</div><!-- /card-explain -->
<div class="hint" id="teacherMode" style="margin:0 0 10px 0; text-align:center; font-weight:700;">
  Modalit√†: <span id="teacherModeText">Nuova domanda</span>
</div>
<div class="doc-actions">
<button class="btn primary" id="btnSave" onclick="saveQuestion()">üíæ Salva domanda</button>
<button class="btn soft" id="btnCancelEdit" onclick="cancelEdit()" style="display:none">‚Ü©Ô∏è Annulla modifica</button>
<button class="btn soft" onclick="clearForm()">üßπ Pulisci campi</button>
<button class="btn danger" onclick="resetAll()">üóëÔ∏è Cancella TUTTO l‚Äôarchivio (attenzione)</button>
</div><!-- /doc-actions -->
<div class="hint" style="margin-top:10px">
      Le domande vengono salvate sul dispositivo (localStorage). Se cambi telefono/PC, l‚Äôarchivio non si sposta automaticamente.
    </div>
</div>
</div>
<!-- LIBRARY -->
<div class="screen" id="library">

  <!-- 
<div class="topbar">
<span class="pill">üìö Archivio Domande</span>
<button class="smallbtn" onclick="goHome()">üè† Home</button>
</div>
-->
<div class="card" style="text-align:left">
<h2 style="text-align:center;margin-top:0">Filtra e gestisci</h2>
<div class="row">
<div class="col">
<label>CLASSE</label>
<select id="fClass">
    <option value="" disabled hidden>Seleziona classe</option>

<option value="all">Tutte</option>
<option value="3">3¬™ primaria</option>
<option value="4">4¬™ primaria</option>
<option value="5">5¬™ primaria</option>
</select>
</div>
<div class="col">
<label>DISCIPLINA</label>
<select id="fSubject">
    <option value="" disabled hidden>Seleziona disciplina</option>

<option value="all">Tutte</option>
<option value="storia">Storia</option>
<option value="geografia">Geografia</option>
<option value="italiano">Italiano</option>
<option value="scienze">Scienze</option>
<option value="matematica">Matematica</option>
</select>
</div>
<div class="col">
<label>DIFFICOLT√Ä</label>
<select id="fLevel">
    <option value="" disabled hidden>Seleziona difficolt√†</option>
        <option value="ALL">Tutti i livelli</option>

<option value="all">Tutte</option>
<option value="facile">Facile</option>
<option value="medio">Medio</option>
<option value="difficile">Difficile</option>
</select>
</div>
</div>


<div class="row">
  <div class="col" style="flex:1">
    <label>ARGOMENTO</label>
    <button type="button" class="smallbtn" style="width:100%;text-align:left" onclick="toggleLibTopicPanel()">
      ARGOMENTI scegli e cerca <span id="libTopicInfo" class="tag" style="float:right">Tutti</span>
    </button>
    <div id="libTopicPanel" class="topicPanel">
      <div class="topicPanelInner">
        <input id="libTopicSearch" class="topicSearch" type="text" placeholder="Cerca argomento..." oninput="renderLibTopicList()" />
        <div class="topicActions">
          <button type="button" class="smallbtn" onclick="libClearTopicFilter()">üßπ Nessun filtro</button>
          <button type="button" class="smallbtn" onclick="toggleLibTopicPanel()">Chiudi</button>
        </div>
        <div id="libTopicList" class="topicList"></div>
        <div class="tiny">Se non selezioni nulla, vengono mostrati tutti gli argomenti.</div>
      </div>
    </div>
  </div>
</div>

<div class="archiveActions">
<div class="archiveRowButtons">
  <button class="smallbtn" type="button" onclick="resetArchiveFilters()">
    ‚ôªÔ∏è Azzera filtri
  </button>

  <button class="btn soft" onclick="renderLibrary()">
    üîé Applica filtri
  </button>
</div>



<div class="archiveRowButtons">
<button class="btn soft" onclick="exportQuestionsJS()">üì¶ Esporta questions.js (per LIM)</button>
<!-- <button class="btn soft" onclick="exportJSON()">‚¨áÔ∏è Esporta JSON</button> -->
<button class="btn" type="button" onclick="exportSelectedQuestionsPDF()">  üìÑ Esporta PDF </button>
<button class="btn danger" onclick="deleteSelectedLibrary()">
  üóëÔ∏è Elimina selezionate
</button>
<span id="libSelectedCount" style="margin-left:10px;opacity:.8;margin-top: 28px;font-weight: bold;">Selezionate: 0</span>
<button class="btn" type="button" onclick="clearLibrarySelection()" style="margin-left:8px">
  üßπ Svuota selezione
</button>
</div>
</div>

<div class="row row-full searchRow">
  <div class="col">
    <label>CERCA DOMANDA</label>
    <div class="searchWrap">
<input
      id="fSearch"
      type="text"
      placeholder="Cerca nella domanda, opzioni, argomento..."
      oninput="renderLibrary()"
    />
<span class="clearSearchBtn" onclick="clearArchiveSearch()" title="Cancella ricerca">√ó</span>
</div>
  </div>
</div>

<div id="libWrap" style="margin-top:10px"></div>
</div>
</div>





  <!-- Domande offline: carica questions.js dalla stessa cartella (come nella Ruota) -->
  <script src="questions.js"></script>
<script>

function goBackIndex(){
  const params = new URLSearchParams(window.location.search);
  const classe = params.get("classe") || "";
  const disciplina = params.get("disciplina") || "";

  const url = new URL("index_quiz.html", window.location.href);

  if(classe) url.searchParams.set("classe", classe);
  if(disciplina) url.searchParams.set("disciplina", disciplina);

  window.location.href = url.toString();
}


const params = new URLSearchParams(location.search);

const disciplina = params.get("disciplina");
const argomento  = params.get("argomento");
const livello    = params.get("livello");
const players    = params.get("players") || 1;
const numQParam  = params.get("numQ");

// topics pu√≤ arrivare come "topics=..." oppure (legacy) "argomento=..."
const topicsParamRaw = params.get("topics") || argomento || "";
const __URL_TOPICS = topicsParamRaw
  ? topicsParamRaw.split("|").map(s => (s || "").trim()).filter(Boolean)
  : [];
window.__URL_TOPICS = __URL_TOPICS;
window.__URL_DISCIPLINA = disciplina || "";
window.__URL_CLASSE = params.get("classe") || "";
window.__URL_LIVELLO = livello || "";
window.__URL_NUMQ = numQParam ? parseInt(numQParam,10) : null;
/** =========================
 *  ARCHIVIO DOMANDE
 *  ========================= */
const STORE_KEY = "QM_QUESTIONS_V1";

// stato modifica (Area Docente)
let editingId = null;

function setTeacherMode(isEdit){
  const modeText = document.getElementById("teacherModeText");
  const btnSave = document.getElementById("btnSave");
  const btnCancel = document.getElementById("btnCancelEdit");
  if(!modeText || !btnSave || !btnCancel) return;

  if(isEdit){
    modeText.textContent = "Modifica domanda";
    btnSave.textContent = "‚úÖ Salva modifiche";
    btnCancel.style.display = "inline-flex";
  }else{
    modeText.textContent = "Nuova domanda";
    btnSave.textContent = "üíæ Salva domanda";
    btnCancel.style.display = "none";
  }
}

function loadQuestionIntoTeacherForm(q){
  // base
  document.getElementById("tClass").value = q.class || "3";
  document.getElementById("tSubject").value = q.subject || "storia";
  document.getElementById("tLevel").value = q.level || "facile";
  document.getElementById("tTopic").value = q.topic || "";
// argomenti secondari (multi-select)
try{
  refreshTopicSuggestions(true); // popola opzioni
  const sel = document.getElementById("tTopicsExtra");
  if(sel){
    const extras = Array.isArray(q.topicsExtra) ? q.topicsExtra : [];
    const want = new Set(extras.map(t=>String(t||"").trim()).filter(Boolean).map(s=>s.toLowerCase()));
    Array.from(sel.options||[]).forEach(opt=>{
      opt.selected = want.has(String(opt.value||"").trim().toLowerCase());
    });
  }
}catch(e){}

  // media: supporto sia q.media (nuovo) che q.img (legacy)
  let media = q.media || null;
  if(!media && q.img){
    media = { type:"image", src: q.img };
  }

  if(media && media.type && media.src){
    document.getElementById("tMediaType").value = media.type;
    document.getElementById("tMediaPath").value = media.src;
    setTeacherPreview(media);
  }else{
    document.getElementById("tMediaType").value = "none";
    document.getElementById("tMediaPath").value = "";
    setTeacherPreview(null);
  }

  // testo
  document.getElementById("tQuestion").value = q.question || "";
  buildTeacherOptions(Array.isArray(q.options) ? q.options : ["",""]); 
  document.getElementById("tCorrect").value = String((typeof q.correct === "number" && q.correct >= 0) ? q.correct : 0);
  updateTeacherCorrectSelect();
    highlightCorrectTeacherOption();
document.getElementById("tPoints").value = String(q.points ?? 10);
  document.getElementById("tExplain").value = q.explain || "";
}

function startEdit(id){
  const all = loadAll();
  const q = all.find(x => x.id === id);
  if(!q){
    alert("Questa domanda non esiste pi√π (forse √® stata cancellata).");
    return;
  }
  editingId = id;
  setTeacherMode(true);
  show("teacher");
  loadQuestionIntoTeacherForm(q);
  window.scrollTo({ top: 0, behavior: "smooth" });
}

function cancelEdit(){
  editingId = null;
  setTeacherMode(false);
  clearForm();
}

function uid(){
  return (crypto && crypto.randomUUID) ? crypto.randomUUID() : ("id_" + Math.random().toString(16).slice(2));
}

function loadAll(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    // ‚úÖ Normalizza sempre (compatibilit√† con chiavi italiane / import vecchi)
    return Array.isArray(arr) ? arr.map(normalizeQuestion).filter(Boolean) : [];
  }catch(e){
    return [];
  }
}

function saveAll(list){
  localStorage.setItem(STORE_KEY, JSON.stringify(list));
}


/** Seed iniziale: alcune domande STORIA (classe 3) per test */
// Seed disattivato: nessuna domanda di test viene inserita automaticamente.
function seedIfEmpty(){ return; }
// seedIfEmpty();

// setup drag&drop docente
if(typeof setupTeacherMediaDrop==='function') setupTeacherMediaDrop();
setTeacherMode(false);

/** =========================
 *  NAVIGAZIONE SCHERMATE
 *  ========================= */

function setActiveNav(screenId){
  const btns = document.querySelectorAll(".topnav .navbtn[data-screen]");
  btns.forEach(b=>b.classList.remove("active"));
  const btn = document.querySelector('.topnav .navbtn[data-screen="'+screenId+'"]');
  if(btn) btn.classList.add("active");
}

function show(id){
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");

  if(id === "home"){
    if(typeof syncPlayerNameInputs==="function") syncPlayerNameInputs();
    if(typeof readPlayerNames==="function") readPlayerNames();
    // ‚úÖ Quando torno alla Home dal gioco, i select hanno gi√† un valore: devo forzare il render di argomenti e lista domande
    setTimeout(()=>{
      try{ if(typeof syncQuestionsFromFile==="function") syncQuestionsFromFile(); }catch(e){}
      try{ if(typeof buildTopicChecklist==="function") buildTopicChecklist(); }catch(e){}
      try{ if(typeof updateTopicSummary==="function") updateTopicSummary(); }catch(e){}
      try{ if(typeof renderPickQuestions==="function") renderPickQuestions(); }catch(e){}
    }, 50);
  }


  // In gioco: niente barra di scorrimento verticale (tutto deve entrare nello schermo)
  if(id === "game") document.body.classList.add("noScroll");
  else document.body.classList.remove("noScroll");

  try{ setActiveNav(id); }catch(e){}
}

function goHome(){
  show("home");
  if(typeof syncPlayerNameInputs==="function") syncPlayerNameInputs();
  if(typeof readPlayerNames==="function") readPlayerNames();
}

/** =========================
 *  ACCESSO PROTETTO (Area Docente / Archivio)
 *  - Codice semplice: modifica QUI sotto se vuoi cambiarlo.
 *  - La sblocco resta valida finch√© la scheda del browser resta aperta (sessionStorage).
 * ========================= */
const QM_ADMIN_CODE = "180184"; // <-- password pagine CAMBIA QUI
const QM_ACCESS_FLAG = "QM_ACCESS_OK_V1";

function isAccessOk(){
  return sessionStorage.getItem(QM_ACCESS_FLAG) === "1";
}

function lockAccess(){
  sessionStorage.removeItem(QM_ACCESS_FLAG);
  alert("üîí Accesso bloccato.");
}

/** Modale codice (pi√π affidabile del prompt, funziona anche all'apertura pagina) */
function showAccessModal(onSuccess){
  // gi√† aperta?
  if(document.getElementById("qmAccessOverlay")) return;

  const overlay = document.createElement("div");
  overlay.id = "qmAccessOverlay";
  overlay.style.position = "fixed";
  overlay.style.inset = "0";
  overlay.style.zIndex = "999999";
  overlay.style.background = "rgba(0,0,0,.6)";
  overlay.style.display = "flex";
  overlay.style.alignItems = "center";
  overlay.style.justifyContent = "center";
  overlay.style.padding = "14px";

  const card = document.createElement("div");
  card.style.width = "min(520px, 96vw)";
  card.style.background = "#fff";
  card.style.borderRadius = "16px";
  card.style.boxShadow = "0 12px 34px rgba(0,0,0,.25)";
  card.style.padding = "14px";
  card.style.textAlign = "left";

  card.innerHTML = `
    <div style="font-weight:900;font-size:18px;margin-bottom:6px;">üîí Accesso protetto</div>
    <div style="color:#556;margin-bottom:10px;">Inserisci il codice per entrare in <b>Area Docente</b> o <b>Archivio Domande</b>.</div>
    <input id="qmAccessInput" type="password" placeholder="Codice" 
      style="width:100%;box-sizing:border-box;padding:12px;border-radius:12px;border:2px solid #cfd6dc;font-size:16px;">
    <div id="qmAccessMsg" style="min-height:18px;margin-top:8px;color:#b00020;font-weight:800;"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px;flex-wrap:wrap;">
      <button id="qmAccessCancel" style="border:none;background:#e9eef3;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer;">Annulla</button>
      <button id="qmAccessOk" style="border:none;background:#111;color:#fff;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer;">Entra</button>
    </div>
  `;

  overlay.appendChild(card);
  document.body.appendChild(overlay);

  const inp = card.querySelector("#qmAccessInput");
  // üëÅÔ∏è Aggiunge l'icona per mostra/nascondi password
  try{
    // crea wrapper relativo attorno all'input (senza alterare lo stile dell'input)
    const wrap = document.createElement("div");
    wrap.className = "qmPwWrap";
    wrap.style.marginTop = "0"; // sicurezza
    inp.parentNode.insertBefore(wrap, inp);
    wrap.appendChild(inp);

    const eye = document.createElement("span");
    eye.className = "qmPwToggle";
    eye.textContent = "üëÅÔ∏è";
    eye.title = "Mostra/Nascondi";
    eye.setAttribute("aria-label","Mostra/Nascondi password");
    eye.addEventListener("click", ()=>{
      const isPw = inp.type === "password";
      inp.type = isPw ? "text" : "password";
      eye.textContent = isPw ? "üôà" : "üëÅÔ∏è";
      inp.focus();
      try{ inp.setSelectionRange(inp.value.length, inp.value.length); }catch(e){}
    });
    wrap.appendChild(eye);
  }catch(e){}

  const msg = card.querySelector("#qmAccessMsg");
  const btnOk = card.querySelector("#qmAccessOk");
  const btnCancel = card.querySelector("#qmAccessCancel");

  function close(){
    overlay.remove();
  }
  function tryOk(){
    const code = String(inp.value || "").trim();
    if(code === QM_ADMIN_CODE){
      sessionStorage.setItem(QM_ACCESS_FLAG, "1");
      close();
      onSuccess && onSuccess();
    }else{
      msg.textContent = "‚ùå Codice errato.";
      inp.focus();
      inp.select();
    }
  }

  btnCancel.addEventListener("click", ()=>{
  close();

  // ‚úÖ Se eri arrivato con deep-link (?screen=library/teacher), torna a index
  const params = new URLSearchParams(location.search);
  const scr = (params.get("screen") || "").toLowerCase();
  if(scr === "library" || scr === "teacher"){
    window.location.href = "index.html";
    return;
  }

  // ‚úÖ In tutti gli altri casi: NON entrare nella sezione protetta.
  // Resta esattamente dove sei (di solito nel gioco).
});

  btnOk.addEventListener("click", tryOk);
  inp.addEventListener("keydown", (e)=>{
    if(e.key === "Enter") tryOk();
    if(e.key === "Escape") btnCancel.click();
  });

  setTimeout(()=>inp.focus(), 50);
}

function requireAccess(thenFn){
  if(isAccessOk()){
    thenFn();
    return true;
  }
  showAccessModal(thenFn);
  return false;
}

function openTeacher(){
  requireAccess(()=>{
    editingId = null;
    setTeacherMode(false);
    show("teacher");
    refreshTopicSuggestions(true);
  });
}

function openLibrary(){
  requireAccess(()=>{
    show("library");
    renderLibrary();
  });
}

function openChooseProtected(){
  requireAccess(()=>{
    show("home");
    if(typeof syncPlayerNameInputs==="function") syncPlayerNameInputs();
    if(typeof readPlayerNames==="function") readPlayerNames();
  });
}



/** =========================
 *  GIOCO
 *  ========================= */
let currentList = [];
let playerCount = 1;
let playerScores = [0];
let currentPlayer = 0;
let gameFinished = false;
let playerNames = ["Team Blu","Team Gialli","Team Viola","Team Fucsia"];
let idx = 0;
let meta = {cls:"3", subject:"storia", level:"facile"};


function resetGameFilters(){
  // Azzera filtri in "Scegli Domande" (Home)
  // 1) rimuove valori selezionati e relative preferenze salvate
  ["selClass","selSubject","selLevel"].forEach(id=>{
    const sel = document.getElementById(id);
    if(!sel) return;
    sel.value = "";
    sel.classList.add("is-placeholder");
    try{ localStorage.removeItem("last_" + id); }catch(e){}
  });

  // 2) reset quantit√† domande (se presente)
  const numQ = document.getElementById("selNumQ");
  if(numQ){
    numQ.value = "";
    numQ.classList.add("is-placeholder");
    try{ localStorage.removeItem("last_selNumQ"); }catch(e){}
  }

  // 3) chiude pannello argomenti + ripulisce ricerca
  const panel = document.getElementById("topicPanel");
  if(panel) panel.classList.remove("open");
  const chev = document.getElementById("topicChevron");
  if(chev) chev.textContent = "‚ñæ";
  const tSearch = document.getElementById("topicSearch");
  if(tSearch) tSearch.value = "";

  // 4) reset checklist argomenti (torna a "tutti gli argomenti")
// ‚úÖ elimina TUTTE le preferenze argomenti salvate, cos√¨ al prossimo filtro torna "tutti"
try{
  for(let i=localStorage.length-1;i>=0;i--){
    const k = localStorage.key(i);
    if(k && k.startsWith("pref_topics_")) localStorage.removeItem(k);
  }
}catch(e){}

  const wrap = document.getElementById("topicChecklist");
  if(wrap){
    wrap.innerHTML = '<div class="topicCount">Seleziona prima classe, disciplina e livello‚Ä¶</div>';
  }
  // reset dei "tutti gli argomenti" (preferenze per argomento)
  try{ resetTopicPrefs(); }catch(e){}

  // aggiorna riepilogo
  // ‚úÖ reset selezione manuale domande (Scegli Domande)
  try{ localStorage.removeItem(PICK_SELECTED_KEY); }catch(e){}
  try{ __pickSelected = new Set(); }catch(e){}
  try{ updatePickSelectedUI(); 
      try{ updatePickAllVisibleState(); }catch(e){}
}catch(e){}
  const ps = document.getElementById("pickSearch");
  if(ps) ps.value = "";

  try{ updateTopicSummary();
  try{ renderPickQuestions(); }catch(e){} }catch(e){}
}


/** =========================
 *  MULTI-ARGOMENTI (principale + secondari)
 *  - q.topic = argomento principale (stringa)
 *  - q.topicsExtra = argomenti secondari (array di stringhe)
 *  - una domanda "appare" in un argomento se l'argomento √® tra questi
 *  ========================= */
function questionTopics(q){
  const out = [];
  const main = (q && q.topic != null) ? String(q.topic).trim() : "";
  if(main) out.push(main);
  const extra = q && (q.topicsExtra || q.argomentiSecondari || q.argomenti_extra || q.topics_extra);
  if(Array.isArray(extra)){
    extra.forEach(t=>{
      const s = String(t||"").trim();
      if(s) out.push(s);
    });
  }else if(typeof extra === "string"){
    // compat: stringa separata da |
    extra.split("|").forEach(t=>{
      const s = String(t||"").trim();
      if(s) out.push(s);
    });
  }
  // de-dup (case-insensitive, ma preserva la prima scrittura)
  const seen = new Set();
  const dedup = [];
  out.forEach(t=>{
    const k = t.toLowerCase();
    if(seen.has(k)) return;
    seen.add(k);
    dedup.push(t);
  });
  return dedup;
}

function questionHasTopic(q, topic){
  const want = String(topic||"").trim();
  if(!want) return false;
  const list = questionTopics(q);
  return list.some(t => String(t).trim() === want);
}

function questionHasAnyTopic(q, topicsArr){
  if(!Array.isArray(topicsArr) || topicsArr.length===0) return true; // "tutti"
  const set = new Set(topicsArr.map(t=>String(t||"").trim()).filter(Boolean));
  if(!set.size) return true;
  const list = questionTopics(q);
  return list.some(t=>set.has(String(t||"").trim()));
}


function _normTopic(s){
  return String(s||"")
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/^(la|lo|il|i|gli|le|un|uno|una)\s+/,"")
    .replace(/[^a-z0-9]+/g," ")
    .trim();
}

function startGame(){
  gameFinished = false;
  clearAllHighlights();

  meta.cls = document.getElementById("selClass").value;
  meta.subject = document.getElementById("selSubject").value;
  meta.level = document.getElementById("selLevel").value;

  // giocatori (1-4) e turni a rotazione
  playerCount = parseInt(document.getElementById("selPlayers").value, 10) || 1;
  if(playerCount < 1) playerCount = 1;
  if(playerCount > 4) playerCount = 4;
  if(typeof readPlayerNames === "function") readPlayerNames();

  // salva i nomi (la visibilit√† campi √® gestita da syncPlayerNameInputs)
  const inputs = [
    document.getElementById("pName1"),
    document.getElementById("pName2"),
    document.getElementById("pName3"),
    document.getElementById("pName4")
  ];
  playerNames = inputs.map((inp,i)=>{
    const def = ["Team Blu","Team Gialli","Team Viola","Team Fucsia"][i] || `Giocatore ${i+1}`;
    if(!inp || i >= playerCount) return def;
    const v = (inp.value || "").trim();
    return v ? v : def;
  });

  playerScores = Array.from({length: playerCount}, () => 0);
  currentPlayer = 0;

  
  const all = loadAll();

  // argomenti selezionati (checkbox). Se nessuno spuntato => tutti.
  let selectedTopics = getSelectedTopics();
  // ‚úÖ se arrivo dalla HOME con topics=..., uso quelli (anche se la checklist non √® ancora spuntata)
  if(Array.isArray(window.__URL_TOPICS) && window.__URL_TOPICS.length){
    selectedTopics = window.__URL_TOPICS.slice();
  }
  const wantAllTopics = selectedTopics.length === 0;

  const selTopicsNorm = selectedTopics.map(_normTopic);
  // numero totale domande
  const numQ = parseInt(document.getElementById("selNumQ").value, 10) || 10;

  // salva preferenze per questa combinazione
  saveTopicPrefs(meta.cls, meta.subject, meta.level);

  // Se hai selezionato manualmente delle domande (Scegli Domande), uso SOLO quelle.
  const pickSet = getPickSelectedSet ? getPickSelectedSet() : new Set();
  if(pickSet && pickSet.size){
    currentList = all.filter(q =>
      pickSet.has(q.id) &&
      q.class === meta.cls &&
      q.subject === meta.subject &&
      (meta.level === "ALL" || q.level === meta.level)
    );
  }else{
    currentList = all.filter(q =>
      q.class === meta.cls &&
      q.subject === meta.subject &&
      (meta.level === "ALL" || q.level === meta.level) &&
      (wantAllTopics || questionTopics(q).some(t=>{
        const nt = _normTopic(t || "__NONE__");
        return selTopicsNorm.some(sel => nt === sel || nt.startsWith(sel + " ") || nt.includes(sel));
      }))
    );
  }
if(!currentList.length){
    alert("Non ci sono domande per questa scelta. Inseriscile in Area Docente üôÇ");
    return;
  }

  // mescola per non essere sempre uguale
  currentList = shuffle([...currentList]);

  // limita al numero richiesto
  const available = currentList.length;

  // ‚úÖ Se la selezione (argomento/livello) produce meno domande del richiesto,
  //    NON aggiungiamo altre domande di altri argomenti: riduciamo il totale.
  let effectiveNumQ = numQ;
  if(numQ > 0 && available < numQ){
    effectiveNumQ = available;
    const selNumQEl = document.getElementById("selNumQ");
    if(selNumQEl) selNumQEl.value = String(effectiveNumQ);
  }

  if(effectiveNumQ > 0 && available > effectiveNumQ){
    currentList = currentList.slice(0, effectiveNumQ);
  }
  idx = 0;

  document.getElementById("pillMeta").textContent =
    `Classe ${meta.cls}¬™ ‚Ä¢ ${prettySubject(meta.subject)} ‚Ä¢ ${meta.level.toUpperCase()}`;

  // punteggio nascosto (ma aggiornato internamente)
  document.getElementById("pillScore").textContent = `Punti: 0`;
  document.getElementById("pillScore").style.display = "none";
  document.getElementById("showScoreBtn").style.display = "none";
  document.getElementById("pillTurn").textContent = `Turno: G${currentPlayer+1}`;
  show("game");
  loadQuestion();
  updatePlayerCards();
}

function prettySubject(s){
  const map = {storia:"Storia", geografia:"Geografia", italiano:"Italiano", scienze:"Scienze", matematica:"Matematica"};
  return map[s] || s;
}

function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}

function loadQuestion(){
  const q = currentList[idx];

  const imgEl = document.getElementById("qImg");
  const vidEl = document.getElementById("qVideo");

  // reset
  imgEl.style.display = "none";
  imgEl.removeAttribute("src");
  vidEl.style.display = "none";
  vidEl.removeAttribute("src");
  vidEl.innerHTML = "";

  // Compatibilit√†:
  // - nuovo formato: q.media = { type: "image"|"video", src:"..." }
  // - vecchio formato: q.img = "..." (trattato come immagine)
  const media = q.media || (q.img ? {type:"image", src:q.img} : null);

  if(media && media.src){
    if(media.type === "video"){
      vidEl.src = media.src;
      vidEl.style.display = "block";
    }else{
      imgEl.src = media.src;
      imgEl.style.display = "block";
    }
  }

  document.getElementById("qTopic").innerHTML =
    `<span class="tag">${q.topic || "‚Äî"}</span>`;

  document.getElementById("qText").textContent = "‚ùì " + q.question;

  // Shuffle risposte (solo nel gioco): mescola le opzioni e aggiorna l'indice della corretta
  if(Array.isArray(q.options) && q.options.length > 1){
    const zipped = q.options.map((opt, i)=>({opt, i}));
    shuffle(zipped);
    q._playOptions = zipped.map(o=>o.opt);
    q._playCorrect = zipped.findIndex(o=>o.i === q.correct);
  } else {
    q._playOptions = Array.isArray(q.options) ? q.options.slice() : [];
    q._playCorrect = q.correct;
  }

  renderGameOptions(q);

  resetOptions();
  const fb = document.getElementById("feedback");
  fb.textContent = "";
  fb.classList.remove("ok","ko");
  document.getElementById("nextBtn").style.display = "none";
  document.getElementById("pillCount").textContent = `Domanda ${idx+1}/${currentList.length}`;
}


function resetOptions(){
  getGameButtons().forEach(b=>{
    b.classList.remove("correct","wrong");
    b.disabled = false;
  });
}

function answer(choice){
  const q = currentList[idx];
  const btns = getGameButtons();

  const soundOk = document.getElementById("soundCorrect");
  const soundKo = document.getElementById("soundWrong");
  const feedback = document.getElementById("feedback");

  feedback.classList.remove("ok","ko");

  if(soundOk) soundOk.currentTime = 0;
  if(soundKo) soundKo.currentTime = 0;

  btns.forEach(b => b.disabled = true);

  const correctIndex = (typeof q._playCorrect === "number") ? q._playCorrect : q.correct;
  const ok = (choice === correctIndex);
  const pts = parseInt(q.points,10) || 10;

  if(ok){
    btns[correctIndex].classList.add("correct");
    feedback.classList.add("ok");
    // + punti SOLO al giocatore di turno
    playerScores[currentPlayer] = (playerScores[currentPlayer] || 0) + pts;
    if(soundOk) soundOk.play().catch(()=>{});
  }else{
    btns[choice].classList.add("wrong");
    btns[correctIndex].classList.add("correct");
    feedback.classList.add("ko");
    if(soundKo) soundKo.play().catch(()=>{});
  }

  // Punteggio nascosto durante il gioco (ma teniamo aggiornato il testo interno)
  const total = playerScores.reduce((a,b)=>a+(b||0),0);
  document.getElementById("pillScore").textContent = `Punti: ${total}`;
/*
  feedback.textContent =
    //(ok ? `‚úîÔ∏è Corretto! +${pts} punti a G${currentPlayer+1}. ` : `‚ùå Sbagliato. `) + (q.explain || "");
    //(ok ? `‚úîÔ∏è Corretto! +${pts} ` : `‚ùå Sbagliato. `) + (q.explain || "");

 (ok ? `‚úîÔ∏è Corretto! +${pts}` : `‚ùå Sbagliato.`) + (q.explain ? `<br><br>${q.explain}` : "");
*/

feedback.innerHTML = ok
  ? `‚úîÔ∏è Corretto! +${pts}`
  : `‚ùå Sbagliato.`;


  // GRANDEZZA DEL FONT DEL FEEDBACK - SPIEGAZIONE
if(q.explain){
  feedback.innerHTML += `
    <div style="margin-top:10px; margin-bottom:12px; font-size:20px;opacity:0.9;">  
      ${q.explain}
    </div>
  `;
}


  document.getElementById("nextBtn").style.display = "block";
  updatePlayerCards();
}

function nextQuestion(){
  idx++;
  if(idx < currentList.length){
    // turno a rotazione: G1‚ÜíG2‚ÜíG3‚ÜíG4‚Üí...
    currentPlayer = (currentPlayer + 1) % playerCount;
    document.getElementById("pillTurn").textContent = `Turno: G${currentPlayer+1}`;
    loadQuestion();
    updatePlayerCards();
  }else{
    showLevelDoneModal();
    document.getElementById("pillTurn").textContent = "Fine livello";
    gameFinished = true;
    clearAllHighlights();
    updatePlayerCards();

    // Mostra il pulsante per rivelare il punteggio (solo quando clicchi)
    document.getElementById("showScoreBtn").style.display = "none";
    document.getElementById("nextBtn").style.display = "none";
  }
}

/** =========================
 *  DOCENTE: MEDIA (drag & drop)
 *  ========================= */
function buildDefaultMediaPath(type, subject, filename){
  // immagini: img/<disciplina>/<file>
  // video:    video/<disciplina>/<file>
  if(!filename) return "";
  const safeSub = subject || "storia";
  if(type === "video") return `video/${safeSub}/${filename}`;
  return `img/${safeSub}/${filename}`;
}

function setTeacherPreview(media){
  const wrap = document.getElementById("mediaPreview");
  if(!wrap) return;

  if(!media || !media.src){
    wrap.style.display = "none";
    wrap.innerHTML = "";
    return;
  }

  wrap.style.display = "block";
  if(media.type === "video"){
    wrap.innerHTML = `<video controls playsinline src="${escapeAttr(media.src)}"></video>`;
  
  try{ updatePickAllVisibleState(); }catch(e){}
}else{
    wrap.innerHTML = `<img alt="preview" src="${escapeAttr(media.src)}" />`;
  }
}

function escapeAttr(s){
  return (s || "").replace(/"/g,'&quot;');
}



/* =========================
   OPZIONI MULTIPLE (Docente + Gioco)
   ========================= */
const MAX_OPTIONS = 4;   // cambia qui se vuoi 5/6
const MIN_OPTIONS = 2;

function optionLetter(i){
  return String.fromCharCode(65 + i); // 0->A,1->B...
}


/* --- OPZIONI con immagine (compatibilit√†) --- */
function normalizeOptionInput(v){
  // accetta stringa oppure oggetto {text, img}
  if(v && typeof v === "object"){
    const text = String(v.text ?? v.label ?? v.value ?? "").trim();
    const img  = String(v.img ?? v.image ?? v.src ?? "").trim();
    return { text, img };
  }
  return { text: String(v ?? "").trim(), img: "" };
}
function optionText(opt){
  return (opt && typeof opt === "object") ? String(opt.text ?? "") : String(opt ?? "");
}
function optionImg(opt){
  return (opt && typeof opt === "object") ? String(opt.img ?? "") : "";
}
function hasOptionImg(opt){
  const p = optionImg(opt);
  return !!(p && p.trim());
}

/** ---------- DOCENTE ---------- **/
function buildTeacherOptions(values){
  const wrap = document.getElementById("tOptionsWrap");
  if(!wrap) return;

  const arr = Array.isArray(values) ? values : [];
  const count = Math.max(MIN_OPTIONS, Math.min(MAX_OPTIONS, arr.length || MIN_OPTIONS));

  const normalized = [];
  for(let i=0;i<count;i++){
    normalized.push(normalizeOptionInput(arr[i]));
  }

  wrap.innerHTML = normalized.map((opt,i)=>`
    <div class="row teacherOptRow" data-idx="${i}" draggable="true">
      <div class="col" style="min-width:220px;flex:1 1 220px">
        <label>OPZIONE ${optionLetter(i)}</label>

        <div class="optRowFlex">
          <button class="optImgBtn ${opt.img ? "has" : ""}" type="button"
                  title="Aggiungi / cambia immagine per questa risposta"
                  onclick="pickTeacherOptionImage(${i})">üñºÔ∏è</button>

          <input class="tOpt" data-idx="${i}" value="${escapeAttr(optionText(opt))}"
                 placeholder="Testo opzione ${optionLetter(i)}" type="text"/>

          <input class="tOptImg" data-idx="${i}" value="${escapeAttr(opt.img || "")}" type="hidden"/>
        </div>

        <div class="optThumbWrap" data-idx="${i}" style="${opt.img ? "" : "display:none"}">
          <img class="optThumb" alt="img opzione" src="${escapeAttr(opt.img || "")}"
               onerror="this.closest('.optThumbWrap').style.display='none'"/>
          <button class="optRemoveImg" type="button" title="Rimuovi immagine" onclick="clearTeacherOptionImage(${i})">√ó</button>
        </div>
      </div>

      <!-- Sposta su/gi√π senza riscrivere -->
      <div class="col" style="max-width:180px;flex:0 0 180px">
        <label>AZIONI</label>
        <div class="archiveRowButtons" style="gap:8px">
          <button class="btn soft" type="button" style="margin:0;padding:12px 12px;border-radius:12px"
                  onclick="moveTeacherOption(${i}, -1)">‚¨ÜÔ∏è</button>
          <button class="btn soft" type="button" style="margin:0;padding:12px 12px;border-radius:12px"
                  onclick="moveTeacherOption(${i}, +1)">‚¨áÔ∏è</button>
        </div>
      </div>
    </div>
  `).join("");

  // Drag & drop (ri-aggancio sempre, perch√© ricreo l'HTML)
  setupTeacherOptionDnD();
  updateTeacherCorrectSelect();
  highlightCorrectTeacherOption();
}

function pickTeacherOptionImage(idx){
  idx = parseInt(idx, 10);
  if(!Number.isFinite(idx) || idx < 0) return;

  const subj = document.getElementById("tSubject") ? document.getElementById("tSubject").value : "storia";

  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.style.display = "none";

  input.addEventListener("change", ()=>{
    const file = input.files && input.files[0];
    if(!file) return;

    const rel = buildDefaultMediaPath("image", subj, file.name);

    // salva path
    const imgField = document.querySelector(`#tOptionsWrap .tOptImg[data-idx="${idx}"]`);
    if(imgField) imgField.value = rel;

    // aggiorna UI: bottone + thumb
    const btn = document.querySelector(`#tOptionsWrap .teacherOptRow[data-idx="${idx}"] .optImgBtn`);
    if(btn) btn.classList.add("has");

    const thumbWrap = document.querySelector(`#tOptionsWrap .optThumbWrap[data-idx="${idx}"]`);
    const thumb = thumbWrap ? thumbWrap.querySelector("img.optThumb") : null;

    if(thumbWrap){
      thumbWrap.style.display = "block";
      if(thumb){
        thumb.src = rel;
        // se il file non √® ancora in quella cartella, provo a mostrare almeno l'anteprima locale
        thumb.onerror = ()=>{
          try{
            const url = URL.createObjectURL(file);
            thumb.src = url;
            thumb.onerror = ()=>{ thumbWrap.style.display = "none"; };
          }catch(e){
            thumbWrap.style.display = "none";
          }
        };
      }
    }
  });

  document.body.appendChild(input);
  input.click();
  setTimeout(()=>{ try{ input.remove(); }catch(e){} }, 0);
}

function clearTeacherOptionImage(idx){
  idx = parseInt(idx, 10);
  if(!Number.isFinite(idx) || idx < 0) return;

  // svuota path immagine
  const imgField = document.querySelector(`#tOptionsWrap .tOptImg[data-idx="${idx}"]`);
  if(imgField) imgField.value = "";

  // nascondi preview
  const wrap = document.querySelector(`#tOptionsWrap .optThumbWrap[data-idx="${idx}"]`);
  if(wrap) wrap.style.display = "none";

  // togli highlight sul pulsante üñºÔ∏è
  const btn = document.querySelector(`#tOptionsWrap .optImgBtn[onclick="pickTeacherOptionImage(${idx})"]`);
  if(btn) btn.classList.remove("has");
}


function moveTeacherOption(fromIdx, dir){
  const inputs = Array.from(document.querySelectorAll("#tOptionsWrap .tOpt"));
  const count = inputs.length;
  const toIdx = fromIdx + (dir || 0);
  if(fromIdx < 0 || fromIdx >= count) return;
  if(toIdx < 0 || toIdx >= count) return;

  const vals = getTeacherOptions();

  // swap testi
  const tmp = vals[fromIdx];
  vals[fromIdx] = vals[toIdx];
  vals[toIdx] = tmp;

  // sposta anche l'indice della corretta
  const corrSel = document.getElementById("tCorrect");
  const curCorrect = corrSel ? parseInt(corrSel.value, 10) : 0;
  let newCorrect = curCorrect;
  if(curCorrect === fromIdx) newCorrect = toIdx;
  else if(curCorrect === toIdx) newCorrect = fromIdx;

  // ricostruisce righe mantenendo le modifiche
  buildTeacherOptions(vals);

  // ripristina corretta
  const corrSel2 = document.getElementById("tCorrect");
  if(corrSel2){
    corrSel2.value = String(newCorrect);
  }
  highlightCorrectTeacherOption();

  // prova a rimettere il focus sull‚Äôopzione spostata
  const after = document.querySelector(`#tOptionsWrap .tOpt[data-idx="${toIdx}"]`);
  if(after) after.focus();
}


// Alias: mantenuto per compatibilit√† (buildTeacherOptions chiama questo)
function setupTeacherOptionDnD(){
  try{ initTeacherDrag(); }catch(e){}
}

function initTeacherDrag(){
  const wrap = document.getElementById("tOptionsWrap");
  if(!wrap) return;

  // reset
  wrap.querySelectorAll(".teacherOptRow").forEach(r=>{
    r.removeEventListener("dragstart", _teacherDragStart);
    r.removeEventListener("dragover", _teacherDragOver);
    r.removeEventListener("dragleave", _teacherDragLeave);
    r.removeEventListener("drop", _teacherDragDrop);
    r.removeEventListener("dragend", _teacherDragEnd);
  });

  wrap.querySelectorAll(".teacherOptRow").forEach(r=>{
    r.addEventListener("dragstart", _teacherDragStart);
    r.addEventListener("dragover", _teacherDragOver);
    r.addEventListener("dragleave", _teacherDragLeave);
    r.addEventListener("drop", _teacherDragDrop);
    r.addEventListener("dragend", _teacherDragEnd);
  });
}

let _teacherDragFromIdx = null;

function _teacherDragStart(e){
  const row = e.currentTarget;
  _teacherDragFromIdx = parseInt(row.dataset.idx, 10);
  row.classList.add("dragging");
  e.dataTransfer.effectAllowed = "move";
  try{ e.dataTransfer.setData("text/plain", String(_teacherDragFromIdx)); }catch(_){}
}

function _teacherDragOver(e){
  e.preventDefault();
  e.dataTransfer.dropEffect = "move";
  const row = e.currentTarget;
  row.classList.add("dragover");
}

function _teacherDragLeave(e){
  const row = e.currentTarget;
  row.classList.remove("dragover");
}

function _teacherDragDrop(e){
  e.preventDefault();
  const row = e.currentTarget;
  row.classList.remove("dragover");

  const toIdx = parseInt(row.dataset.idx, 10);
  let fromIdx = _teacherDragFromIdx;
  // fallback
  if(fromIdx === null || Number.isNaN(fromIdx)){
    const s = (e.dataTransfer && e.dataTransfer.getData) ? e.dataTransfer.getData("text/plain") : "";
    fromIdx = parseInt(s, 10);
  }
  if(fromIdx === null || Number.isNaN(fromIdx)) return;
  if(toIdx === null || Number.isNaN(toIdx)) return;
  if(fromIdx === toIdx) return;

  const vals = getTeacherOptions();
  const corrSel = document.getElementById("tCorrect");
  const curCorrect = corrSel ? parseInt(corrSel.value, 10) : 0;

  const res = _reorderWithCorrect(vals, fromIdx, toIdx, curCorrect);

  buildTeacherOptions(res.values);

  const corrSel2 = document.getElementById("tCorrect");
  if(corrSel2) corrSel2.value = String(res.correctIdx);

  highlightCorrectTeacherOption();

  // focus su opzione arrivata
  const after = document.querySelector(`#tOptionsWrap .tOpt[data-idx="${toIdx}"]`);
  if(after) after.focus();
}

function _teacherDragEnd(e){
  const wrap = document.getElementById("tOptionsWrap");
  if(wrap){
    wrap.querySelectorAll(".teacherOptRow").forEach(r=>r.classList.remove("dragging","dragover"));
  }
  _teacherDragFromIdx = null;
}

function _reorderWithCorrect(arr, fromIdx, toIdx, correctIdx){
  const values = arr.slice();
  const item = values.splice(fromIdx, 1)[0];
  values.splice(toIdx, 0, item);

  let newCorrect = correctIdx;

  // Se la corretta era l'elemento spostato
  if(correctIdx === fromIdx){
    newCorrect = toIdx;
  }else{
    // Se spostiamo un elemento da sopra a sotto (o viceversa), aggiorniamo l'indice della corretta se viene "scavalcata"
    if(fromIdx < toIdx){
      // elementi tra fromIdx+1 .. toIdx scorrono su di 1
      if(correctIdx > fromIdx && correctIdx <= toIdx) newCorrect = correctIdx - 1;
    }else{
      // fromIdx > toIdx: elementi tra toIdx .. fromIdx-1 scorrono gi√π di 1
      if(correctIdx >= toIdx && correctIdx < fromIdx) newCorrect = correctIdx + 1;
    }
  }

  return {values, correctIdx:newCorrect};
}


function getTeacherOptions(){
  const rows = Array.from(document.querySelectorAll("#tOptionsWrap .teacherOptRow"));
  return rows.map(r=>{
    const idx = parseInt(r.dataset.idx, 10);
    const textEl = r.querySelector('.tOpt[data-idx="'+idx+'"]');
    const imgEl  = r.querySelector('.tOptImg[data-idx="'+idx+'"]');
    return {
      text: (textEl ? (textEl.value || "").trim() : ""),
      img:  (imgEl  ? (imgEl.value  || "").trim() : "")
    };
  });
}

function updateTeacherCorrectSelect(){
  const sel = document.getElementById("tCorrect");
  if(!sel) return;

  const optsCount = document.querySelectorAll("#tOptionsWrap .tOpt").length || MIN_OPTIONS;
  const old = parseInt(sel.value, 10);

  sel.innerHTML = "";
  for(let i=0;i<optsCount;i++){
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = optionLetter(i);
    sel.appendChild(opt);
  }

  if(!Number.isNaN(old) && old >= 0 && old < optsCount) sel.value = String(old);
  else sel.value = "0";
  highlightCorrectTeacherOption();
}



function highlightCorrectTeacherOption(){
  const sel = document.getElementById("tCorrect");
  if(!sel) return;

  const correct = parseInt(sel.value, 10);
  document.querySelectorAll(".teacherOptRow").forEach(row=>{
    const idx = parseInt(row.dataset.idx, 10);
    if(idx === correct) row.classList.add("teacherCorrect");
    else row.classList.remove("teacherCorrect");
  });
}



// ---------- ARGOMENTO: suggerimenti (autocomplete) ----------
function refreshTopicSuggestions(force=false){
  const dl = document.getElementById("topicSuggestions");
  if(!dl) return;

  const cls = document.getElementById("tClass") ? document.getElementById("tClass").value : "";
  const subj = document.getElementById("tSubject") ? document.getElementById("tSubject").value : "";

  const sig = `${cls}|${subj}`;
  if(!force && window.__lastTopicSig === sig && dl.options && dl.options.length > 0){
    return; // gi√† aggiornato: non ricostruire mentre √® aperto (altrimenti i suggerimenti spariscono)
  }
  window.__lastTopicSig = sig;

  const all = loadAll();
  const set = new Set();

  all.forEach(q=>{
    if(cls && q.class && String(q.class) !== String(cls)) return;
    if(subj && q.subject && String(q.subject) !== String(subj)) return;

    // ‚úÖ include anche argomenti secondari
    const list = questionTopics(q);
    list.forEach(tt=>{
      const t = String(tt||"").trim();
      if(t) set.add(t);
    });
  });

  const topics = Array.from(set).sort((a,b)=>a.localeCompare(b, "it", {sensitivity:"base"}));
  dl.innerHTML = topics.map(t => `<option value="${escapeAttr(t)}"></option>`).join("");

  // ‚úÖ Multi-select "argomenti secondari"
  const sel = document.getElementById("tTopicsExtra");
  if(sel){
    const prev = new Set(Array.from(sel.selectedOptions||[]).map(o=>o.value));
    sel.innerHTML = topics.map(t=>{
      const selected = prev.has(t) ? "selected" : "";
      return `<option value="${escapeAttr(t)}" ${selected}>${escapeHtml(t)}</option>`;
    }).join("");
  }
}

// Aggiorna suggerimenti quando entri in Area Docente o quando cambi filtri
document.addEventListener("DOMContentLoaded", ()=>{

  // üîí Se apri questo file "game_combo.html" direttamente (senza parametri),
  // richiedo il PIN prima di mostrare la Home (cos√¨ i bambini non entrano in "Scegli domande").
  try{
    const hasParams = !!(location.search && location.search.length > 1);
    if(!hasParams && !isAccessOk()){
      // nascondo qualunque screen attiva e chiedo il codice
      document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
      showAccessModal(()=>{
        // dopo sblocco, torno alla Home
        try{ show("home"); }catch(e){}
      });

      // Se preme ANNULLA -> torno a index.html (non deve entrare)
      setTimeout(()=>{
        const btnCancel = document.getElementById("qmAccessCancel");
        if(btnCancel){
          btnCancel.addEventListener("click", (e)=>{
            e.preventDefault(); e.stopPropagation();
            try{
              if(typeof goIndex === "function") goIndex();
              else window.location.href = "index.html";
            }catch(err){
              window.location.href = "index.html";
            }
          }, true);
        }
      }, 0);

      return; // stop init qui
    }
  }catch(e){}
  // Import automatico domande da questions.js (offline, stile Ruota)
  try{ syncQuestionsFromFile(); }catch(e){}
  try{ bindLibrarySelectionDelegation(); }catch(e){}
  try{ updateSelectedCountUI(); }catch(e){}
  // ‚úÖ Filtri Archivio: aggiorna anche la lista ARGOMENTI (collegata a Classe/Disciplina/Livello)
  ["fClass","fSubject","fLevel"].forEach(id=>{
    const el = document.getElementById(id);
    if(el){
      el.addEventListener("change", ()=>{
        try{ renderLibrary(); }catch(e){}
        try{ refreshLibTopicPanelIfOpen(); }catch(e){}
      });
    }
  });

  const tTopic = document.getElementById("tTopic");
  const dl = document.getElementById("topicSuggestions");
  if(tTopic){
    tTopic.addEventListener("focus", ()=>refreshTopicSuggestions(false));
    // su click/pointerdown aggiorna SOLO se la lista √® vuota (cos√¨ non sparisce mentre selezioni)
    tTopic.addEventListener("pointerdown", ()=>{
      if(dl && (!dl.options || dl.options.length === 0)) refreshTopicSuggestions(true);
    });
  }
  const tClass = document.getElementById("tClass");
  const tSubject = document.getElementById("tSubject");
  if(tClass) tClass.addEventListener("change", ()=>refreshTopicSuggestions(true));
  if(tSubject) tSubject.addEventListener("change", ()=>refreshTopicSuggestions(true));
});
function addTeacherOption(){
  const cur = document.querySelectorAll("#tOptionsWrap .tOpt").length || MIN_OPTIONS;
  if(cur >= MAX_OPTIONS) return;

  const vals = getTeacherOptions();
  vals.push("");
  buildTeacherOptions(vals);
}

function removeTeacherOption(){
  const cur = document.querySelectorAll("#tOptionsWrap .tOpt").length || MIN_OPTIONS;
  if(cur <= MIN_OPTIONS) return;

  const vals = getTeacherOptions();
  vals.pop();
  buildTeacherOptions(vals);
}

/** ---------- GIOCO ---------- **/
function renderGameOptions(q){
  const wrap = document.getElementById("optionsWrap");
  if(!wrap) return;

  const opts = Array.isArray(q._playOptions) ? q._playOptions : (Array.isArray(q.options) ? q.options : []);
  wrap.innerHTML = "";

  // ‚úÖ Se almeno una risposta ha immagine -> tutte le card restano "grandi" (layout immagini)
  //    Se nessuna immagine -> card pi√π basse/rettangolari.
  try{
    const anyImg = opts.some(o => (optionImg(o) || "").trim() !== "");
    wrap.classList.toggle("hasOptMedia", anyImg);
  }catch(e){
    wrap.classList.remove("hasOptMedia");
  }

  opts.forEach((opt, i) => {
    const btn = document.createElement("button");
    btn.className = "btn option";
    btn.type = "button";

    const t = optionText(opt).trim();
    const img = optionImg(opt).trim();

    if(img){
      btn.innerHTML = `
        <img class="optBtnImg" alt="immagine risposta" src="${escapeAttr(img)}"
             onerror="this.style.display='none'" />
        <div class="optBtnText">${optionLetter(i)}) ${escapeHtml(t)}</div>
      `;
    }else{
      btn.textContent = `${optionLetter(i)}) ${t}`;
    }

    btn.addEventListener("click", () => answer(i));
    wrap.appendChild(btn);
  });
}

function getGameButtons(){
  return Array.from(document.querySelectorAll("#optionsWrap .btn.option"));
}

function getTeacherMedia(){
  const type = document.getElementById("tMediaType").value;
  const path = (document.getElementById("tMediaPath").value || "").trim();
  if(type === "none" || !path) return null;
  return { type, src: path };
}

function setupTeacherMediaDrop(){
  const dz = document.getElementById("mediaDrop");
  if(!dz) return;

  const typeSel = document.getElementById("tMediaType");
  const pathInput = document.getElementById("tMediaPath");
  const subjectSel = document.getElementById("tSubject");

  function detectTypeFromFile(file){
    if(!file) return "image";
    if(file.type && file.type.startsWith("video/")) return "video";
    return "image";
  }

  function applyFile(file){
    const type = detectTypeFromFile(file);
    typeSel.value = type;

    const subject = subjectSel.value;
    pathInput.value = buildDefaultMediaPath(type, subject, file.name);

    // preview locale (non salva il file!): per vedere subito cosa hai trascinato
    const url = URL.createObjectURL(file);
    setTeacherPreview({ type, src: url });
  }

  // cambia disciplina o tipo -> se c'√® solo nome file, ricostruisco percorso
  function rebuildPathIfPossible(){
    const type = typeSel.value;
    const subject = subjectSel.value;
    const cur = (pathInput.value || "").trim();
    if(!cur) return;

    // se l'utente ha scritto un percorso completo, non tocco.
    // se sembra solo un nome file, costruisco il percorso.
    if(!cur.includes("/") && !cur.includes("\\") ){
      pathInput.value = buildDefaultMediaPath(type, subject, cur);
    }
  }

  typeSel.addEventListener("change", rebuildPathIfPossible);
  subjectSel.addEventListener("change", rebuildPathIfPossible);

  // drag events
  ["dragenter","dragover"].forEach(ev=>{
    dz.addEventListener(ev, (e)=>{
      e.preventDefault();
      dz.classList.add("dragover");
    });
  });
  ["dragleave","drop"].forEach(ev=>{
    dz.addEventListener(ev, (e)=>{
      e.preventDefault();
      dz.classList.remove("dragover");
    });
  });

  dz.addEventListener("drop", (e)=>{
    const file = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
    if(!file) return;
    applyFile(file);
  });

  // click per scegliere file (comodo su mobile)
  dz.addEventListener("click", ()=>{
    const picker = document.createElement("input");
    picker.type = "file";
    picker.accept = "image/*,video/*";
    picker.onchange = ()=>{
      const f = picker.files && picker.files[0];
      if(f) applyFile(f);
    };
    picker.click();
  });
}

/** =========================
 *  DOCENTE: SALVA
 *  ========================= */

function saveQuestion(){
  // üîí Argomento obbligatorio
  var _topicEl = document.getElementById('tTopic');
  if(_topicEl && !_topicEl.value.trim()){
    alert('Inserisci l\'argomento prima di salvare la domanda.');
    _topicEl.focus();
    return;
  }

  window.__lastTopicSig = null;
  window.__lastTopicSig = null;
  const q = {
    id: editingId || uid(),
    class: document.getElementById("tClass").value,
    subject: document.getElementById("tSubject").value,
    level: document.getElementById("tLevel").value,
topic: (document.getElementById("tTopic").value || "").trim(),
topicsExtra: (() => {
  const sel = document.getElementById("tTopicsExtra");
  if(!sel) return [];
  const main = (document.getElementById("tTopic").value || "").trim();
  const arr = Array.from(sel.selectedOptions || []).map(o => (o.value || "").trim()).filter(Boolean);
  // rimuovi duplicati + togli l'argomento principale se presente
  const out = [];
  const seen = new Set();
  arr.forEach(t=>{
    if(main && t.toLowerCase() === main.toLowerCase()) return;
    const k = t.toLowerCase();
    if(seen.has(k)) return;
    seen.add(k);
    out.push(t);
  });
  return out;
})(),
    media: getTeacherMedia(),
    question: (document.getElementById("tQuestion").value || "").trim(),
    options: getTeacherOptions(),
    correct: parseInt(document.getElementById("tCorrect").value,10),
    points: parseInt(document.getElementById("tPoints").value,10) || 10,
    explain: (document.getElementById("tExplain").value || "").trim()
  };
// Validazioni (opzioni multiple)
if(!q.question){
  alert("Scrivi la domanda.");
  return;
}

// ‚úÖ Opzioni: possono essere solo testo, solo immagine, o entrambe
const nonEmptyIdx = q.options
  .map((o,i)=>({i,o}))
  .filter(x=>{
    const t = (optionText(x.o) || "").trim();
    const img = (x.o && typeof x.o === "object" ? (x.o.img || "").trim() : "");
    return t !== "" || img !== "";
  })
  .map(x=>x.i);

if(nonEmptyIdx.length < 2){
  alert("Inserisci almeno 2 risposte (testo e/o immagine).");
  return;
}

if(!(q.correct >= 0 && q.correct < q.options.length)){
  alert("Seleziona una risposta corretta valida.");
  return;
}

// La corretta non pu√≤ essere vuota (deve avere testo e/o immagine)
if(!nonEmptyIdx.includes(q.correct)){
  alert("La risposta corretta deve essere compilata (testo o immagine).");
  return;
}

const all = loadAll();

  if(editingId){
    const i = all.findIndex(x => x.id === editingId);
    if(i === -1){
      alert("Non trovo pi√π la domanda da modificare. La salvo come nuova.");
      q.id = uid();
      all.push(q);
    }else{
      all[i] = q;
    }
    saveAll(all);
    alert("‚úÖ Modifiche salvate!");
    editingId = null;
    setTeacherMode(false);
    clearForm();
    return;
  }

  all.push(q);
  saveAll(all);

  alert("‚úÖ Domanda salvata!");
  clearForm();
}

function clearForm(){
  document.getElementById("tTopic").value = "";
  const _sel = document.getElementById("tTopicsExtra"); if(_sel) Array.from(_sel.options||[]).forEach(o=>o.selected=false);
  document.getElementById("tMediaType").value = "none";
  document.getElementById("tMediaPath").value = "";
  setTeacherPreview(null);
  document.getElementById("tQuestion").value = "";
  buildTeacherOptions(["",""]); // reset a 2 opzioni
  document.getElementById("tCorrect").value = "0";
  updateTeacherCorrectSelect();
  document.getElementById("tPoints").value = "10";
  document.getElementById("tExplain").value = "";
}

function resetAll(){
  const ok = confirm("Attenzione: cancello TUTTE le domande salvate su questo dispositivo. Continuo?");
  if(!ok) return;
  localStorage.removeItem(STORE_KEY);
  //seedIfEmpty();

// setup drag&drop docente
if(typeof setupTeacherMediaDrop==='function') setupTeacherMediaDrop();
  alert("Archivio resettato.");
}

/** =========================
 *  LIBRERIA: LISTA / EXPORT / IMPORT
 *  ========================= */

let __libSelected = new Set();

// =========================
// HOME (Scegli Domande): selezione manuale domande
// =========================
const PICK_SELECTED_KEY = "home_pick_selected_v1";
let __pickSelected = new Set();
// ‚úÖ Non rendere persistente la selezione manuale: ad ogni refresh riparto da zero
try{ localStorage.removeItem(PICK_SELECTED_KEY); }catch(e){}

function getPickSelectedSet(){
  try{
    const arr = JSON.parse(localStorage.getItem(PICK_SELECTED_KEY) || "[]");
    return new Set(arr.map(String));
  }catch(e){ return new Set(); }
}
function savePickSelectedSet(set){
  try{ localStorage.setItem(PICK_SELECTED_KEY, JSON.stringify([...set])); }catch(e){}
}
function updatePickSelectedUI(){
  const n = (__pickSelected && __pickSelected.size) ? __pickSelected.size : 0;
  const c = document.getElementById("pickSelCount");
  if(c) c.textContent = String(n);
}
function bindPickSelectionDelegation(){
  if(window.__pickDelegationBound) return;
  window.__pickDelegationBound = true;

  document.addEventListener("change", (e)=>{
    const t = e.target;
    if(!t || !t.classList || !t.classList.contains("pickChk")) return;
    const id = String(t.getAttribute("data-id") || "");
    if(!id) return;

    if(t.checked) __pickSelected.add(id);
    else __pickSelected.delete(id);

    savePickSelectedSet(__pickSelected);
    updatePickSelectedUI();
  });
}

function clearPickSearch(){
  const el = document.getElementById("pickSearch");
  if(el){
    el.value = "";
    renderPickQuestions();
  }
}

// usa le stesse regole dell'Archivio: se selezioni livello=ALL, mostro i 3 blocchi colorati

function togglePickAllVisible(headEl){
  // Seleziona/Deseleziona tutte le domande VISIBILI nella tabella corrente
  const table = headEl ? headEl.closest('table') : null;
  const boxes = Array.from((table || document).querySelectorAll('.pickChk'));
  if(!boxes.length) return;

  const checked = !!headEl.checked;

  try{ __pickSelected = getPickSelectedSet(); }catch(e){ __pickSelected = __pickSelected || new Set(); }

  boxes.forEach(cb=>{
    cb.checked = checked;
    const id = cb.getAttribute('data-id');
    if(!id) return;
    if(checked) __pickSelected.add(id);
    else __pickSelected.delete(id);
  });

  try{ savePickSelectedSet(__pickSelected); }catch(e){}
  try{ updatePickSelectedUI(); }catch(e){}
  try{ updatePickAllVisibleState(); }catch(e){}
}

function updatePickAllVisibleState(){
  // Aggiorna lo stato (checked / indeterminate) di OGNI checkbox "seleziona tutto"
  document.querySelectorAll('.pickAllVisible').forEach(headEl=>{
    const table = headEl.closest('table');
    const boxes = Array.from((table || document).querySelectorAll('.pickChk'));
    if(!boxes.length){
      headEl.checked = false;
      headEl.indeterminate = false;
      return;
    }
    const checkedCount = boxes.filter(b=>b.checked).length;
    headEl.checked = (checkedCount === boxes.length);
    headEl.indeterminate = (checkedCount > 0 && checkedCount < boxes.length);
  });
}

function renderPickQuestions(){
  try{ bindPickSelectionDelegation(); }catch(e){}
  try{ __pickSelected = getPickSelectedSet(); }catch(e){ __pickSelected = __pickSelected || new Set(); }
  updatePickSelectedUI();

  const wrap = document.getElementById("pickWrap");
  if(!wrap) return;

  const cls = document.getElementById("selClass")?.value || "";
  const sub = document.getElementById("selSubject")?.value || "";
  const lev = document.getElementById("selLevel")?.value || "";
  const search = (document.getElementById("pickSearch")?.value || "").trim().toLowerCase();

  if(!cls || !sub || !lev){
    wrap.innerHTML = "<div class='hint'>Seleziona prima classe, disciplina e livello‚Ä¶</div>";
    return;
  }

  let all = loadAll().filter(q =>
    q.class === cls &&
    q.subject === sub &&
    (lev === "ALL" || q.level === lev)
  );

  // argomenti selezionati (se nessuno => tutti)
  const selectedTopics = (loadTopicPrefs(cls, sub, lev).topics || []);
  if(selectedTopics.length){
    all = all.filter(q => questionHasAnyTopic(q, selectedTopics));
  }

  if(search){
    all = all.filter(q=>{
      const hay = [q.topic, q.question, q.explain, (q.options||[]).map(o=>optionText(o)).join(" ")].join(" ").toLowerCase();
      return hay.includes(search);
    });
  }

  if(!all.length){
    wrap.innerHTML = "<div class='hint'>Nessuna domanda con questi filtri.</div>";
    return;
  }

  function rowHTML(q, i){
    const checked = __pickSelected.has(q.id) ? "checked" : "";
    return `
      <tr>
        <td><b>${i+1}</b></td>
        <td><input type="checkbox" class="pickChk" data-id="${q.id}" ${checked} /></td>
        <td><span class="tag">${typeof highlightText === "function" ? highlightText(q.topic || "‚Äî", search) : escapeHtml(q.topic || "‚Äî")}</span></td>
        <td class="qcell">
          <div class="qtitle">${typeof highlightText === "function" ? highlightText(short(q.question, 160), search) : escapeHtml(short(q.question, 160))} ${isNewQuestion(q) ? ' <span class="tag newTag">NUOVA</span>' : ''}</div>
          ${q.options ? `
          <div class="opts">
            ${(q.options || []).map((opt, idx) => {
              const t = optionText(opt) || "";
              const hasImg = !!optionImg(opt);
              return `
              <span class="opt ${Number(q.correct)===Number(idx)?'correct':''}">${typeof optionLetter === "function" ? optionLetter(idx) : (idx+1)}) ${typeof highlightText === "function" ? highlightText(t, search) : escapeHtml(t)}${hasImg?' üñºÔ∏è':''}</span>
            `;
            }).join("")}
            ${q.explain ? `<div class="explain"><b>Spiegazione:</b> ${typeof highlightText === "function" ? highlightText(q.explain, search) : escapeHtml(q.explain)}</div>` : ``}
          </div>
        ` : ``}
        </td>
        <td class="mediaCell">
          ${(() => {
            const m = q.media || (q.img ? {type:"image", src:q.img} : null);
            if(!m || !m.src) return "";
            if(m.type === "video") return `<video class="mediaThumb video" src="${escapeAttr(m.src)}" muted playsinline preload="metadata"></video>`;
            return `<img class="mediaThumb" src="${escapeAttr(m.src)}" alt="media" />`;
          })()}
        </td>
      </tr>
    `;
  }

  function tableHTML(list, key){
    const rows = list.map((q,i)=>rowHTML(q,i)).join("");
    return `
      <table class="levelTable ${key}">
        <thead>
          <tr>
            <th>#</th><th style="width:44px;text-align:center"><input type="checkbox" class="pickAllVisible" title="Seleziona tutte le domande visibili" onchange="togglePickAllVisible(this)"></th><th>Argomento</th><th>Domanda</th><th>Media</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
  }

  // Se livello = ALL => accordion 3 blocchi colorati (come Archivio)
  if(lev === "ALL"){
    const easy = all.filter(q=>q.level==="facile");
    const mid  = all.filter(q=>q.level==="medio");
    const hard = all.filter(q=>q.level==="difficile");

    const sections = [
      {title:"üü¢ Facili", cls:"level-easy", list: easy, key:"easy"},
      {title:"üü° Medie",  cls:"level-mid",  list: mid,  key:"mid"},
      {title:"üî¥ Difficili", cls:"level-hard", list: hard, key:"hard"},
    ];

    const accHTML = sections.map(sec=>{
      const body = sec.list.length ? tableHTML(sec.list, sec.key)
        : "<div class='hint' style='margin:10px 0'>Nessuna domanda in questo livello.</div>";
      return `
        <div class="accItem">
          <button type="button" class="accHeader ${sec.cls}">
            <span>${sec.title}</span>
            <span class="count">${sec.list.length} domande</span>
          </button>
          <div class="accBody" style="display:none">${body}</div>
        </div>
      `;
    }).join("");

    wrap.innerHTML = `
      <div class="hint">Totale: <b>${all.length}</b> domande</div>
      <div class="accWrap">${accHTML}</div>
    `;

    wrap.querySelectorAll(".accHeader").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const body = btn.nextElementSibling;
        if(!body) return;
        body.style.display = (body.style.display !== "none") ? "none" : "block";
      });
    });

    return;
  }

  // livello specifico: tabella singola
  const key = (lev==="facile") ? "easy" : (lev==="medio" ? "mid" : "hard");
  wrap.innerHTML = `
    <div class="hint">Totale: <b>${all.length}</b> domande</div>
    ${tableHTML(all, key)}
  `;
}



let __libTopicSel = new Set();
const LIB_TOPIC_KEY = "lib_topic_filter_v1";

function loadLibTopicSel(){
  try{
    const arr = JSON.parse(localStorage.getItem(LIB_TOPIC_KEY) || "[]");
    return new Set(arr.map(String));
  }catch(e){ return new Set(); }
}
function saveLibTopicSel(set){
  localStorage.setItem(LIB_TOPIC_KEY, JSON.stringify([...set]));
}
function libTopicKey(topic){
  const t = (topic==null? "" : String(topic)).replace(/\s+/g," ").trim();
  return t; // empty string means "senza argomento"
}
function updateLibTopicInfo(){
  const info = document.getElementById("libTopicInfo");
  if(!info) return;
  const n = __libTopicSel.size;
  info.textContent = (n===0) ? "Tutti" : (`Selezionati: ${n}`);
}
function bindLibTopicFilter(){
  try{ __libTopicSel = loadLibTopicSel(); }catch(e){ __libTopicSel = new Set(); }
  updateLibTopicInfo();
}

function toggleLibTopicPanel(){
  const panel = document.getElementById("libTopicPanel");
  if(!panel) return;
  panel.classList.toggle("open");
  if(panel.classList.contains("open")){
    renderLibTopicList();
    // focus search
    setTimeout(()=>{ try{ document.getElementById("libTopicSearch")?.focus(); }catch(e){} }, 50);
  }
}

function libClearTopicFilter(){
  __libTopicSel = new Set();
  saveLibTopicSel(__libTopicSel);
  updateLibTopicInfo();
  renderLibTopicList();
  renderLibrary();
}

// ‚ôªÔ∏è AZZERA FILTRI ARCHIVIO (classe / disciplina / livello / argomenti / ricerca)
function resetArchiveFilters(){
  const fClass = document.getElementById("fClass");
  const fSubject = document.getElementById("fSubject");
  const fLevel = document.getElementById("fLevel");
  const fSearch = document.getElementById("fSearch");

  // reset select (usa "all" per mostrare tutto)
  if(fClass)   fClass.value = "all";
  if(fSubject) fSubject.value = "all";
  if(fLevel)   fLevel.value = "all";

  // aggiorna placeholder style
  [fClass,fSubject,fLevel].forEach(sel=>{
    if(!sel) return;
    // se √® selezionata l'opzione placeholder (value=""), applica classe; altrimenti rimuovi
    if(String(sel.value||"") === "") sel.classList.add("is-placeholder");
    else sel.classList.remove("is-placeholder");
    // forza salvataggio via setupSelectRemember (se agganciato su change)
    try{ sel.dispatchEvent(new Event("change", {bubbles:true})); }catch(e){}
  });

  // reset ricerca testo
  if(fSearch) fSearch.value = "";

  // chiudi pannello argomenti se aperto
  const panel = document.getElementById("libTopicPanel");
  if(panel) panel.classList.remove("open");

  // reset filtro argomenti + render
  if(typeof libClearTopicFilter === "function"){
    libClearTopicFilter(); // fa gi√† renderLibrary()
    return;
  }

  if(typeof renderLibrary === "function") renderLibrary();
}


// Base list for topic list: respects class/subject/level + search, but NOT topic filter itself
function getLibBaseQuestionsForTopics(){
  const cls = document.getElementById("fClass").value;
  const sub = document.getElementById("fSubject").value;
  const lev = document.getElementById("fLevel").value;
  const search = (document.getElementById("fSearch")?.value || "").trim().toLowerCase();
  let all = loadAll();
  all = all.filter(q =>
    (cls === "all" || q.class === cls) &&
    (sub === "all" || q.subject === sub) &&
    (lev === "all" || q.level === lev)
  );
  if(search){
    all = all.filter(q=>{
      const hay = [q.topic, q.question, q.explain, (q.options||[]).map(o=>optionText(o)).join(" ")].join(" ").toLowerCase();
      return hay.includes(search);
    });
  }
  return all;
}

// ‚úÖ Mantiene selezionati solo gli argomenti disponibili con i filtri correnti
function syncLibTopicSelToBase(){
  try{
    if(!(__libTopicSel instanceof Set)) __libTopicSel = loadLibTopicSel();
    const base = getLibBaseQuestionsForTopics();
    const avail = new Set(base.map(q => libTopicKey(q.topic)));
    let changed = false;
    __libTopicSel.forEach(k=>{
      if(!avail.has(k)){ __libTopicSel.delete(k); changed = true; }
    });
    if(changed){
      saveLibTopicSel(__libTopicSel);
      updateLibTopicInfo();
    }
  }catch(e){}
}

// ‚úÖ Se il pannello argomenti √® aperto, aggiorna lista e conteggi
function refreshLibTopicPanelIfOpen(){
  const panel = document.getElementById("libTopicPanel");
  if(panel && panel.classList.contains("open")){
    renderLibTopicList();
  }
}

function renderLibTopicList(){
  const wrap = document.getElementById("libTopicList");
  if(!wrap) return;

  const base = getLibBaseQuestionsForTopics();
  // counts
  const counts = new Map();
  base.forEach(q=>{
    const k = libTopicKey(q.topic);
    counts.set(k, (counts.get(k)||0) + 1);
  });

  // search inside topics panel
  const tsearch = (document.getElementById("libTopicSearch")?.value || "").trim().toLowerCase();

  // sort topics alphabetically, but put empty first as "Senza argomento" if exists
  let keys = Array.from(counts.keys());
  keys.sort((a,b)=>{
    if(a==="" && b!=="") return -1;
    if(b==="" && a!=="") return 1;
    return a.localeCompare(b, "it", {sensitivity:"base"});
  });

  if(tsearch){
    keys = keys.filter(k=>{
      const label = (k==="" ? "senza argomento" : k).toLowerCase();
      return label.includes(tsearch);
    });
  }

  if(keys.length===0){
    wrap.innerHTML = "<div class='tiny'>Nessun argomento disponibile.</div>";
    return;
  }

  wrap.innerHTML = keys.map(k=>{
    const label = (k==="" ? "Senza argomento" : escapeHtml(k));
    const c = counts.get(k)||0;
    const checked = __libTopicSel.has(k) ? "checked" : "";
    return `
      <div class="topicItem">
        <div class="topicLeft">
          <input type="checkbox" class="libTopicChk" data-topic="${escapeHtml(k)}" ${checked} />
          <div>${label}</div>
        </div>
        <div class="topicCount">${c}</div>
      </div>
    `;
  }).join("");

  // bind changes (lightweight)
  wrap.querySelectorAll(".libTopicChk").forEach(cb=>{
    cb.addEventListener("change", ()=>{
      const k = libTopicKey(cb.getAttribute("data-topic"));
      if(cb.checked) __libTopicSel.add(k);
      else __libTopicSel.delete(k);
      saveLibTopicSel(__libTopicSel);
      updateLibTopicInfo();
      renderLibrary();
    });
  });
}



function bindLibCheckboxes(){
  // ‚úÖ Selezione persistente: usa localStorage (LIB_SELECTED_KEY) invece di perdere le spunte quando cerchi/filtri
  try{ bindLibrarySelectionDelegation(); }catch(e){}
  try{ __libSelected = getLibSelectedSet(); }catch(e){ __libSelected = __libSelected || new Set(); }
  try{ updateSelectedCountUI(); }catch(e){}
}


function renderLibrary(){
  bindLibCheckboxes();
  bindLibTopicFilter();
  syncLibTopicSelToBase();
  refreshLibTopicPanelIfOpen();
  const cls = document.getElementById("fClass").value;
  const sub = document.getElementById("fSubject").value;
  const lev = document.getElementById("fLevel").value;
  const search = (document.getElementById("fSearch")?.value || "").trim().toLowerCase();

  // Se i filtri bloccano Classe/Disciplina, non ha senso ripeterli in ogni riga:
  const showClassCol = (cls === "all");
  const showSubjectCol = (sub === "all");
  const showLevelCol = (lev === "all");

  let all = loadAll();
  all = all.filter(q =>
    (cls === "all" || q.class === cls) &&
    (sub === "all" || q.subject === sub) &&
    (lev === "all" || q.level === lev)
  );

  if(search){
    all = all.filter(q => {
      const hay = [q.topic, q.question, q.explain, (q.options||[]).map(o=>optionText(o)).join(" ")].join(" ").toLowerCase();
      return hay.includes(search);
    });
  }
  // Filtro per ARGOMENTO (checkbox multipla)
  const topicSet = __libTopicSel || new Set();
  if(topicSet.size){
    all = all.filter(q => topicSet.has(libTopicKey(q.topic)));
  }

  const wrap = document.getElementById("libWrap");
  if(!all.length){
    wrap.innerHTML = "<p class='hint'>Nessuna domanda con questi filtri.</p>";
    return;
  }

  const chips = [];
  if(cls !== "all") chips.push(`Classe: <b>${cls}¬™</b>`);
  if(sub !== "all") chips.push(`Disciplina: <b>${prettySubject(sub)}</b>`);
  if(lev !== "all") chips.push(`Livello: <b>${escapeHtml(lev)}</b>`);
  if((__libTopicSel||new Set()).size) chips.push(`Argomenti: <b>${(__libTopicSel.size)}</b>`);

  const thClass = showClassCol ? "<th>Classe</th>" : "";
  const thSub = showSubjectCol ? "<th>Disciplina</th>" : "";
  const thLevel = showLevelCol ? "<th>Livello</th>" : "";
  const thSel = "<th>‚úì</th>";
  const thMedia = "<th>Media</th>";

  function rowHTML(q, i){
    const tdLevel = showLevelCol ? `<td>${q.level}</td>` : "";
    return `
      <tr>
        <td><b>${i+1}</b></td>
        <td><input type="checkbox" class="libChk" data-id="${q.id}" ${__libSelected.has(q.id) ? "checked" : ""} /></td>
        ${showClassCol ? `<td>${q.class}¬™</td>` : ``}
        ${showSubjectCol ? `<td>${prettySubject(q.subject)}</td>` : ``}
        ${tdLevel}
        <td><span class="tag">${highlightText(q.topic || "‚Äî", search)}</span></td>
        <td class="qcell">
          <div class="qtitle">
            ${highlightText(short(q.question, 120), search)}
            ${q.media ? ` <span class="tag">${q.media.type==="video" ? "üé¨ Video" : "üñºÔ∏è Img"}</span>` : (q.img ? ` <span class="tag">üñºÔ∏è Img</span>` : "")}

           ${isNewQuestion(q) ? ' <span class="tag newTag">NUOVA</span>' : ''}</div>
          ${q.options ? `
            <div class="opts">
              ${(q.options || []).map((opt, idx) => {
                const t = optionText(opt) || "";
                const hasImg = !!optionImg(opt);
                return `
                <span class="opt ${Number(q.correct)===Number(idx)?'correct':''}">${optionLetter(idx)}) ${highlightText(t, search)}${hasImg?' üñºÔ∏è':''}</span>
              `;
              }).join("")}
              ${q.explain ? `<div class="explain"><b>Spiegazione:</b> ${highlightText(q.explain, search)}</div>` : ``}
            </div>
          ` : ``}
        </td>
        <td class="mediaCell">
          ${(() => {
            const m = q.media || (q.img ? {type:"image", src:q.img} : null);
            if(!m || !m.src) return "";
            if(m.type === "video") return `<video class="mediaThumb video" src="${escapeAttr(m.src)}" muted playsinline preload="metadata"></video>`;
            return `<img class="mediaThumb" src="${escapeAttr(m.src)}" alt="media" />`;
          })()}
        </td>
        <td style="white-space:nowrap"><button class="smallbtn" onclick="startEdit('${q.id}')">‚úèÔ∏è</button> <button class="smallbtn" onclick="deleteOne('${q.id}')">üóëÔ∏è</button></td>
      </tr>
    `;
  }

  function tableHTML(list, tableClass){
    const rows = list.map((q, i) => rowHTML(q, i)).join("");
    return `
      <table class="levelTable ${tableClass}">
        <thead>
          <tr>
            <th>#</th>${thSel}${thClass}${thSub}${thLevel}<th>Argomento</th><th>Domanda</th>${thMedia}<th>Azioni</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
      `;
  }
applyLibrarySelectionsToVisibleRows();

  // Se DIFFICOLT√Ä = Tutte, mostriamo 3 "sezioni" cliccabili (accordion)
  // cos√¨ hai Facili / Medie / Difficili sempre a portata di click.
  if(lev === "all"){
    const easy = all.filter(q => q.level === "facile");
    const mid  = all.filter(q => q.level === "medio");
    const hard = all.filter(q => q.level === "difficile");

    const sections = [
      {title:"üü¢ Facili", level:"facile", cls:"level-easy", list: easy, key:"easy"},
      {title:"üü° Medie", level:"medio", cls:"level-mid", list: mid, key:"mid"},
      {title:"üî¥ Difficili", level:"difficile", cls:"level-hard", list: hard, key:"hard"},
    ];

    const accHTML = sections.map(sec => {
      const body = sec.list.length
        ? tableHTML(sec.list, sec.key)
        : "<div class='hint' style='margin:10px 0'>Nessuna domanda in questo livello.</div>";
      return `
        <div class="accItem">
          <button type="button" class="accHeader ${sec.cls}" data-level="${sec.level}">
            <span>${sec.title}</span>
            <span class="count">${sec.list.length} domande</span>
          </button>
          <div class="accBody" data-body="${sec.level}" style="display:none">
            ${body}
          </div>
        </div>
      `;
    }).join("");

    wrap.innerHTML = `
      <div class="hint">
        Totale: <b>${all.length}</b> domande
        ${chips.length ? ` ‚Ä¢ ${chips.join(" ‚Ä¢ ")}` : ``}
      </div>
      <div class="accWrap">${accHTML}</div>
    `;

    // Attiva toggle (click = apri/chiudi) ‚Äî robusto anche su mobile
    wrap.querySelectorAll(".accHeader").forEach(btn => {
      btn.addEventListener("click", () => {
        const body = btn.nextElementSibling;
        if(!body) return;
        const isOpen = body.style.display !== "none";
        body.style.display = isOpen ? "none" : "block";
      });
    });

    return;
  }
// Altrimenti: tabella singola (livello selezionato)
  const rows = all.map((q,i)=>rowHTML(q,i)).join("");

  const levelClass = lev === "facile" ? "easy" : (lev === "medio" ? "mid" : "hard");

  wrap.innerHTML = `
    <div class="hint">
      Totale: <b>${all.length}</b> domande
      ${chips.length ? ` ‚Ä¢ ${chips.join(" ‚Ä¢ ")}` : ``}
    </div>
    <table class="level-only ${levelClass}">
      <thead>
        <tr>
          <th>#</th>
          <th>
  <input type="checkbox" id="libCheckAll">
</th>

${thClass}${thSub}<th>Argomento</th><th>Domanda</th><th>Media</th><th>Azioni</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
    `;
}


//SELEZIONA TUTTE LE DOMANDE VISIBILI in ARCHIVIO DOMANDE (e aggiorna contatore + localStorage)
document.addEventListener("change", function(e){
  if(e.target && e.target.id === "libCheckAll"){
    const checked = !!e.target.checked;

    // NOTE: il set 'checked = ...' fatto via JS non scatena l'evento 'change' sui singoli checkbox,
    // quindi aggiorniamo manualmente sia UI che localStorage.
    const boxes = Array.from(document.querySelectorAll("#libWrap .libChk[data-id]"));
    const set = getLibSelectedSet();

    boxes.forEach(cb=>{
      const id = cb.getAttribute("data-id");
      cb.checked = checked;
      if(!id) return;
      if(checked) set.add(id);
      else set.delete(id);
    });

    saveLibSelectedSet(set);
    updateSelectedCountUI();
  }
});





function deleteOne(id){
  const ok = confirm("Cancellare questa domanda?");
  if(!ok) return;
  const all = loadAll().filter(q => q.id !== id);
  saveAll(all);
  renderLibrary();
    refreshTopicSuggestions(true);
}

function short(s, n){
  if(!s) return "";
  return s.length <= n ? s : s.slice(0, n-1) + "‚Ä¶";
}

function escapeHtml(str){
  return (str || "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}


// ================================
// Evidenziazione testo (highlight) per ricerca Archivio
// ================================
function escapeRegExp(s){
  return (s || "").replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
}
function getSearchTokens(search){
  const s = (search || "").trim();
  if(!s) return [];
  // supporta pi√π parole: evidenzio ogni token (min 2 caratteri)
  const tokens = s.split(/\s+/).map(t=>t.trim()).filter(t=>t.length>=2);
  // evita eccesso di regex
  return tokens.slice(0, 6);
}
function highlightText(text, search){
  const raw = (text == null) ? "" : String(text);
  const tokens = getSearchTokens(search);
  if(!tokens.length) return escapeHtml(raw);

  let out = escapeHtml(raw);
  // evidenzia token uno per volta (case-insensitive)
  tokens.forEach(tok=>{
    const re = new RegExp("(" + escapeRegExp(tok) + ")", "ig");
    out = out.replace(re, '<mark class="hl">$1</mark>');
  });
  return out;
}


/** =========================
 *  IMPORT ROBUSTO (preset / pacchetti)
 *  - accetta campi in IT o EN
 *  - normalizza media (img/video)
 *  ========================= */
function normalizeQuestion(raw){
  if(!raw || typeof raw !== "object") return null;

  const q = {};

  // id
  q.id = raw.id || uid();

  // classe / subject / level
  q.class = String(raw.class ?? raw.classe ?? raw.grade ?? "").trim();
  if(!q.class) q.class = "3";
  if(!["3","4","5"].includes(q.class)) q.class = "3";

  q.subject = String(raw.subject ?? raw.disciplina ?? "").trim().toLowerCase();
  if(!q.subject) q.subject = "storia";
  const allowedSubjects = ["storia","geografia","italiano","scienze","matematica"];
  if(!allowedSubjects.includes(q.subject)) q.subject = "storia";

  q.level = String(raw.level ?? raw.livello ?? "").trim().toLowerCase();
  const allowedLevels = ["facile","medio","difficile"];
  if(!allowedLevels.includes(q.level)) q.level = "facile";

  // topic
  q.topic = String(raw.topic ?? raw.argomento ?? "").trim();

  
  // topics extra (argomenti secondari)
  let extra = raw.topicsExtra ?? raw.argomentiSecondari ?? raw.argomenti_extra ?? raw.topics_extra ?? raw.argomentiSecondariList;
  if(extra == null && Array.isArray(raw.argomenti)){
    // se "argomenti" √® un array, consideriamo il primo come principale se manca, e il resto come extra
    extra = raw.argomenti;
    if(!q.topic && extra.length) q.topic = String(extra[0]||"").trim();
    extra = extra.slice(1);
  }
  if(Array.isArray(extra)){
    q.topicsExtra = extra.map(t=>String(t||"").trim()).filter(Boolean);
  }else if(typeof extra === "string"){
    q.topicsExtra = extra.split("|").map(t=>String(t||"").trim()).filter(Boolean);
  }else{
    q.topicsExtra = [];
  }
// question text
  q.question = String(raw.question ?? raw.domanda ?? "").trim();

  // options (2-4) ‚Äî supporta anche oggetti {text,img}
  const ops = raw.options ?? raw.opzioni;
  if(Array.isArray(ops)){
    q.options = ops.map(v=>normalizeOptionInput(v))
      .filter(o=> (optionText(o).trim() !== "" || hasOptionImg(o)));
  }else{
    // fallback (vecchi campi)
    const a = raw.a ?? raw.opzioneA ?? raw.rispostaA ?? "";
    const b = raw.b ?? raw.opzioneB ?? raw.rispostaB ?? "";
    const cOpt = raw.c ?? raw.opzioneC ?? raw.rispostaC ?? "";
    const dOpt = raw.d ?? raw.opzioneD ?? raw.rispostaD ?? "";
    q.options = [a,b,cOpt,dOpt].map(v=>normalizeOptionInput(v))
      .filter(o=> (optionText(o).trim() !== "" || hasOptionImg(o)));
  }

  // servono almeno 2 opzioni
  if(q.options.length < 2) q.options = [q.options[0]||{text:"",img:""}, q.options[1]||{text:"",img:""}];

  // correct index (0..options-1), supporta anche "A/B/C/D"
  let c = raw.correct ?? raw.corretta ?? raw.correttaIndex ?? raw.corretta_index;
  if(typeof c === "string"){
    const up = c.trim().toUpperCase();
    const map = {A:0,B:1,C:2,D:3};
    if(up in map) c = map[up];
  }
  c = parseInt(c, 10);
  if(!Number.isFinite(c) || c < 0 || c >= q.options.length) c = 0;
  q.correct = c;

  // points
  // points
  let p = raw.points ?? raw.punti ?? raw.score ?? raw.punteggio;
  p = parseInt(p, 10);
  if(![5,10,20].includes(p)) p = 10;
  q.points = p;

  // explain
  q.explain = String(raw.explain ?? raw.spiegazione ?? "").trim();

  // media: nuovo formato q.media, oppure legacy img/video
  let media = raw.media ?? null;

  if(!media && raw.img){
    media = { type:"image", src: String(raw.img).trim() };
  }
  if(!media && raw.video){
    media = { type:"video", src: String(raw.video).trim() };
  }

  if(media && typeof media === "object"){
    let t = String(media.type ?? media.tipo ?? "").trim().toLowerCase();
    let src = String(media.src ?? media.path ?? media.percorso ?? "").trim();

    if(!src) src = "";

    // normalizza tipo
    if(t === "img") t = "image";
    if(t === "immagine") t = "image";
    if(t === "none" || t === "nessuno") t = "";

    if((t === "image" || t === "video") && src){
      q.media = { type: t, src };
    }else{
      q.media = null;
    }
  }else{
    q.media = null;
  }

  // valida minimo indispensabile
  if(!q.question || !Array.isArray(q.options) || q.options.length < 2) return null;

  return q;
}

/** =========================
 *  DOMANDE OFFLINE (questions.js)
 *  - Se esiste window.QUESTIONS (caricato da questions.js), le importiamo automaticamente nel localStorage
 *    usando normalizeQuestion(), evitando duplicati tramite "fingerprint".
 *  - Cos√¨: copi la cartella sulla LIM, apri index.html, e le domande sono gi√† disponibili senza import manuale.
 * ========================= */
function fingerprintQuestion(q){
  const media = q.media ? `${q.media.type||""}|${q.media.src||""}` : "";
  const o0 = (q.options && q.options[0]) ? (optionText(q.options[0]) + "|" + optionImg(q.options[0])) : "";
  const o1 = (q.options && q.options[1]) ? (optionText(q.options[1]) + "|" + optionImg(q.options[1])) : "";
  return [
    q.class||"", q.subject||"", q.level||"", q.topic||"",
    (Array.isArray(q.topicsExtra) ? q.topicsExtra.join("|") : ""),
    q.question||"",
    o0,
    o1,
    String(q.correct ?? 0),
    media
  ].join("¬ß");
}


function isNewQuestion(q){
  try{
    if(!window.__FILE_SIGS || !window.__FILE_SIGS.size) return false;
    return !window.__FILE_SIGS.has(fingerprintQuestion(q));
  }catch(e){ return false; }
}

function syncQuestionsFromFile(){
  try{
    const FILE_QUESTIONS = (typeof QUESTIONS !== "undefined" && Array.isArray(QUESTIONS))
      ? QUESTIONS
      : (Array.isArray(window.QUESTIONS) ? window.QUESTIONS : []);

    if(!Array.isArray(FILE_QUESTIONS) || FILE_QUESTIONS.length === 0){
      return {loaded:0, totalFile:0, usedFile:false};
    }

const normalized = [];
    for(const raw of FILE_QUESTIONS){
      const q = normalizeQuestion(raw);
      if(q) normalized.push(q);
    }
    if(normalized.length === 0){
      return {loaded:0, totalFile:0, usedFile:true};
    }

    // SCELTA "pulita": se c'√® questions.js, quello √® LA sorgente.
    // Quindi sovrascriviamo l'archivio locale per evitare confusione (seed, vecchie prove, ecc.)
    // ‚úÖ NUOVO: NON cancellare le domande create in Area Docente.
    // Uniamo le domande del file con quelle gi√† presenti in localStorage (senza duplicati).
    const existing = loadAll();
    if(!Array.isArray(existing) || existing.length === 0){
      saveAll(normalized);
      return {loaded: normalized.length, totalFile: normalized.length, usedFile:true};
    }

    const fileSigs = new Set(normalized.map(fingerprintQuestion));
    
    window.__FILE_SIGS = fileSigs;
const merged = normalized.slice();
    for(const q of existing){
      try{
        const s = fingerprintQuestion(q);
        if(!fileSigs.has(s)) merged.push(q);
      }catch(e){}
    }
    saveAll(merged);
return {loaded: normalized.length, totalFile: normalized.length, usedFile:true};
  }catch(e){
    console.error("syncQuestionsFromFile error:", e);
    return {loaded:0, totalFile:0, usedFile:false, error:true};
  }
}

// Auto-import offline questions.js (sorgente primaria)
document.addEventListener("DOMContentLoaded", ()=>{
  try{ syncQuestionsFromFile(); }catch(e){}
});

function bulkImportQuestions(parsed){
  const list = Array.isArray(parsed) ? parsed : (parsed && Array.isArray(parsed.questions) ? parsed.questions : null);
  if(!list) throw new Error("Formato non valido");

  const all = loadAll();

  // Firma "contenuto" per evitare doppioni anche se cambia l'id
  function sig(q){
    const s = (v)=> (v==null ? "" : String(v)).trim().toLowerCase();

    const cls = q.class ?? q.classe ?? "";
    const subj = q.subject ?? q.disciplina ?? "";
    const lvl = q.level ?? q.livello ?? "";
    const topic = q.topic ?? q.argomento ?? "";
    const question = q.question ?? q.domanda ?? "";

    const opsArr = Array.isArray(q.options) ? q.options
                 : (Array.isArray(q.opzioni) ? q.opzioni : []);
    const opts = opsArr.map(s).join("|");

    const correct = (q.correct ?? q.corretta ?? q.correctIndex ?? q.correttaIndex ?? "");

    const mediaObj = q.media || null;
    const mediaType = mediaObj ? (mediaObj.type ?? mediaObj.tipo ?? "") : "";
    const mediaSrc  = mediaObj ? (mediaObj.src  ?? mediaObj.path ?? mediaObj.percorso ?? "") : "";

    const explain = q.explain ?? q.spiegazione ?? "";

    return [
      s(cls),
      s(subj),
      s(lvl),
      s(topic),
      s(question),
      opts,
      String(correct),
      s(mediaType),
      s(mediaSrc),
      s(explain)
    ].join("¬ß");
  }

  const existingIds = new Set(all.map(x=>x.id));
  const existingSigs = new Set(all.map(sig));

  let imported = 0;
  let skipped = 0;
  let duplicates = 0;

  for(const raw of list){
    const q = normalizeQuestion(raw);
    if(!q){ skipped++; continue; }

    const key = sig(q);

    // Se gi√† esiste una domanda identica, la salto
    if(existingSigs.has(key)){
      duplicates++;
      continue;
    }

    // Evito conflitti di id
    if(existingIds.has(q.id)) q.id = uid();

    existingIds.add(q.id);
    existingSigs.add(key);
    all.push(q);
    imported++;
  }

  // Pulizia finale: se per caso esistevano gi√† doppioni in archivio, li rimuovo
  const seen = new Set();
  const deduped = [];
  let removedExisting = 0;
  for(const q of all){
    const key = sig(q);
    if(seen.has(key)){
      removedExisting++;
      continue;
    }
    seen.add(key);
    deduped.push(q);
  }

  saveAll(deduped);
  return {imported, skipped, duplicates, removedExisting};
}

function importQuestionsJSON(){
  const input = document.createElement("input");
  input.type = "file";
  input.accept = ".json,application/json,text/json";
  input.style.display = "none";
  document.body.appendChild(input);

  input.onchange = () => {
    const file = input.files && input.files[0];
    if(!file){ document.body.removeChild(input); return; }

    const reader = new FileReader();

    reader.onerror = () => {
      alert("‚ùå Non riesco a leggere il file. Riprova oppure usa un altro browser.");
      try{ document.body.removeChild(input); }catch(e){}
    };

    reader.onload = () => {
      try{
        const parsed = JSON.parse(reader.result);
        const res = bulkImportQuestions(parsed);
        alert(`‚úÖ Import completato!
File: ${file.name}
Domande importate: ${res.imported}
Doppioni saltati: ${res.duplicates}
Doppioni rimossi dall\'archivio: ${res.removedExisting}
Saltate (formato incompleto): ${res.skipped}`);
        try{ renderLibrary(); }catch(e){}
      }catch(e){
        console.error(e);
        alert("‚ùå Errore import: JSON non valido oppure formato non riconosciuto.\nSuggerimento: esporta un JSON dal PC e reimporta quello sulla LIM.");
      }finally{
        try{ document.body.removeChild(input); }catch(e){}
      }
    };

    reader.readAsText(file, "utf-8");
  };

  input.click();
}

function importQuestionsJS(){
  const input = document.createElement("input");
  input.type = "file";
  input.accept = ".js,application/javascript,text/javascript";
  input.style.display = "none";
  document.body.appendChild(input);

  function cleanup(){
    try{ document.body.removeChild(input); }catch(e){}
  }

  input.onchange = () => {
    const file = input.files && input.files[0];
    if(!file){ cleanup(); return; }

    const reader = new FileReader();

    reader.onerror = () => {
      alert("‚ùå Non riesco a leggere il file JS. Riprova.");
      cleanup();
    };

    reader.onload = () => {
      try{
        const code = String(reader.result || "");

        // Provo a estrarre l'array assegnato a const QUESTIONS = [...]
        const idx = code.search(/\bQUESTIONS\b/);
        if(idx < 0) throw new Error("Nel file non trovo 'QUESTIONS'.");

        const eq = code.indexOf("=", idx);
        if(eq < 0) throw new Error("Formato non valido: manca '='.");

        const startArr = code.indexOf("[", eq);
        if(startArr < 0) throw new Error("Formato non valido: manca '['.");

        // bracket matching per trovare la fine dell'array
        let depth = 0;
        let endArr = -1;
        for(let i = startArr; i < code.length; i++){
          const ch = code[i];
          if(ch === "[") depth++;
          else if(ch === "]"){
            depth--;
            if(depth === 0){ endArr = i; break; }
          }
        }
        if(endArr < 0) throw new Error("Non riesco a chiudere l'array 'QUESTIONS'.");

        const arrayLiteral = code.slice(startArr, endArr + 1);
        let parsed = null;

        // 1) via JSON.parse (l'export del gioco usa JSON.stringify => OK)
        try{
          parsed = JSON.parse(arrayLiteral);
        }catch(e){
          // 2) fallback: eseguo in sandbox e leggo QUESTIONS
          parsed = (new Function(code + "; return (typeof QUESTIONS!=='undefined') ? QUESTIONS : null;"))();
        }

        if(!Array.isArray(parsed)) throw new Error("Nel file JS 'QUESTIONS' non √® un array.");

        const res = bulkImportQuestions(parsed);
        alert(`‚úÖ Import JS completato!
File: ${file.name}
Domande importate: ${res.imported}
Doppioni saltati: ${res.duplicates}
Doppioni rimossi dall'archivio: ${res.removedExisting}
Saltate (formato incompleto): ${res.skipped}`);

        try{ renderLibrary(); }catch(e){}
        try{ renderTeacherStats(); }catch(e){}
      }catch(err){
        console.error(err);
        alert("‚ùå Import JS fallito: " + (err && err.message ? err.message : err));
      }finally{
        cleanup();
      }
    };

    reader.readAsText(file, "utf-8");
  };

  input.click();
}

function exportJSON(){
  const data = loadAll();
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "quiz_multimateria_domande.json";
  a.click();
  URL.revokeObjectURL(url);
}

function normalizeToItalianKeys(q){
  // Se gi√† in formato italiano, lo lasciamo com'√®
  if(q && typeof q === "object" && ("classe" in q || "domanda" in q)) return q;

  // Altrimenti adattiamo (compatibilit√†)
  const media = q && (q.media || q.Media) ? (q.media || q.Media) : null;
  const out = {
    classe: (q.class ?? q.classe ?? q.cls ?? q.classe),
    disciplina: (q.subject ?? q.disciplina),
    livello: (q.level ?? q.livello),
    argomento: (q.topic ?? q.argomento ?? ""),
    argomentiSecondari: (Array.isArray(q.topicsExtra) ? q.topicsExtra : (Array.isArray(q.argomentiSecondari) ? q.argomentiSecondari : [])),
    domanda: (q.question ?? q.domanda),
    opzioni: (q.options ?? q.opzioni ?? []),
    corretta: (q.correct ?? q.corretta ?? 0)
  };
  if(media){
    out.media = {
      tipo: (media.tipo ?? media.type ?? "img"),
      src: (media.src ?? media.path ?? "")
    };
  }
  out.explain = (q.explain ?? q.spiegazione ?? q.explanation ?? "");

  return out;
}
function exportQuestionsJS(){
  // Export "stile Ruota": genera un file questions.js con dentro: const QUESTIONS = [...];
  try{
    const data = loadAll().map(normalizeToItalianKeys);
    const content = "const QUESTIONS = " + JSON.stringify(data, null, 2) + ";\n";
    const blob = new Blob([content], { type: "application/javascript" });

    // 1) Edge/IE legacy
    if (window.navigator && typeof window.navigator.msSaveOrOpenBlob === "function") {
      window.navigator.msSaveOrOpenBlob(blob, "questions.js");
      return;
    }

    // 2) Download standard via <a>
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "questions.js";
    a.rel = "noopener";
    a.style.display = "none";
    document.body.appendChild(a);

    // click "semplice" (pi√π compatibile di dispatchEvent)
    a.click();

    setTimeout(() => {
      URL.revokeObjectURL(url);
      a.remove();
    }, 400);

    // 3) NIENTE fallback automatico (zero confusione).
    // Se un PC blocca i download da file://, usa un tasto separato "Copia questions.js"
    // oppure richiama manualmente: openExportFallbackModal(content);

  }catch(err){
    console.error("Export questions.js fallito:", err);
    alert("Export questions.js non riuscito. Apri F12 > Console per vedere l'errore.");
  }
}






// Fallback ‚Äúpulito‚Äù: mostra il contenuto del questions.js copiabile (se i download sono bloccati su file://)


function exportFullBackup(){
  // Esporta SOLO le chiavi dell'app (prefisso QM_)
  const backup = {
    app: "Quiz Multimateria",
    format: "QM_BACKUP_V1",
    exportedAt: new Date().toISOString(),
    keys: {}
  };
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(k && k.startsWith("QM_")){
      backup.keys[k] = localStorage.getItem(k);
    }
  }
  const blob = new Blob([JSON.stringify(backup, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "quiz_multimateria_backup_totale.json";
  a.click();
  URL.revokeObjectURL(url);
}

function importFullBackup(){
  const input = document.createElement("input");
  input.type = "file";
  input.accept = ".json,application/json,text/json";
  input.style.display = "none";
  document.body.appendChild(input);

  input.onchange = () => {
    const file = input.files && input.files[0];
    if(!file){ document.body.removeChild(input); return; }

    const reader = new FileReader();

    reader.onerror = () => {
      alert("‚ùå Non riesco a leggere il file di backup. Riprova oppure usa un altro browser.");
      try{ document.body.removeChild(input); }catch(e){}
    };

    reader.onload = () => {
      try{
        const parsed = JSON.parse(reader.result);

        // accetta sia backup completo (chiavi QM_) sia oggetto {questions:[]}
        if(parsed && parsed.app === "Quiz Multimateria" && parsed.store && typeof parsed.store === "object"){
          for(const k of Object.keys(parsed.store)){
            localStorage.setItem(k, parsed.store[k]);
          }
          alert(`‚úÖ Backup ripristinato!
File: ${file.name}
Ora ricarico la pagina‚Ä¶`);
          location.reload();
          return;
        }

        // fallback: importa come domande
        const res = bulkImportQuestions(parsed);
        alert(`‚úÖ Import completato!
File: ${file.name}
Domande importate: ${res.imported}
Saltate: ${res.skipped}`);
        try{ renderLibrary(); }catch(e){}

      }catch(e){
        console.error(e);
        alert("‚ùå Errore: il file non √® un JSON valido o non √® un backup riconosciuto.");
      }finally{
        try{ document.body.removeChild(input); }catch(e){}
      }
    };

    reader.readAsText(file, "utf-8");
  };

  input.click();
}





function clearAllHighlights(){
  for(let i=1;i<=4;i++){
    const c = document.getElementById("cardP"+i);
    if(!c) continue;
    c.classList.remove("active","winner");
  }
}

function closeScoreModal(){
  stopFinalScoreSound();
  const ov = document.getElementById("scoreOverlay");
  if(ov) ov.remove();
  document.removeEventListener("keydown", _scoreEscHandler);
}
function _scoreEscHandler(e){
  if(e.key === "Escape") closeScoreModal();
}

function getAvatarSrcByIdx(i){
  const card = document.getElementById("cardP"+(i+1));
  if(!card) return "";
  const img = card.querySelector(".avatar img");
  if(!img) return "";
  // se √® nascosta o non caricata, potrebbe avere src vuoto
  return img.getAttribute("src") || img.src || "";
}

function openScoreModal(scores, winnersIdx){
  closeScoreModal();

  const ov = document.createElement("div");
  ov.id = "scoreOverlay";
  ov.className = "scoreOverlay";
  ov.addEventListener("click", (e)=>{
    if(e.target === ov) closeScoreModal();
  });

  const card = document.createElement("div");
  card.className = "scoreModal";

  // Titolo + sottotitolo
  const title = document.createElement("div");
  title.className = "scoreTitle";
  title.textContent = "üèÅ Punteggio finale";
  card.appendChild(title);

  const sub = document.createElement("div");
  sub.className = "scoreSub";
  sub.textContent = winnersIdx.length === 1 ? "üèÜ Vincitore" : "ü§ù Parit√†";
  card.appendChild(sub);

  // Winners (grandi)
  const winnersWrap = document.createElement("div");
  winnersWrap.className = "winnersWrap";

  winnersIdx.forEach(i=>{
    const nm = (playerNames && playerNames[i]) ? playerNames[i] : `G${i+1}`;
    const sc = scores[i] || 0;
    const av = getAvatarSrcByIdx(i);

    const w = document.createElement("div");
    w.className = "winnerBig";

    w.innerHTML = `
      <div class="winnerAvatar">
        ${av ? `<img src="${av}" alt="${nm}">` : `<div class="winnerAvatarFallback">${nm.slice(0,1).toUpperCase()}</div>`}
      </div>
      <div class="winnerInfo">
        <div class="winnerName">${nm}</div>
        <div class="winnerPts">${sc} punti</div>
      </div>
    `;
    winnersWrap.appendChild(w);
  });

  card.appendChild(winnersWrap);

  // Altri punteggi (piccoli)
  const list = document.createElement("div");
  list.className = "scoreList";

  const order = Array.from({length: playerCount}, (_,i)=>i)
    .sort((a,b)=>(scores[b]||0)-(scores[a]||0));

  order.forEach(i=>{
    const nm = (playerNames && playerNames[i]) ? playerNames[i] : `G${i+1}`;
    const sc = scores[i] || 0;
    const av = getAvatarSrcByIdx(i);
    const isWinner = winnersIdx.includes(i);

    const row = document.createElement("div");
    row.className = "scoreRow" + (isWinner ? " isWinner" : "");
    row.innerHTML = `
      <div class="miniAvatar">
        ${av ? `<img src="${av}" alt="${nm}">` : `<span>${nm.slice(0,1).toUpperCase()}</span>`}
      </div>
      <div class="miniName">${nm}</div>
      <div class="miniPts">${sc}</div>
    `;
    list.appendChild(row);
  });

  card.appendChild(list);

  // Azioni
  // Azioni
const actions = document.createElement("div");
actions.className = "scoreActions";
actions.innerHTML = `
  <button class="btn primary"
    style="width:auto;max-width:none;margin:0;padding:14px 18px;border-radius:14px"
    onclick="closeScoreModal(); window.location.href='index_quiz.html';">
    Chiudi
  </button>
`;

  card.appendChild(actions);

  ov.appendChild(card);
  document.body.appendChild(ov);

  document.addEventListener("keydown", _scoreEscHandler);
}


function showLevelDoneModal(){
  const bd = document.getElementById("levelDoneBackdrop");
  if(!bd) return;

  // aggiorna numeri (usa variabili reali del gioco)
  const p = document.getElementById("levelDonePlayers");
  const q = document.getElementById("levelDoneQuestions");
  const playersN = (typeof playerCount === "number" && playerCount) ? playerCount : 1;
  const questionsN = (Array.isArray(currentList) && currentList.length) ? currentList.length : 0;
  if(p) p.textContent = String(playersN);
  if(q) q.textContent = String(questionsN);

  bd.style.display = "flex";
  requestAnimationFrame(()=> bd.classList.add("show"));

  // click outside closes
  bd.onclick = (e)=>{ if(e.target === bd) closeLevelDoneModal(); };

  // buttons
  const ok = document.getElementById("btnLevelOk");
  const sc = document.getElementById("btnLevelScore");
  if(ok) ok.onclick = ()=> closeLevelDoneModal();
  if(sc) sc.onclick = ()=>{ closeLevelDoneModal(); try{ if(typeof revealScore === "function") revealScore(); }catch(e){} };

  // ESC closes
  window.addEventListener("keydown", levelDoneEscHandler);
}


function levelDoneEscHandler(e){
  if(e.key === "Escape") closeLevelDoneModal();
}
function closeLevelDoneModal(){
  const bd = document.getElementById("levelDoneBackdrop");
  if(!bd) return;
  bd.classList.remove("show");
  setTimeout(()=>{ bd.style.display = "none"; }, 180);
  window.removeEventListener("keydown", levelDoneEscHandler);

  // ‚úÖ dopo aver chiuso il popup "Livello completato", mostra il bottone tondo del punteggio
  try{
    if(gameFinished){
      const b = document.getElementById("showScoreBtn");
      if(b) b.style.display = "inline-flex";
    }
  }catch(e){}
}


// ================================
// SUONO FINE PARTITA (PUNTEGGIO FINALE)
// Metti il file qui: audio/final_score.mp3  (puoi cambiarlo se vuoi)
// ================================
let _finalScoreAudio = null;

let _finalScoreUnlocked = false;

// Sblocca l'audio "vittoria" al primo tocco/click (evita blocchi autoplay su Chrome/Safari)
function unlockFinalScoreAudio(){
  if(_finalScoreUnlocked) return;
  _finalScoreUnlocked = true;
  try{
    const el = document.getElementById("soundFinalScore");
    if(!el) return;

    // play muto + stop immediato: serve solo per "autorizzare" il canale audio
    const prevVol = el.volume;
    el.volume = 0;
    el.currentTime = 0;
    const p = el.play();
    if(p && typeof p.then === "function"){
      p.then(()=>{
        el.pause();
        el.currentTime = 0;
        el.volume = prevVol ?? 1;
      }).catch(()=>{});
    }else{
      // fallback
      el.pause();
      el.currentTime = 0;
      el.volume = prevVol ?? 1;
    }
  }catch(e){}
}

// Aggancia lo sblocco al primo gesto utente
window.addEventListener("pointerdown", unlockFinalScoreAudio, { once:true, passive:true });
window.addEventListener("keydown", unlockFinalScoreAudio, { once:true });


function playFinalScoreSound(){
  // Riproduce la musica della vittoria appena premi "MOSTRA PUNTEGGIO".
  // Super-robusto: prova pi√π percorsi possibili (cos√¨ funziona anche se il file √® in una cartella diversa).
  try{ unlockFinalScoreAudio(); }catch(e){}

  const candidates = [
    // file richiesto
    "audio/super_mario_vittoria.mp3",
    // pi√π probabili (aggiungi pure altri nomi/file se li hai)
    "audio/vittoria.mp3",
    "audio/vittoria.wav",
    "audio/vittoria.m4a",
    "audio/victory.mp3",
    "audio/win.mp3",
    "file_audio/vittoria.mp3",
    "file_audio/vittoria.wav",
    "file_audio/vittoria.m4a",
    // fallback: quello gi√† presente nel progetto
    "audio/effetto_sonoro_din.mp3"
  ];

  const el = document.getElementById("soundFinalScore");

  function tryPlayOnElement(i){
    if(!el) return false;
    if(i >= candidates.length) return false;

    const url = candidates[i];

    try{ el.pause(); }catch(e){}
    try{ el.currentTime = 0; }catch(e){}
    try{ el.muted = false; el.volume = 1; }catch(e){}

    // imposta direttamente il src sull'elemento <audio> (pi√π affidabile del <source>)
    try{
      el.src = url;
      el.load();
    }catch(e){}

    let settled = false;

    // se il file non esiste o non si carica, passa al prossimo
    el.onerror = () => {
      if(settled) return;
      settled = true;
      tryPlayOnElement(i+1);
    };

    const p = el.play();
    if(p && typeof p.then === "function"){
      p.then(()=>{
        settled = true;
      }).catch(()=>{
        if(settled) return;
        settled = true;
        tryPlayOnElement(i+1);
      });
    }else{
      // vecchi browser: se non parte, prova il prossimo
      setTimeout(()=>{
        if(settled) return;
        tryPlayOnElement(i+1);
      }, 200);
    }
    return true;
  }

  // 1) prova con l'elemento audio dedicato
  if(tryPlayOnElement(0)) return;

  // 2) fallback estremo: new Audio con gli stessi tentativi
  (function tryNewAudio(i){
    if(i >= candidates.length) return;
    const a = new Audio(candidates[i]);
    a.volume = 1;
    a.onended = ()=>{};
    a.onerror = ()=> tryNewAudio(i+1);
    const p = a.play();
    if(p && typeof p.then === "function"){
      p.catch(()=> tryNewAudio(i+1));
    }
  })(0);
}

function stopFinalScoreSound(){
  // Ferma la musica della vittoria (senza rompere il popup)
  try{
    const el = document.getElementById("soundFinalScore");
    if(el){
      el.pause();
      el.currentTime = 0;
    }
  }catch(e){}
  try{
    if(window.__finalScoreAudioTmp){
      window.__finalScoreAudioTmp.pause();
      window.__finalScoreAudioTmp.currentTime = 0;
    }
  }catch(e){}
}





function revealScore(){
  const pill = document.getElementById("pillScore");
  const btn = document.getElementById("showScoreBtn");
  if(pill) pill.style.display = "none";
  if(btn) btn.style.display = "none";

  // evidenzia SOLO i vincitori al click
  clearAllHighlights();

  const scores = playerScores.map(v => (v||0));
  const max = Math.max(...scores);
  const winnersIdx = [];
  for(let i=0;i<playerCount;i++){
    if((scores[i]||0) === max) winnersIdx.push(i);
  }
  winnersIdx.forEach(i=>{
    const c = document.getElementById("cardP"+(i+1));
    if(c) c.classList.add("winner");
  });

  updatePlayerCards();

  // Suono finale + popup moderno al centro
  // Prima apriamo il popup (cos√¨ appare sempre), poi avviamo l'audio.
  openScoreModal(scores, winnersIdx);
  setTimeout(()=>{ try{ playFinalScoreSound(); }catch(e){} }, 50);
}


function updatePlayerCards(){
  // Avatar: metti i file in img/players/ con nome p1, p2, p3, p4
  // Estensione libera tra: png, jpg, jpeg, webp, gif
  const avatarBase = [
    "img/players/p1",
    "img/players/p2",
    "img/players/p3",
    "img/players/p4"
  ];
  const exts = ["png","jpg","jpeg","webp","gif"];

  const map = [
    {id:"cardP1", idx:0},
    {id:"cardP2", idx:1},
    {id:"cardP3", idx:2},
    {id:"cardP4", idx:3},
  ];

  function trySetAvatar(imgEl, basePath, extIndex = 0){
    if(!imgEl) return;

    if(extIndex >= exts.length){
      imgEl.style.display = "none";
      imgEl.onerror = null;
      return;
    }

    imgEl.style.display = "block";
    imgEl.onerror = () => trySetAvatar(imgEl, basePath, extIndex + 1);
    imgEl.src = `${basePath}.${exts[extIndex]}`;
  }

  map.forEach(m=>{
    const el = document.getElementById(m.id);
    if(!el) return;

    if(m.idx >= playerCount){
      el.style.display = "none";
      return;
    }
    el.style.display = "";

    const pts = playerScores[m.idx] || 0;
    const nm = (playerNames && playerNames[m.idx]) ? playerNames[m.idx] : `Giocatore ${m.idx+1}`;

    // Creo HTML (senza src fisso)
    el.innerHTML = `
      <div class="avatar">
        <img alt="avatar ${m.idx+1}">
      </div>
      <div class="pName">${nm}</div>
      
    `;

    // Imposto avatar con fallback estensioni
    const imgEl = el.querySelector(".avatar img");
    const base = avatarBase[m.idx] || avatarBase[0];
    trySetAvatar(imgEl, base, 0);

    if(!gameFinished){
      if(m.idx === currentPlayer) el.classList.add("active");
      else el.classList.remove("active");
    }else{
      el.classList.remove("active");
    }
  });
}


// =========================
// HOME: gestione campi NOMI (sincronizzati con il selettore giocatori)
// =========================
function syncPlayerNameInputs(){
  const sp = document.getElementById("selPlayers");
  const c = sp ? (parseInt(sp.value,10) || 1) : 1;
  const inputs = [
    document.getElementById("pName1"),
    document.getElementById("pName2"),
    document.getElementById("pName3"),
    document.getElementById("pName4")
  ];
  inputs.forEach((inp,i)=>{
    if(!inp) return;
    inp.style.display = (i < c) ? "" : "none";
  });
}

function readPlayerNames(){
  const inputs = [
    document.getElementById("pName1"),
    document.getElementById("pName2"),
    document.getElementById("pName3"),
    document.getElementById("pName4")
  ];
  const defaults = ["Team Blu","Team Gialli","Team Viola","Team Fucsia"];
  playerNames = inputs.map((inp,i)=>{
    const def = defaults[i] || `Giocatore ${i+1}`;
    if(!inp) return def;
    const v = (inp.value || "").trim();
    return v ? v : def;
  });
}

// Bind una sola volta
document.addEventListener("DOMContentLoaded", ()=>{
  // Inizializza Area Docente (2 opzioni di default)
  if(document.getElementById("tOptionsWrap")){
    buildTeacherOptions(["",""]); 
  }

const sp = document.getElementById("selPlayers");
  if(sp) sp.addEventListener("change", ()=>{ syncPlayerNameInputs(); readPlayerNames(); });

  ["pName1","pName2","pName3","pName4"].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener("input", readPlayerNames);
  });

  syncPlayerNameInputs();
  readPlayerNames();

  // ‚úÖ Parametri da HOME: classe/discipline/livello/topics/numQ (prima di costruire argomenti)
  try{
    const cls = window.__URL_CLASSE || "";
    const sub = window.__URL_DISCIPLINA || "";
    const lev = window.__URL_LIVELLO || "";
    const nq = window.__URL_NUMQ;

    if(cls && document.getElementById("selClass")) document.getElementById("selClass").value = cls;
    if(sub && document.getElementById("selSubject")) document.getElementById("selSubject").value = sub;
    if(lev && document.getElementById("selLevel")) document.getElementById("selLevel").value = lev;

    if(nq && document.getElementById("selNumQ")) document.getElementById("selNumQ").value = String(nq);

    // costruisce checklist argomenti coerente ai filtri
    try{ buildTopicChecklist(); }catch(e){}
    try{ updateTopicSummary(); }catch(e){}

    // se arrivano topics=..., prova anche a spuntare le checkbox corrispondenti
    if(Array.isArray(window.__URL_TOPICS) && window.__URL_TOPICS.length){
      const wanted = window.__URL_TOPICS.map(_normTopic);
      const boxes = Array.from(document.querySelectorAll("#topicChecklist input[type='checkbox']"));
      boxes.forEach(cb=>{
        const v = _normTopic(cb.value);
        cb.checked = wanted.includes(v);
      });
    }

    try{ updateTopicSummary(); }catch(e){}
    try{ renderPickQuestions(); }catch(e){}
  }catch(e){}


  // Deep-link (da index.html): ?screen=teacher oppure ?screen=library  (+players)
  try{
    const params = new URLSearchParams(location.search);
    const pl = parseInt(params.get("players") || "", 10);
    if(pl && document.getElementById("selPlayers")){
      document.getElementById("selPlayers").value = String(Math.min(4, Math.max(1, pl)));
      syncPlayerNameInputs();
      readPlayerNames();
    }
    const scr = (params.get("screen") || "").toLowerCase();
    if(scr === "teacher") openTeacher();
    if(scr === "library") openLibrary();
  }catch(e){}


  try{ setActiveNav(document.querySelector(".screen.active")?.id || "home"); }catch(e){}
});

</script>
<!-- Suoni feedback quiz -->
<audio id="soundCorrect" preload="auto">
<source src="audio/effetto_sonoro_din.mp3" type="audio/mpeg"/>
</audio>
<audio id="soundWrong" preload="auto">
<source src="audio/taglio.mp3" type="audio/mpeg"/>
</audio>
<audio id="soundFinalScore" preload="auto">
  <source src="audio/effetto_sonoro_din.mp3" type="audio/mpeg"/>
</audio>

<script>

// ================================

// ================================
// ARGOMENTI: pannello a scomparsa + ricerca
// ================================
function toggleTopicPanel(forceOpen){
  const panel = document.getElementById("topicPanel");
  const chev = document.getElementById("topicChevron");
  if(!panel || !chev) return;
  const shouldOpen = (typeof forceOpen === "boolean") ? forceOpen : !panel.classList.contains("open");
  if(shouldOpen){
    panel.classList.add("open");
    chev.textContent = "‚ñ¥";
    // focus sulla ricerca
    const s = document.getElementById("topicSearch");
    if(s) setTimeout(()=>s.focus(), 0);
  }else{
    panel.classList.remove("open");
    chev.textContent = "‚ñæ";
  }
}

function applyTopicSearchFilter(){
  const q = (document.getElementById("topicSearch")?.value || "").trim().toLowerCase();
  const wrap = document.getElementById("topicChecklist");
  if(!wrap) return;
  const items = Array.from(wrap.querySelectorAll(".topicItem"));
  items.forEach(it=>{
    const label = (it.getAttribute("data-label") || "").toLowerCase();
    it.style.display = (!q || label.includes(q)) ? "" : "none";
  });
}

function selectAllTopics(state){
  const wrap = document.getElementById("topicChecklist");
  if(!wrap) return;
  wrap.querySelectorAll('input[type="checkbox"][data-topic]').forEach(ch=>{
    ch.checked = !!state;
  });

  // salva preferenze
  const cls = document.getElementById("selClass")?.value || "";
  const subject = document.getElementById("selSubject")?.value || "";
  const level = document.getElementById("selLevel")?.value || "";
  if(cls && subject && level) saveTopicPrefs(cls, subject, level);

  updateTopicSummary();

  // IMPORTANTISSIMO: il click sul bottone non scatena l'evento "change",
  // quindi forziamo l'aggiornamento della lista domande sotto (picker).
  try{ renderPickQuestions(); }catch(e){}
}


function resetTopicPrefs(){
  const numQEl = document.getElementById("selNumQ");
  const cls = document.getElementById("selClass")?.value || "";
  const subject = document.getElementById("selSubject")?.value || "";
  const level = document.getElementById("selLevel")?.value || "";
  // Ripristina: rimuove le preferenze salvate per questa combinazione (cls|disciplina|livello)
  if(cls && subject && level){
    const sig = metaSig(cls, subject, level);
    localStorage.removeItem("pref_numQ_"+sig);
    localStorage.removeItem("pref_topics_"+sig);
  }
  if(numQEl) numQEl.value = "10";
  // ricostruisci elenco: default = tutti selezionati
  buildTopicChecklist();
  updateTopicSummary();
}

function updateTopicSummary(){
  const cls = document.getElementById("selClass")?.value || "";
  const subject = document.getElementById("selSubject")?.value || "";
  const level = document.getElementById("selLevel")?.value || "";
  const summary = document.getElementById("topicSummary");
  const title = document.querySelector("#topicHeaderBtn .topicHeaderTitle");
  const wrap = document.getElementById("topicChecklist");
  if(!summary || !title || !wrap) return;

  if(!cls || !subject || !level){
    title.textContent = "Seleziona argomenti";
    summary.textContent = "Seleziona prima classe, disciplina e livello‚Ä¶";
    return;
  }

  const checks = Array.from(wrap.querySelectorAll('input[type="checkbox"][data-topic]'));
  const total = checks.length;
  const sel = checks.filter(c=>c.checked).length;

  // Se nessuno selezionato -> significato: tutti (come regola del gioco)
  if(sel === 0){
    title.textContent = `Argomenti (tutti)`;
  }else{
    title.textContent = `Argomenti (${sel} selezionati)`;
  }

  // elenco breve
  const names = checks
    .filter(c=>c.checked)
    .slice(0,3)
    .map(c=>c.closest(".topicItem")?.getAttribute("data-label") || "")
    .filter(Boolean);

  if(sel === 0){
    summary.textContent = "Nessuna spunta: verranno inclusi tutti gli argomenti.";
  }else if(names.length === 0){
    summary.textContent = `${sel} su ${total} selezionati.`;
  }else{
    summary.textContent = names.join(", ") + (sel > 3 ? "‚Ä¶" : "");
  }
  updateTopicCounts();
  try{ renderTopicChips(); }catch(e){}

}


function updateTopicCounts(){
  const cls = document.getElementById("selClass")?.value || "";
  const subject = document.getElementById("selSubject")?.value || "";
  const level = document.getElementById("selLevel")?.value || "";
  const box = document.getElementById("topicCounts");
  if(!box) return;

  if(!cls || !subject || !level){
    box.textContent = "";
    return;
  }

  const all = loadAll();
  const base = all.filter(q =>
    q.class === cls &&
    q.subject === subject &&
    (level === "ALL" || q.level === level)
  );

  const totalQuestions = base.length;

  // argomenti unici (conta anche "Senza argomento")
  const topicSet = new Set(base.flatMap(q => { const t = questionTopics(q); return t.length ? t : ["__NONE__"]; }));
  const totalTopics = topicSet.size;

  // se hai spuntato argomenti, conta solo quelli; se nessuno spuntato => tutti
  let selectedTopics = getSelectedTopics();
  // ‚úÖ se arrivo dalla HOME con topics=..., uso quelli (anche se la checklist non √® ancora spuntata)
  if(Array.isArray(window.__URL_TOPICS) && window.__URL_TOPICS.length){
    selectedTopics = window.__URL_TOPICS.slice();
  }
  const wantAll = selectedTopics.length === 0;
  const filteredQuestions = wantAll ? totalQuestions : base.filter(q => questionHasAnyTopic(q, selectedTopics)).length;

  if(totalQuestions === 0){
    box.textContent = `0 argomenti ‚Ä¢ 0 domande`;
    return;
  }

  box.textContent = `${totalTopics} argomenti ‚Ä¢ ${filteredQuestions} domande`;
}



// NUMERO DOMANDE + CHECKBOX ARGOMENTI (Home)
// ================================
function metaSig(cls, subject, level){
  return `${cls||""}|${subject||""}|${level||""}`;
}

function getSelectedTopics(){
  const wrap = document.getElementById("topicChecklist");
  if(!wrap) return [];
  const checks = Array.from(wrap.querySelectorAll('input[type="checkbox"][data-topic]'));
  return checks.filter(c=>c.checked).map(c=>c.getAttribute("data-topic"));
}

function saveTopicPrefs(cls, subject, level){
  const sig = metaSig(cls, subject, level);
  const numQEl = document.getElementById("selNumQ");
  const numQ = numQEl ? (numQEl.value || "10") : "10";
  const topics = getSelectedTopics();
  localStorage.setItem("pref_numQ_"+sig, numQ);
  localStorage.setItem("pref_topics_"+sig, JSON.stringify(topics));
}

function loadTopicPrefs(cls, subject, level){
  const sig = metaSig(cls, subject, level);
  const numQ = localStorage.getItem("pref_numQ_"+sig);
  let topics = [];
  try{
    topics = JSON.parse(localStorage.getItem("pref_topics_"+sig) || "[]");
    if(!Array.isArray(topics)) topics = [];
  }catch(e){ topics = []; }
  return {numQ, topics};
}

function buildTopicChecklist(){
  const cls = document.getElementById("selClass")?.value || "";
  const subject = document.getElementById("selSubject")?.value || "";
  const level = document.getElementById("selLevel")?.value || "";
  const wrap = document.getElementById("topicChecklist");
  const numQEl = document.getElementById("selNumQ");
  if(!wrap || !numQEl) return;

  if(!cls || !subject || !level){
    wrap.innerHTML = '<div class="topicCount">Seleziona prima classe, disciplina e livello‚Ä¶</div>';
    return;
  }

  const all = loadAll();
  const map = new Map(); // topic -> count
  all.forEach(q=>{
    if(q.class !== cls || q.subject !== subject || (level !== "ALL" && q.level !== level)) return;

    const topics = questionTopics(q);
    if(!topics.length){
      map.set("__NONE__", (map.get("__NONE__")||0) + 1);
      return;
    }
    topics.forEach(tt=>{
      const t = (tt || "__NONE__");
      const key = String(t).trim() || "__NONE__";
      map.set(key, (map.get(key)||0) + 1);
    });
  });

  const topics = Array.from(map.keys()).sort((a,b)=>{
    const aa = (a==="__NONE__") ? "zzz" : a;
    const bb = (b==="__NONE__") ? "zzz" : b;
    return aa.localeCompare(bb, "it", {sensitivity:"base"});
  });

  const prefs = loadTopicPrefs(cls, subject, level);
  if(prefs.numQ) numQEl.value = prefs.numQ;

  const savedTopics = prefs.topics || [];
  const hasSaved = savedTopics.length > 0;

  wrap.innerHTML = topics.map(t=>{
    const label = (t==="__NONE__") ? "Senza argomento" : t;
    const checked = hasSaved ? savedTopics.includes(t) : true; // default: tutti selezionati
    const count = map.get(t) || 0;
    return `
      <div class="topicItem" data-label="${escapeAttr(label)}">
        <div class="topicLeft">
          <input type="checkbox" data-topic="${escapeAttr(t)}" ${checked ? "checked":""}>
          <div>${escapeHtml(label)}</div>
        </div>
        <div class="topicCount">${count}</div>
      </div>
    `;
  }).join("");

  // Selezione cambia => salva prefs
  wrap.querySelectorAll('input[type="checkbox"][data-topic]').forEach(ch=>{
    ch.addEventListener("change", ()=>{ saveTopicPrefs(cls, subject, level); updateTopicSummary(); try{ renderPickQuestions(); }catch(e){} });
  });
  numQEl.addEventListener("change", ()=>saveTopicPrefs(cls, subject, level));
  // ricerca + riepilogo
  const searchEl = document.getElementById("topicSearch");
  if(searchEl){
    searchEl.oninput = applyTopicSearchFilter;
    // reset filtro quando ricostruisci
    if(searchEl.value) applyTopicSearchFilter();
  }
  updateTopicSummary();
  try{ renderPickQuestions(); }catch(e){}

  updateTopicCounts();
}

// Aggiorna argomenti quando cambiano i filtri home
document.addEventListener("DOMContentLoaded", ()=>{
  ["selClass","selSubject","selLevel"].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener("change", buildTopicChecklist);
  });
  const numQEl = document.getElementById("selNumQ");
  if(numQEl) numQEl.addEventListener("change", ()=>{
    const cls = document.getElementById("selClass")?.value || "";
    const subject = document.getElementById("selSubject")?.value || "";
    const level = document.getElementById("selLevel")?.value || "";
    if(cls && subject && level) saveTopicPrefs(cls, subject, level);
  });

  // prima costruzione (nel caso siano gi√† memorizzati i filtri)
  buildTopicChecklist();
});


// ===== PLACEHOLDER SELECT + MEMORIZZA SELEZIONI (OPZIONE B) =====
(function() {
  function setupSelectRemember(ids, storagePrefix) {
    ids.forEach((id) => {
      const sel = document.getElementById(id);
      if(!sel) return;

      const key = storagePrefix + "_" + id;
      const saved = localStorage.getItem(key);

      // se c'√® un valore salvato lo ripristino, altrimenti lascio vuoto (placeholder visibile)
      if(saved !== null && saved !== "") {
        sel.value = saved;
      } else {
        sel.value = "";
      }

      // applica stile placeholder
      if(sel.value === "") sel.classList.add("is-placeholder");
      else sel.classList.remove("is-placeholder");

      sel.addEventListener("change", () => {
        localStorage.setItem(key, sel.value);
        if(sel.value === "") sel.classList.add("is-placeholder");
        else sel.classList.remove("is-placeholder");
      });
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    // Home / Filtri gioco
    setupSelectRemember(["selClass","selSubject","selLevel"], "last");
    // Area docente (inserimento domanda)
    setupSelectRemember(["tClass","tSubject","tLevel"], "last");
    // Filtri archivio
    setupSelectRemember(["fClass","fSubject","fLevel"], "last");
  });
})();



// ================================
// Import JSON via INCOLLA (utile su LIM)
// ================================
function openPasteJSON(mode){
  // mode: "questions" | "backup"
  const overlay = document.createElement("div");
  overlay.className = "pasteOverlay";
  overlay.innerHTML = `
    <div class="pasteCard">
      <h3>üìã Incolla ${mode==="backup" ? "BACKUP TOTALE" : "DOMANDE"} (JSON)</h3>
      <div style="font-size:12px;color:#556;margin-bottom:8px">
        Copia il contenuto del file .json e incollalo qui. Poi premi ‚ÄúImporta‚Äù.
      </div>
      <textarea id="pasteJsonArea" class="pasteArea" placeholder='Incolla qui il JSON...'></textarea>
      <div class="pasteActions">
        <button class="btn soft" type="button" onclick="closePasteJSON()">Annulla</button>
        <button class="btn primary" type="button" onclick="confirmPasteJSON('${'${mode}'}')">Importa</button>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);
  overlay.addEventListener("click", (e)=>{ if(e.target===overlay) closePasteJSON(); });
  setTimeout(()=>{ document.getElementById("pasteJsonArea")?.focus(); }, 0);
}

function closePasteJSON(){
  const el = document.querySelector(".pasteOverlay");
  if(el) el.remove();
}

function confirmPasteJSON(mode){
  const area = document.getElementById("pasteJsonArea");
  const raw = (area ? area.value : "").trim();
  if(!raw){ alert("Incolla prima un contenuto JSON."); return; }

  try{
    const parsed = JSON.parse(raw);

    if(mode === "backup"){
      if(parsed && parsed.app === "Quiz Multimateria" && parsed.store && typeof parsed.store === "object"){
        for(const k of Object.keys(parsed.store)){
          localStorage.setItem(k, parsed.store[k]);
        }
        alert("‚úÖ Backup ripristinato! Ora ricarico la pagina‚Ä¶");
        location.reload();
        return;
      }
      // fallback: se incolli un json domande, lo importo comunque
      const res = bulkImportQuestions(parsed);
      alert(`‚úÖ Import completato!\nDomande importate: ${res.imported}\nSaltate: ${res.skipped}`);
      try{ renderLibrary(); }catch(e){}
      closePasteJSON();
      return;
    }

    // questions
    const res = bulkImportQuestions(parsed);
    alert(`‚úÖ Import completato!\nDomande importate: ${res.imported}\nSaltate: ${res.skipped}`);
    try{ renderLibrary(); }catch(e){}
    closePasteJSON();

  }catch(e){
    console.error(e);
    alert("‚ùå JSON non valido. Controlla di aver copiato tutto il contenuto del file.");
  }
}

</script>

<script>
/* serviceWorker disattivato in file://
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js");
}
*/
</script>


<script>
/* =========================
   PRESET QUIZ (AUTO-START)
   Apri questa pagina con:
   game.html?preset=storia_miste
   game.html?preset=storia_facile
   game.html?preset=storia_medio
   game.html?preset=storia_difficile
   (puoi aggiungerne altri in PRESETS)
========================= */
(function(){
  const PRESETS = {
    storia_miste:     { cls:"3", subject:"storia", level:"ALL", numQ:10, players:1 },
    storia_facile:    { cls:"3", subject:"storia", level:"facile", numQ:10, players:1 },
    storia_medio:     { cls:"3", subject:"storia", level:"medio", numQ:10, players:1 },
    storia_difficile: { cls:"3", subject:"storia", level:"difficile", numQ:10, players:1 },

    storia4_miste:     { cls:"4", subject:"storia", level:"ALL", numQ:10, players:1 },
    storia4_facile:    { cls:"4", subject:"storia", level:"facile", numQ:10, players:1 },
    storia4_medio:     { cls:"4", subject:"storia", level:"medio", numQ:10, players:1 },
    storia4_difficile: { cls:"4", subject:"storia", level:"difficile", numQ:10, players:1 },

    // ESEMPI PRONTI (scommenta/duplica se vuoi)
    // geografia_miste:  { cls:"3", subject:"geografia", level:"ALL", numQ:10, players:1 },
    // italiano_facile: { cls:"3", subject:"italiano", level:"facile", numQ:10, players:1 },
  
    matematica_miste:     { cls:"3", subject:"matematica", level:"ALL", numQ:10, players:1 },
    matematica_facile:    { cls:"3", subject:"matematica", level:"facile", numQ:10, players:1 },
    matematica_medio:     { cls:"3", subject:"matematica", level:"medio", numQ:10, players:1 },
    matematica_difficile: { cls:"3", subject:"matematica", level:"difficile", numQ:10, players:1 },

    // ESEMPI PRONTI (scommenta/duplica se vuoi)
    // geografia_miste:  { cls:"3", subject:"geografia", level:"ALL", numQ:10, players:1 },
    // italiano_facile: { cls:"3", subject:"italiano", level:"facile", numQ:10, players:1 },
  };

  function getParam(name){
    const u = new URL(window.location.href);
    return u.searchParams.get(name);
  }

  function applyPreset(p){
    // override da querystring (home)
    const u = new URL(window.location.href);
    const qpPlayers = u.searchParams.get("players");
    const qpNumQ = u.searchParams.get("numQ");
    const p2 = Object.assign({}, p);
    if(qpPlayers) p2.players = Number(qpPlayers);
    if(qpNumQ) p2.numQ = Number(qpNumQ);

    

// üîÅ Override anche classe/disciplina/livello/topics se presenti in querystring
const qpCls = u.searchParams.get("classe") || u.searchParams.get("cls");
const qpSub = u.searchParams.get("disciplina") || u.searchParams.get("subject");
const qpLev = u.searchParams.get("livello") || u.searchParams.get("level");
const qpTopicsRaw = u.searchParams.get("topics") || u.searchParams.get("argomento");

if(qpCls) p2.cls = String(qpCls);
if(qpSub) p2.subject = String(qpSub);
if(qpLev) p2.level = String(qpLev);

if(qpTopicsRaw !== null){
  let topics = [];
  const raw = String(qpTopicsRaw||"").trim();
  if(raw){
    if(raw.includes("|")) topics = raw.split("|").map(s=>s.trim()).filter(Boolean);
    else topics = [raw.replace(/_/g," ").trim()].filter(Boolean);
  }
  p2.topics = topics;
}
// imposta selettori della home interna (senza toccare Area Docente)
    const setVal = (id, val) => {
      const el = document.getElementById(id);
      if(!el) return;
      el.value = String(val);
      // aggiorna stile placeholder se presente
      if(el.tagName === "SELECT"){
        el.classList.remove("is-placeholder");
        if(el.value === "" || el.value === null) el.classList.add("is-placeholder");
      }
    };

    setVal("selClass", p2.cls);
    setVal("selSubject", p2.subject);
    setVal("selLevel", p2.level);
    setVal("selNumQ", p2.numQ);
    setVal("selPlayers", p2.players);

    // ‚úÖ Da index (preset / parametri): gestione filtro "Argomenti"
    // - se p2.topics √® presente => usa SOLO quelli
    // - se p2.topics √® vuoto/assente => usa TUTTI (rimuove filtro salvato)
    try{
      const sig = (typeof metaSig==="function") ? metaSig(p2.cls, p2.subject, p2.level) : `${p2.cls||""}|${p2.subject||""}|${p2.level||""}`;
      if(Array.isArray(p2.topics) && p2.topics.length){
        localStorage.setItem("pref_topics_" + sig, JSON.stringify(p2.topics));
      }else{
        localStorage.removeItem("pref_topics_" + sig);
      }

      localStorage.setItem("pref_numQ_" + sig, String(p2.numQ));


      // ricostruisce la checklist argomenti (applica subito le spunte)
      if(typeof buildTopicChecklist === "function") buildTopicChecklist();
      if(typeof updateTopicHeaderInfo === "function") updateTopicHeaderInfo();
    }catch(e){} 

    // forza aggiornamento UI del selettore giocatori
    try{
      const sp = document.getElementById("selPlayers");
      if(sp) sp.dispatchEvent(new Event("change", {bubbles:true}));
    }catch(e){}


    // se esistono campi nomi giocatori, risincronizza
    if(typeof syncPlayerNameInputs === "function") syncPlayerNameInputs();
    if(typeof readPlayerNames === "function") readPlayerNames();

    // avvia
    if(typeof startGame === "function"){
      setTimeout(()=> startGame(), 0);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    // 1) preset classico: ?preset=...
    const presetKey = getParam("preset");
    if(presetKey){
      const p = PRESETS[presetKey];
      if(p){
        if(typeof show === "function") show("home");
        applyPreset(p);
      }
      return;
    }

    // 2) preset "manuale" da HOME: ?classe=3&disciplina=storia&livello=medio&topics=...
    const cls = getParam("classe") || getParam("cls") || "";
    const subject = getParam("disciplina") || getParam("subject") || "";
    const level = getParam("livello") || getParam("level") || "";
    const topicsRaw = getParam("topics") || getParam("argomento") || "";

    if(!cls && !subject && !level && !topicsRaw) return;

    // topics pu√≤ essere: "La linea del tempo|Lo storico|Le fonti storiche"
    // oppure (compatibilit√†) argomento=preistoria_fonti -> "preistoria fonti"
    let topics = [];
    if(topicsRaw){
      if(topicsRaw.includes("|")) topics = topicsRaw.split("|").map(s=>s.trim()).filter(Boolean);
      else topics = [topicsRaw.replace(/_/g, " ").trim()].filter(Boolean);
    }

    const p = {
      cls: cls || "3",
      subject: subject || "storia",
      level: level || "ALL",
      numQ: 10,
      players: 1,
      topics
    };

    if(typeof show === "function") show("home");
    applyPreset(p);
  });
})();
</script>

<script>
  function goIndex(){
    // sicurezza: pulisce eventuale screen
    window.location.href = "index.html";
  }


  function goIndex(){
  sessionStorage.removeItem("access_ok"); // opzionale
  window.location.href = "index.html";
}

</script>


<!-- Modal: Livello completato -->
<div id="levelDoneBackdrop" aria-hidden="true">
  <div id="levelDoneCard" role="dialog" aria-modal="true" aria-labelledby="levelDoneTitle">
    <div id="levelDoneTitle">üéâ Livello completato!</div>
    <div id="levelDoneSubtitle">Bravissimi! Ora potete vedere la classifica finale.</div>
    <div id="levelDonePills">
      <div class="levelPill">üë• Giocatori: <span id="levelDonePlayers">1</span></div>
      <div class="levelPill">‚ùì Domande: <span id="levelDoneQuestions">10</span></div>
    </div>
    <div id="levelDoneActions">
      <button class="levelBtn" id="btnLevelOk">Continua</button>
      <button class="levelBtn" id="btnLevelScore">Mostra punteggio</button>
    </div>
  </div>
</div>

<script>
function exportSelectedQuestionsPDF(){
  // ‚úÖ Prende le selezioni anche se hai cambiato ricerca (persistono in localStorage)
  let selectedIds = [];
  try{ selectedIds = [...getLibSelectedSet()].map(String); }catch(e){ selectedIds = []; }

  // Fallback: se per qualche motivo non ci sono in memoria, usa quelle visibili spuntate
  if(!selectedIds.length){
    selectedIds = Array.from(document.querySelectorAll('.libChk:checked'))
      .map(cb => String(cb.getAttribute("data-id")||""))
      .filter(Boolean);
  }

  if(!selectedIds.length){
    alert("Seleziona almeno una domanda da esportare.");
    return;
  }

  const all = loadAll(); // archivio completo
  const selected = all.filter(q => selectedIds.includes(String(q.id)));

  if(!selected.length){
    alert("Errore: non trovo i dati delle domande selezionate.");
    return;
  }

  // 2) Scelta con / senza opzioni
  const includeOptions = confirm(
    "Vuoi includere anche le opzioni di risposta?\n\nOK = Con opzioni (e soluzioni in seconda pagina)\nAnnulla = Solo domande (senza opzioni)"
  );

  // 3) Crea PDF (serve che jsPDF sia gi√† incluso nel file)
  if(typeof window.jspdf === "undefined" && typeof window.jsPDF === "undefined"){
    alert("jsPDF non trovato. Se sei in locale (file://), scarica jsPDF e includilo nel file.");
    return;
  }

  const JsPDF = (window.jspdf && window.jspdf.jsPDF) ? window.jspdf.jsPDF : window.jsPDF;
  const doc = new JsPDF({ unit:"mm", format:"a4" });

  const pageH = doc.internal.pageSize.getHeight();
  const margin = 12;
  let y = margin;

  const lineH = 7;
  const safeText = (s)=> (s==null? "" : String(s)).replace(/\s+/g," ").trim();

  // Supporta opzioni come: string, oppure oggetti con testo/immagine (solo testo, solo immagine o entrambi)
  function optToText(opt){
    if(opt == null) return "";
    const tSafe = (v)=> (v==null? "" : String(v)).replace(/\s+/g," ").trim();
    if(typeof opt === "string" || typeof opt === "number" || typeof opt === "boolean"){
      return tSafe(opt);
    }
    if(typeof opt === "object"){
      const t = tSafe(opt.text ?? opt.testo ?? opt.label ?? opt.titolo ?? "");
      const src = tSafe(opt.img ?? opt.image ?? opt.src ?? (opt.media && opt.media.src) ?? (opt.media && opt.media.url) ?? "");
      const file = src ? src.split("/").pop() : "";
      if(t && src) return `${t}  [IMG: ${file}]`;
      if(t) return t;
      if(src) return `[IMG: ${file}]`;
      try{ return tSafe(JSON.stringify(opt)); }catch(e){ return ""; }
    }
    return tSafe(opt);
  }

  // Header compilabile
  doc.setFont("helvetica","bold");
  doc.setFontSize(14);
  doc.text("Scheda di lavoro", margin, y);
  y += 10;

  doc.setFont("helvetica","normal");
  doc.setFontSize(12);
  doc.text("Nome e Cognome: ________________________________", margin, y);
  y += 8;
  doc.text("Classe: ____________        Data: ____________", margin, y);
  y += 10;

  function newPage(){
    doc.addPage();
    y = margin;
  }
  function writeWrapped(text, x, maxW){
    const lines = doc.splitTextToSize(text, maxW);
    for(const line of lines){
      if(y + lineH > pageH - margin) newPage();
      doc.text(line, x, y);
      y += lineH;
    }
  }

  // 4) Stampa domande
  const solutions = []; // {n, letter}
  const maxW = doc.internal.pageSize.getWidth() - margin*2;

  selected.forEach((q, i)=>{
    const n = i + 1;

    const domanda = safeText(q.question ?? q.domanda ?? "");
    const opzioni = Array.isArray(q.options) ? q.options : (Array.isArray(q.opzioni) ? q.opzioni : []);
    const corretta = (typeof q.correct === "number") ? q.correct : (typeof q.corretta === "number" ? q.corretta : -1);

    if(y + 10 > pageH - margin) newPage();

    doc.setFont("helvetica","bold");
    doc.text(`${n}.`, margin, y);
    doc.setFont("helvetica","normal");
    writeWrapped(domanda, margin + 6, maxW - 6);
    y += 2;

    if(includeOptions && opzioni.length){
      opzioni.forEach((opt, idx)=>{
        const label = String.fromCharCode(65 + idx); // A B C D
        writeWrapped(`${label}) ${optToText(opt)}`, margin + 8, maxW - 8);
        if(idx === corretta) solutions.push({ n, letter: label });
      });
      y += 2;
    }else{
      if(corretta >= 0) solutions.push({ n, letter: String.fromCharCode(65 + corretta) });
    }
  });

  // 5) Soluzioni in seconda pagina (solo se ha senso)
  if(includeOptions){
    doc.addPage();
    y = margin;
    doc.setFont("helvetica","bold");
    doc.setFontSize(14);
    doc.text("Soluzioni", margin, y);
    y += 10;

    doc.setFont("helvetica","normal");
    doc.setFontSize(12);

    const cols = 3;
    const colW = (doc.internal.pageSize.getWidth() - margin*2) / cols;
    const rowsPerCol = Math.ceil(solutions.length / cols) || 1;

    solutions.forEach((s, i)=>{
      const col = Math.floor(i / rowsPerCol);
      const row = i % rowsPerCol;
      const x = margin + col * colW;
      const yy = margin + 12 + row * lineH;
      doc.text(`${s.n}) ${s.letter || "-"}`, x, yy);
    });
  }

  // 6) Download robusto
  const blob = doc.output("blob");

  // Edge/IE legacy
  if (window.navigator && typeof window.navigator.msSaveOrOpenBlob === "function") {
    window.navigator.msSaveOrOpenBlob(blob, "domande_selezionate.pdf");
    return;
  }

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "domande_selezionate.pdf";
  a.rel = "noopener";
  a.style.display = "none";
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}


// ‚úÖ Selezione persistente nell'Archivio (anche quando cerchi/filtri)
const LIB_SELECTED_KEY = "lib_selected_ids_v1";

function getLibSelectedSet(){
  try {
    const arr = JSON.parse(localStorage.getItem(LIB_SELECTED_KEY) || "[]");
    return new Set(arr);
  } catch(e){
    return new Set();
  }
}
function saveLibSelectedSet(set){
  localStorage.setItem(LIB_SELECTED_KEY, JSON.stringify([...set]));
}

// Chiamala DOPO ogni render della tabella archivio
function applyLibrarySelectionsToVisibleRows(){
  const set = getLibSelectedSet();
  document.querySelectorAll('.libChk[data-id]').forEach(cb=>{
    const id = cb.getAttribute("data-id");
    cb.checked = set.has(id);
  });
  updateSelectedCountUI();
}

// Aggancia l'evento una volta sola (delegation)
function bindLibrarySelectionDelegation(){
  if(window.__libSelBound) return;
  window.__libSelBound = true;

  document.addEventListener("change", (e)=>{
    const cb = e.target;
    if(!cb || !cb.classList || !cb.classList.contains("libChk")) return;

    const id = cb.getAttribute("data-id");
    if(!id) return;

    const set = getLibSelectedSet();
    if(cb.checked) set.add(id);
    else set.delete(id);
    saveLibSelectedSet(set);
    updateSelectedCountUI();
  });
}

// Piccola UI: mostra quante selezionate (se vuoi)
function updateSelectedCountUI(){
  const el = document.getElementById("libSelectedCount");
  if(!el) return;
  const set = getLibSelectedSet();
  el.textContent = `Selezionate: ${set.size}`;
}

// Utility: pulisci selezione
function clearLibrarySelection(){
  localStorage.removeItem(LIB_SELECTED_KEY);
  applyLibrarySelectionsToVisibleRows();
}


// ‚ùå Cancella ricerca Archivio Domande
function clearArchiveSearch(){
  const i = document.getElementById("fSearch");
  if(!i) return;
  i.value = "";
  // trigger oninput filters + refresh
  i.dispatchEvent(new Event("input", { bubbles:true }));
  try{ i.focus(); }catch(e){}
}


// ===== Argomenti selezionati: chips visibili (con X) =====

function renderTopicChips(){
  const row = document.getElementById("topicChipsRow");
  if(!row) return;

  let topics = [];
  try{
    const cls = document.getElementById("selClass")?.value || "";
    const sub = document.getElementById("selSubject")?.value || "";
    const lev = document.getElementById("selLevel")?.value || "";
    topics = (loadTopicPrefs(cls, sub, lev).topics || []);
  }catch(e){ topics = []; }

  if(!topics || topics.length === 0){
    row.innerHTML = `<span class="topicChipsLabel">Argomenti:</span>
      <span class="topicChip"><span class="t">Tutti</span></span>`;
    return;
  }

  row.innerHTML = `
    <span class="topicChipsLabel">Argomenti:</span>
    ${topics.map(t => `
      <span class="topicChip">
        <span class="t">${escapeHtml(String(t))}</span>
        <button class="x" type="button" data-topic="${escapeAttr(String(t))}"
          title="Rimuovi" onclick="removeSelectedTopic(this.dataset.topic)">√ó</button>
      </span>
    `).join("")}
  `;
}



function removeSelectedTopic(topic){
  const wrap = document.getElementById("topicChecklist");
  if(!wrap) return;

  const wanted = String(topic);

  // Cerca in modo robusto (anche con caratteri strani)
  const boxes = wrap.querySelectorAll('input[type="checkbox"][data-topic]');
  let found = null;
  boxes.forEach(cb=>{
    if(found) return;
    if(String(cb.getAttribute("data-topic")) === wanted) found = cb;
  });

  if(found){
    found.checked = false;
    found.dispatchEvent(new Event("change", {bubbles:true}));
    // aggiorna chips subito
    try{ renderTopicChips(); }catch(e){}
  }else{
    // fallback
    try{ updateTopicSummary(); }catch(e){}
    try{ renderPickQuestions(); }catch(e){}
    try{ renderTopicChips(); }catch(e){}
  }
}


// hook: render on load + every topic change
document.addEventListener("DOMContentLoaded", ()=>{
  try{ renderTopicChips(); }catch(e){}
  const wrap = document.getElementById("topicChecklist");
  if(wrap){
    wrap.addEventListener("change", (e)=>{
      const t = e.target;
      if(t && t.matches && t.matches('input[type="checkbox"][data-topic]')){
        try{ renderTopicChips(); }catch(e){}
      }
    });
  }
});


// FORCE_PLACEHOLDERS_V1
// FORCE_PLACEHOLDERS_V1 (fix: non interferire con i preset)
document.addEventListener("DOMContentLoaded", ()=>{
  const u = new URL(window.location.href);
  const hasPreset = !!u.searchParams.get("preset");

  // Se arrivo da index con un preset, NON devo svuotare i select
  if(hasPreset){
    // al massimo riallineo la classe placeholder
    ["selClass","selSubject","selLevel"].forEach(id=>{
      const el = document.getElementById(id);
      if(el){
        el.classList.toggle("is-placeholder", !el.value);
      }
    });
    return;
  }

  // Solo se NON c‚Äô√® preset: comportamento originale
  ["selClass","selSubject","selLevel"].forEach(id=>{
    const el = document.getElementById(id);
    if(el){
      el.value = "";
      el.classList.add("is-placeholder");
    }
  });

  try{ buildTopicChecklist(); }catch(e){}
  try{ updateTopicSummary(); }catch(e){}
  try{ renderPickQuestions(); }catch(e){}
});


function clearPickedQuestions(){
  // 1) svuota set in memoria
  __pickSelected = new Set();

  // 2) svuota anche in localStorage (cos√¨ non resta "appiccicato")
  try{ localStorage.removeItem(PICK_SELECTED_KEY); }catch(e){}
  try{ savePickSelectedSet(__pickSelected); }catch(e){}

  // 3) aggiorna contatore
  try{ updatePickSelectedUI(); }catch(e){}

  // 4) togli le spunte visibili (se la tabella √® gi√† renderizzata)
  document.querySelectorAll('.pickChk:checked').forEach(cb => cb.checked = false);

  // 5) re-render della lista (cos√¨ si riallinea tutto)
  try{ renderPickQuestions(); }catch(e){}
}


</script>




<script>
/* ================================
   FIX NAV MENU ACTIVE (override)
   - evidenzia correttamente il pulsante del menu
   - gestisce mappature (in gioco resta evidenziata la Home)
   ================================ */
(function(){
  function _mapScreen(id){
    // Durante il gioco lasciamo evidenziato "Scegli Domande" (home)
    if(id === "game") return "home";
    return id;
  }

  window.setActiveNav = function(screenId){
    const key = _mapScreen(screenId);
    const btns = document.querySelectorAll(".topnav .navbtn[data-screen]");
    btns.forEach(b=>b.classList.remove("active"));
    const btn = document.querySelector('.topnav .navbtn[data-screen="'+key+'"]');
    if(btn) btn.classList.add("active");
  };

  window.show = function(id){
    const target = document.getElementById(id);
    if(!target) return;

    document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
    target.classList.add("active");

    // ‚úÖ scroll sempre permesso (serve per opzioni con immagini)
    document.body.classList.remove("noScroll");

    // home refresh (come avevi gi√†)
    if(id === "home"){
      try{ if(typeof syncPlayerNameInputs==="function") syncPlayerNameInputs(); }catch(e){}
      try{ if(typeof readPlayerNames==="function") readPlayerNames(); }catch(e){}
      setTimeout(()=>{
        try{ if(typeof syncQuestionsFromFile==="function") syncQuestionsFromFile(); }catch(e){}
        try{ if(typeof buildTopicChecklist==="function") buildTopicChecklist(); }catch(e){}
        try{ if(typeof updateTopicSummary==="function") updateTopicSummary(); }catch(e){}
        try{ if(typeof renderPickQuestions==="function") renderPickQuestions(); }catch(e){}
      }, 50);
    }

    try{ window.setActiveNav(id); }catch(e){}
  };

  // wrappers menu (cos√¨ anche dopo password/requireAccess si aggiorna sicuro)
  if(typeof window.requireAccess === "function"){
    window.openLibrary = function(){
      requireAccess(()=>{
        show("library");
        try{ if(typeof renderLibrary==="function") renderLibrary(); }catch(e){}
        try{ setActiveNav("library"); }catch(e){}
      });
    };
    window.openTeacher = function(){
      requireAccess(()=>{
        show("teacher");
        try{ setActiveNav("teacher"); }catch(e){}
        window.scrollTo({top:0, behavior:"smooth"});
      });
    };
  }

  // all'avvio: se siamo entrati con ?screen=teacher|library accendi subito
  try{
    const scr = (new URLSearchParams(location.search).get("screen")||"").toLowerCase();
    if(scr === "teacher") setActiveNav("teacher");
    else if(scr === "library") setActiveNav("library");
    else setActiveNav(document.querySelector(".screen.active")?.id || "home");
  }catch(e){}
})();
</script>


<style>
/* === Scroll verticale per liste lunghe (Archivio Domande + Scegli Domande) === */
/* Limita l'altezza del contenuto delle tabelle e abilita scroll interno */
#libWrap .accBody,
#pickWrap .accBody{
  max-height: calc(100vh - 320px);
  overflow-y: auto;
  overflow-x: hidden;
  border: 1px solid rgba(0,0,0,.06);
  border-radius: 14px;
  padding: 8px;
  background: rgba(255,255,255,.55);
}

/* evita che la tabella allarghi/rompa il contenitore */
#libWrap .accBody table,
#pickWrap .accBody table{
  width: 100%;
}

/* barra pi√π ‚Äúpulita‚Äù (Chrome/Edge) */
#libWrap .accBody::-webkit-scrollbar,
#pickWrap .accBody::-webkit-scrollbar{
  width: 10px;
}
#libWrap .accBody::-webkit-scrollbar-thumb,
#pickWrap .accBody::-webkit-scrollbar-thumb{
  background: rgba(0,0,0,.18);
  border-radius: 999px;
  border: 2px solid rgba(255,255,255,.6);
}
#libWrap .accBody::-webkit-scrollbar-track,
#pickWrap .accBody::-webkit-scrollbar-track{
  background: rgba(0,0,0,.04);
  border-radius: 999px;
}
</style>

<script id="fix-archive-header-align-only-js">
(function(){
  function updateArchiveHeaderAlign(){
    try{
      const wrap = document.getElementById("libWrap");
      if(!wrap) return;

      // Quando scegli un livello, in Archivio pu√≤ comparire una tabella "level-only" oppure una "levelTable"
      const tables = Array.from(wrap.querySelectorAll("table.level-only, table.levelTable"));
      if(!tables.length) return;

      tables.forEach(table=>{
        const tb = table.querySelector("tbody");
        if(!tb) return;

        // scrollbar width = offsetWidth - clientWidth (0 se non c'√® scrollbar)
        const sbw = Math.max(0, (tb.offsetWidth || 0) - (tb.clientWidth || 0));
        table.style.setProperty("--sbw", sbw + "px");
      });
    }catch(e){}
  }

  window.addEventListener("load", updateArchiveHeaderAlign);
  window.addEventListener("resize", updateArchiveHeaderAlign);

  // Hook "soft": wrappa renderLibrary senza cambiare altro
  function tryWrapRenderLibrary(){
    if(typeof window.renderLibrary !== "function") return false;
    if(window.renderLibrary.__qm_wrapped) return true;

    const _old = window.renderLibrary;
    function wrapped(){
      const res = _old.apply(this, arguments);
      setTimeout(updateArchiveHeaderAlign, 0);
      return res;
    }
    wrapped.__qm_wrapped = true;
    window.renderLibrary = wrapped;
    return true;
  }

  if(!tryWrapRenderLibrary()){
    let tries = 0;
    const iv = setInterval(()=>{
      tries++;
      if(tryWrapRenderLibrary() || tries>40) clearInterval(iv);
    }, 100);
  }
})();
</script>
<style>
/* ARCHIVIO DOMANDE ‚Äì livello: mantieni scroll + header allineato */
#libWrap table.level-only thead{
  display: table;
  width: calc(100% - 12px); /* spazio scrollbar */
}

#libWrap table.level-only tbody{
  display: block;
  max-height: calc(100vh - 320px);
  overflow-y: auto;
}


/* === SCEGLI DOMANDE: SCROLL quando selezioni un LIVELLO (tabella diretta dentro #pickWrap) === */
/* Non tocca l'accordion (.accBody). Agisce solo sulla vista "livello singolo". */
#pickWrap > table.levelTable{
  display: table !important;
  width: 100%;
  table-layout: fixed;
}
#pickWrap > table.levelTable thead{
  display: table;
  width: 100%;
  table-layout: fixed;
}
#pickWrap > table.levelTable tbody{
  display: block;
  max-height: calc(100vh - 320px);
  overflow-y: auto;
  overflow-x: hidden;
}
#pickWrap > table.levelTable tbody tr{
  display: table;
  width: 100%;
  table-layout: fixed;
}

/* scrollbar (Chrome/Edge) */
#pickWrap > table.levelTable tbody::-webkit-scrollbar{ width: 10px; }
#pickWrap > table.levelTable tbody::-webkit-scrollbar-thumb{
  background: rgba(0,0,0,.18);
  border-radius: 999px;
  border: 2px solid rgba(255,255,255,.6);
}
#pickWrap > table.levelTable tbody::-webkit-scrollbar-track{
  background: rgba(0,0,0,.04);
  border-radius: 999px;
}

/* === SCEGLI DOMANDE (vista LIVELLO): stringi # e ‚úì, allarga Domanda === */
#pickWrap > table.levelTable th:nth-child(1),
#pickWrap > table.levelTable td:nth-child(1){
  width: 42px;            /* colonna # */
}

#pickWrap > table.levelTable th:nth-child(2),
#pickWrap > table.levelTable td:nth-child(2){
  width: 44px;            /* colonna ‚úì (checkbox) */
}

/* opzionale ma utile: Argomento un po' pi√π stretto */
#pickWrap > table.levelTable th:nth-child(3),
#pickWrap > table.levelTable td:nth-child(3){
  width: 120px;           /* Argomento */
}

/* FIX MINIMO: rimpicciolisce SOLO l‚Äôanteprima IMMAGINE in SCEGLI DOMANDE */
#pickWrap .mediaThumb{
  width: 130px !important;
  height: 100px !important;
  object-fit: cover;
}
</style>

<script id="qm-exit-modal">
/* =====================================================
   Modale "VUOI USCIRE DAL GIOCO?" stile popup password
   - Intercetta click menu in GAME
   - Se "S√¨": esegue l'onclick originale del bottone
   ===================================================== */
(function(){
  function activeScreenId(){
    return document.querySelector(".screen.active")?.id || "";
  }
  function inGame(){
    return activeScreenId() === "game";
  }

  function showExitModal(onYes, onNo){
    if(document.getElementById("qmExitOverlay")) return;
    const overlay = document.createElement("div");
    overlay.id = "qmExitOverlay";

    const card = document.createElement("div");
    card.id = "qmExitCard";
    card.innerHTML = `
      <div id="qmExitTitle">üö™ Vuoi uscire dal gioco?</div>
      <div id="qmExitText">Se esci adesso, la partita in corso verr√† interrotta.</div>
      <div id="qmExitActions">
        <button type="button" class="qmExitBtn qmExitNo" id="qmExitNo">No</button>
        <button type="button" class="qmExitBtn qmExitYes" id="qmExitYes">S√¨</button>
      </div>
    `;

    overlay.appendChild(card);
    document.body.appendChild(overlay);

    function close(){
      overlay.remove();
    }

    const btnNo = card.querySelector("#qmExitNo");
    const btnYes = card.querySelector("#qmExitYes");

    btnNo.addEventListener("click", ()=>{
      close();
      onNo && onNo();
    });
    btnYes.addEventListener("click", ()=>{
      close();
      onYes && onYes();
    });

    overlay.addEventListener("click", (e)=>{ if(e.target === overlay){ close(); onNo && onNo(); } });
    document.addEventListener("keydown", function esc(e){
      if(e.key === "Escape"){
        document.removeEventListener("keydown", esc);
        close();
        onNo && onNo();
      }
    });

    // focus
    setTimeout(()=>{ try{ btnNo.focus(); }catch(e){} }, 0);
  }

  // Bypass flag per evitare loop quando eseguiamo noi l'azione
  function bypassOn(){
    window.__qmExitBypass = true;
    setTimeout(()=>{ window.__qmExitBypass = false; }, 0);
  }
  function bypassed(){
    return !!window.__qmExitBypass;
  }

 function execOriginalAction(btn){
  // ‚úÖ CASO SPECIALE: "GIOCHI DIDATTICI" (√® un bottone dropdown senza href/onclick)
  if(btn && btn.dataset && btn.dataset.act === "didattici"){
    if(typeof window.goDidattici === "function"){
      window.goDidattici();
      return;
    }
    window.location.href = "giochi_didattici.html";
    return;
  }

  // 1) se ha onclick inline -> eseguilo
  const oc = btn.getAttribute("onclick");
  if(oc && oc.trim()){
    try{
      (new Function(oc))();
      return;
    }catch(e){}
  }

  // 2) se √® <a href=...>
  const href = btn.getAttribute("href");
  if(href){
    window.location.href = href;
    return;
  }

  // 2bis) se ha data-href (dropdown items)
  const dh = btn.dataset && btn.dataset.href;
  if(dh){
    window.location.href = dh;
    return;
  }

  // 3) fallback estremo
  btn.click();
}


  function onNavCapture(e){
    if(!inGame()) return;
    if(bypassed()) return;

    const btn = e.target.closest && e.target.closest(".topnav .navbtn");
    if(!btn) return;

    // Intercetta SEMPRE in game
    e.preventDefault();
    e.stopPropagation();
    if(typeof e.stopImmediatePropagation === "function") e.stopImmediatePropagation();

    showExitModal(
      ()=>{ bypassOn(); execOriginalAction(btn); },
      ()=>{ /* NO -> nulla */ }
    );
    return false;
  }

  function bind(){
    const nav = document.querySelector(".topnav");
    if(!nav || nav.__qmExitModalBound) return;
    nav.addEventListener("click", onNavCapture, true); // capture!
    nav.__qmExitModalBound = true;
  }

  bind();
  window.addEventListener("load", bind);
})();
</script>

<script>
function deleteSelectedLibrary(){
  const checks = Array.from(
    document.querySelectorAll('#libWrap .libChk:checked')
  );

  if(checks.length === 0){
    alert("Seleziona almeno una domanda da eliminare.");
    return;
  }

  if(!confirm("Vuoi eliminare definitivamente le domande selezionate?")){
    return;
  }

  const idsToDelete = checks.map(c => c.dataset.id);

  const all = loadAll();
  const filtered = all.filter(q => !idsToDelete.includes(q.id));

  saveAll(filtered);
  renderLibrary();
}
</script>


<script src="js/fit_screen.js" defer></script>

<script id="zoomPatchJS">
  (function(){
    const levels = [0.45,0.55,0.65,0.75, 0.85, 0.95, 1.0, 1.05, 1.15, 1.25,1.35];
  
    let idx = 3; // 1.0 default

    function apply(){
      const target = document.getElementById("zoomTarget");
      const label  = document.getElementById("zoomLabel");
      if(!target) return;
      const z = levels[idx];
      target.style.transform = `scale(${z})`;
      // un po' di spazio sotto quando riduci/ingrandisci, per evitare tagli visivi
      target.style.marginBottom = (z < 1 ? "0px" : "40px");
      if(label) label.textContent = `Zoom: ${Math.round(z*100)}%`;
      try{ localStorage.setItem("quiz_zoom_idx", String(idx)); }catch(e){}
    }

    window.zoomStep = function(dir){
      idx = Math.max(0, Math.min(levels.length-1, idx + dir));
      apply();
    };
    window.zoomReset = function(){
      idx = 3;
      apply();
    };

    function load(){
      try{
        const saved = localStorage.getItem("quiz_zoom_idx");
        if(saved !== null){
          const n = parseInt(saved, 10);
          if(!Number.isNaN(n)) idx = Math.max(0, Math.min(levels.length-1, n));
        }
      }catch(e){}
      apply();
    }

    window.addEventListener("load", load);
    window.addEventListener("resize", apply);
  })();
</script>


<script>
/* Sposta le card dei giocatori tutte nel contenitore sinistro (colonna unica).
   Non cambia la logica del gioco: cambia solo il posizionamento DOM. */
(function(){
  function movePlayersLeft(){
    const left = document.getElementById("leftCol");
    const right = document.getElementById("rightCol");
    if(!left) return;
    ["cardP2","cardP4"].forEach(id=>{
      const el = document.getElementById(id);
      if(el && el.parentElement !== left) left.appendChild(el);
    });
    // se rimane vuoto, lo lasciamo nascosto via CSS
    if(right) right.innerHTML = "";
  }
  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", movePlayersLeft);
  }else{
    movePlayersLeft();
  }
})();
</script>
<script src="js/nav.js"></script>
<script src="js/menu.js"></script>

</body>
</html>